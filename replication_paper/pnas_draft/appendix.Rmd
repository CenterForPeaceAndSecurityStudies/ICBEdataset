---
title: "Introducing ICBe: Very High Recall and Precision Event Extraction from Narratives about International Crises"

#https://bookdown.org/yihui/bookdown/a-single-document.html
#https://stackoverflow.com/questions/52531637/knitr-rmarkdown-latex-how-to-cross-reference-figures-and-tables-in-2-different/52532269#52532269
#https://stackoverflow.com/questions/51595939/bookdown-cross-reference-figure-in-another-file
#https://stackoverflow.com/questions/25824795/how-to-combine-two-rmarkdown-rmd-files-into-a-single-output/51521542#51521542
output: 
  pdf_document:
    toc: yes
    latex_engine: xelatex
    keep_tex:  true

bibliography: ICBintro.bib

#Disabled several the caused errors
header-includes:
# - \usepackage{xr} \externaldocument{appendix} #External references from the appendix
# - \usepackage{tinytex}
  - \usepackage[backend=bibtex]{biblatex} #if I comment it out and don't have it'll throw an error
#  - \usepackage{natbib} #added for latex citation within huxtable
  - \usepackage[utf8]{inputenc}
  - \usepackage{pifont}
  - \usepackage{newunicodechar}
  - \newunicodechar{✓}{\ding{51}}
  - \newunicodechar{✗}{\ding{55}}
  - \usepackage{array}
  - \usepackage{ctable} # added for demo

  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{titlesec}
#  - \usepackage[parfill]{parskip}
  - \usepackage{makecell}
  - \usepackage{graphicx}
  - \usepackage{caption}
#  - \usepackage[capposition=top]{floatrow}
  - \titleformat{\subsubsection}{\normalfont\normalsize\itshape}{\thesubsubsection}{1em}{}
  - \titlespacing*{\subsubsection}{0pt}{3.25ex plus 1ex minus .2ex}{0ex plus .2ex}
#  - \DeclareUnicodeCharacter{00A0}{ }
  - \usepackage{setspace}
  - \usepackage{cellspace}
  - \setlength\cellspacetoplimit{0.8ex}
  - \renewcommand{\arraystretch}{0.8}
  - \AtBeginEnvironment{tabular}{\singlespacing}
  - \AtBeginEnvironment{lltable}{\singlespacing}
#  - \usepackage[ruled,vlined,linesnumbered]{algorithm2e}
  - \usepackage{subcaption}
  - \usepackage{atbegshi}% http://ctan.org/pkg/atbegshi
  - \usepackage{float}
#  - \usepackage{eso-pic,graphicx,transparent}
#  - \usepackage[perpage]{footmisc}
  - \usepackage{algorithm}
  - \usepackage[algo2e]{algorithm2e}
  - \usepackage{amsmath}
  - \usepackage{afterpage}
  - \usepackage{placeins}
  - \usepackage{rotating, float, caption}
#https://tex.stackexchange.com/questions/131646/algorithm2e-command-algorithm-already-defined

---

```{r library loads, eval=T, echo=F, cache=F, results='hide', message=F}

options(tinytex.clean=F)

library(reticulate)
reticulate::py_discover_config()
#use_python("/home/skynet3/anaconda3/bin/python/")
#reticulate::use_python("/home/tlscherer/anaconda3/bin/python")

flag_folder_small = here::here("replication_data", "in", "flags_small/")

knitr::opts_chunk$set(echo = F, echo=F, cache=F, results='hide', message=F, warning=F) #Global options

#library(pacman)
library(googlesheets4)
library(tidyverse)
library(janitor)
library(flextable)
library(ggplot2)
library(cowplot)
library(ggtext)
#set_flextable_defaults(fonts_ignore=TRUE) #Warning: fonts used in `flextable` are ignored because the `pdflatex` engine is used and not `xelatex` or `lualatex`. You can avoid this warning by using the `set_flextable_defaults(fonts_ignore=TRUE)` command or use a compatible engine by defining `latex_engine: xelatex` in the YAML header of the R Markdown document.
library(ftExtra)
options(tidyverse.quiet = TRUE)
options(gargle_oauth_email = TRUE)

#install.packages('stargazer')
#install.packages('kableExtra')
#! sh: 1: pdflatex: not found
#sudo apt-get install texlive-latex-recommended texlive-fonts-recommended

#! LaTeX Error: File `letltxmacro.sty' not found.
#sudo apt-get install texlive-latex-extra

library(pacman)
library(igraph)
library(tidyverse)
library(flextable)
library(ftExtra)

#pip install -U pip setuptools wheel
#pip install -U spacy
#python -m spacy download en_core_web_sm
library(rvest)

```



```{r data loads, eval=T, echo=F, cache=F, results='hide', message=F}

icb_long_clean <- readRDS(file=paste0(here::here(), "/replication_data/out/ICBe_V1.1_long_clean.Rds"))
codings_long_agreement <- readRDS( paste0(here::here(), "/replication_data/out/ICBe_V1.1_long_agreement.Rds") )

ICBe_events_agreed <- readRDS( paste0(here::here(), "/replication_data/out/ICBe_V1.1_events_agreed.Rds")) 
dim(ICBe_events_agreed)

icb_events_long <- readRDS( paste0(here::here(), "/replication_data/out/ICBe_V1.1_events_agreed_long.Rds")) 
dim(icb_events_long)

ICBe_crises_markdown <- readRDS( paste0(here::here(), "/replication_data/out/ICBe_V1.1_crises_markdown.Rds")) 

ICBe_events_agreed_markdown <- readRDS( paste0(here::here(), "/replication_data/out/ICBe_V1.1_events_agreed_markdown.Rds")) 

#oh is it because break is reserved in R? lol
#icb_crises <- read_csv(file=paste0(here::here(), "/data_other_datasets/icb/icb1v14.csv")) %>% janitor::clean_names()
icb_crises  <- read.csv(paste0(here::here(), "/replication_data/in/icb1v14.csv")) %>% janitor::clean_names()
icb_crises$start_simple <- icb_crises$yrtrig+(icb_crises$motrig/12)
icb_crises$end_simple <- icb_crises$yrterm+(icb_crises$moterm/12)

#somehow break of all things is a b roken name
#icb_actors <- read_csv(file=paste0(here::here(), "/data_other_datasets/icb/icb2v14.csv"))
icb_actors <- read.csv(paste0(here::here(), "/replication_data/in/icb2v14.csv"))

```
\clearpage
# Appendix A Corpus and Cases
\hphantom{em}
## Table A1: ICBe Crises and Summary Information {#app:crises}
\hphantom{em}

```{r ICBe Crisis Summaries, eval=T, echo=F, results='hide', include=T, message=F, cache=F, warning=F}

#The answer is I have to include it as an image, none of the table options were compiling correctly without error
#,  ft.arraystretch=0.75 

temp_all <-  ICBe_crises_markdown %>% ungroup() %>% dplyr::select(
                    crisno, crisis_text,  yrtrig , yrterm,  n_sentence_number_int_aligned, n_events, 
                    coders_expert , 
                    coders_novice ,
                    actors , 
                    units_domains, 
                    forces_fatalities
                    ) %>%
              mutate_all(as.character) %>%
              mutate(crisis_text = crisis_text %>% stringr::str_to_title() %>% str_replace("Ii$","II"))


convert_to_ft <- function(x){
     x %>% flextable::as_flextable() %>%
      flextable::set_header_labels(values =
          list(crisno = "#",
                crisis_text = "Title",
                yrtrig = "Start",
                yrterm = "End",
                n_sentence_number_int_aligned = "Sent.",
                n_events = "Events",
                coders_expert = "Exp.",
                coders_novice = "Nov.",
                actors = "Actors",
                units_domains = "Units/Domains",
                forces_fatalities = "Forces/Fatalities"
                #value_markdown = "Abstract"
               ) ) %>%
      flextable::add_header(values =
          list(crisno = "Crisis",
                crisis_text = "Crisis",
                yrtrig = "Years",
                yrterm = "Years",
                n_sentence_number_int_aligned = "Counts",
                n_events = "Counts",
                coders_expert = "Coders",
                coders_novice = "Coders"#,
                #value_markdown = "Abstract"
               ) ) %>%
      flextable::merge_h(part = "header" ) %>%
      flextable::width( j = 1, width=0.3)  %>%
      flextable::width( j = 2, width=2.75)  %>%
      flextable::width( j = 3, width=0.6)  %>%
      flextable::width( j = 4, width=0.6)  %>%
      flextable::width( j = 5, width=0.25)  %>%
      flextable::width( j = 6, width=0.25)  %>%
      flextable::width( j = 7, width=0.25)  %>%
      flextable::width( j = 8, width=0.35)  %>%
      flextable::width( j = 9, width=2.5)  %>%
      flextable::width( j = 10, width=1.5)  %>%
      flextable::width( j = 11, width=1.0)  %>%
      flextable::fontsize(size = 9, part = "all") %>%
      flextable::padding(padding = 0.1, part = "all") %>%
      flextable::line_spacing(space = 1, part = "body") %>%
      flextable::bg( i = which( 1:nrow(x) %% 2 == 1)  , part = "body", bg = "#EFEFEF") %>%
      ftExtra::colformat_md(j = 9:11, part="body")
}

temp_all %>% ungroup() %>% filter(crisno %in% c(1:60) )  %>% convert_to_ft() %>%
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft1.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(61:120) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft2.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(121:180) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft3.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(181:240) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft4.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(241:300) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft5.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(301:360) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft6.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(361:420) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft7.png"), zoom=1)

temp_all %>% ungroup() %>% filter(crisno %in% c(421:500) ) %>% convert_to_ft()  %>% 
  save_as_image(path=here::here("replication_paper", "pnas_draft", "crisis_text_counts_ft8.png"), zoom=1)


```


\begin{figure}[H]
\caption{ICBe Crises Summary Statistics \label{fig:case_study_cuban_precision}}
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft1.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft2.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft3.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft4.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft5.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft6.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft7.png"}}
\end{figure}

\begin{figure}[H]
\centering{\includegraphics[ height=21cm]{"./crisis_text_counts_ft8.png"}}
\end{figure}





## Table A2: Verb Meanings (Glosses) found in the ICB Corpus (top 200) {#app:verbs}
\hphantom{em}


```{r , echo=F, results='hide', message=F, warning=F, eval=T , cache=F}

#Switched to spans here
icb_text <- ICBe_events_agreed %>% dplyr::select(crisno,sentence_number_int_aligned, sentence=sentence_span_text) %>% distinct() %>% dplyr::mutate_at(vars(sentence_number_int_aligned), as.numeric) %>% arrange(crisno,sentence_number_int_aligned)

# writeLines(icb_text$sentence %>% na.omit() %>% iconv("UTF-8", "ASCII", "?"), paste0(here::here(), "/replication_data/temp/sentences.txt"), useBytes = T)

fromscratch=F
if(fromscratch){
  #Here we use spacy to extract verbs from the sentences
  p_load("spacyr")
  #spacy_install() 
  spacy_initialize(model = "en_core_web_sm")

  parsed <- spacy_parse(icb_text$sentence, nounphrase = TRUE)
  parsed_consolidated <- nounphrase_consolidate(parsed)
  parsed$doc_id_num <- parsed$doc_id %>% str_replace_all("text","") %>% as.numeric()
  parsed$crisno <- icb_text$crisno[parsed$doc_id_num]
  parsed$sentence_number_int_aligned <- icb_text$sentence_number_int_aligned[parsed$doc_id_num]  %>% as.numeric()
  parsed$sentence <- icb_text$sentence[parsed$doc_id_num] 
  
  parsed %>% saveRDS(paste0(here::here(), "/replication_paper/data/temp/parsed.Rds"))
  
  entities <- entity_extract(parsed, type = "all")
  entities %>% saveRDS(paste0(here::here(), "/replication_paper/data/temp/entities.Rds"))

} else {
  parsed <- readRDS(paste0(here::here(), "/replication_paper/data/temp/parsed.Rds"))
  entities <- readRDS(paste0(here::here(), "/replication_paper/data/temp/entities.Rds"))
  
}

entities$doc_id_num <- entities$doc_id %>% str_replace_all("text","") %>% as.numeric()
entities$crisno <- icb_text$crisno[entities$doc_id_num]
entities_unique <- entities %>% dplyr::select(entity,entity_type) %>% mutate(entity = entity %>% str_to_lower() %>% str_replace_all("[^A-Za-z0-9]","") ) %>% distinct()

target_file <- paste0(here::here(),"/replication_paper/data/in/icb_manual_recoding_master_sheet.xlsx")
dictionary_actors    <- readxl::read_excel(target_file, sheet="actors")

unique_agent_q_codes <- dictionary_actors$value_disaggregated_wikidata_id %>% na.omit() %>% unique() %>% str_split(";") %>% unlist() %>% trimws() %>% unique()
unique_actor_q_codes <- dictionary_actors$value_normalized_wikidata_id %>% na.omit() %>% unique() %>% str_split(";") %>% unlist() %>% trimws() %>% unique()

verbs_sentence <- parsed %>% filter(pos=="VERB") 

verbs <- parsed %>% filter(pos=="VERB") %>% dplyr::select(lemma, pos) %>% distinct()

entities_per_sentence <- entities %>% 
  count(doc_id) %>% 
  summarise(
    entities_per_sentence_min=min(n),
    entities_per_sentence_mean=mean(n),
    entities_per_sentence_max=max(n),
  )

```

```{r, echo=F, results='hide', message=F, warning=F, eval=T , cache=F}

#wordnet rdf (in tripple format)
#wordnet rdf (in tripple format)
fromscratch=F

wordnet_rdf <- readRDS(paste0(here::here(), "/replication_paper/data/in/wordnet_rdf.Rds") )
subject_headings <- wordnet_rdf %>% as_tibble() %>% filter(value %>% str_detect('http://purl.org/dc/terms/subject'))
subject_headings_verbs <- subject_headings %>%
                          filter(value %>% str_detect('-v>')) %>% 
                          mutate(value=value %>% str_replace("<http://wordnet-rdf.princeton.edu/id/","2")) %>% 
                          mutate(value=value %>% str_replace("-v> <http://purl.org/dc/terms/subject> ","\t")) %>%
                          separate(value, c("a", "b"), extra = "drop", fill = "right", sep="\t") %>%
                          mutate(b = b %>% str_replace_all('\\"| \\.',""))

#subject_headings <- wordnet_rdf %>% as_tibble() %>% filter(value %>% str_detect('00002137')) #the first digit is for part of speech so we can remove that if we subset to just verbs
#wordnet csv
filenames <- list.files(path=paste0(here::here(), "/replication_paper/data/in/wncsv-master/csv/"))
filepaths <- list.files(path=paste0(here::here(), "/replication_paper/data/in/wncsv-master/csv/"), full.names = T)

wordnet_list <- lapply(filepaths, read_csv, col_names=F, progress=F, show_col_types=F)
names(wordnet_list) <- filenames

#wordnet_list[[8]]
#wordnet_list[[16]]
#wordnet_list[[19]]

#wordnet_list[["wn_cls.csv"]]
#wordnet_list[["wn_vgp.csv"]]

hypernyms <- wordnet_list[['wn_hyp.csv']] %>% 
              dplyr::select(a=X1,b=X2) %>% 
              left_join(wordnet_list[["wn_s.csv"]] %>% dplyr::select(a=X1, a_lemma=X3) ) %>% 
              left_join(wordnet_list[["wn_s.csv"]] %>% dplyr::select(b=X1, b_lemma=X3) )

library(igraph)
g_hypernyms <-  graph_from_data_frame(hypernyms, directed = TRUE)

wordnet <- wordnet_list[["wn_s.csv"]] %>% dplyr::select(wordnetid=X1, lemma=X3, tense=X4) %>% full_join( wordnet_list[['wn_g.csv']] %>% dplyr::select(wordnetid=X1, gloss=X2) )

wordnet_verbs <- wordnet %>% filter(tense=='v')

verbs_sentence_wordnet <- verbs_sentence %>% left_join(wordnet_verbs)
#oh got it this is all possible matching glosses per ICBe sentence
#dim(verbs_sentence_wordnet) #227,426

#I think we use sbert to embed the original sentence and the gloss and then calculate pairwise distances

gloss_unique <- verbs_sentence_wordnet$gloss %>% unique() #how are there so few unique glosses?
length(gloss_unique) #And there's also about 5k unique glosses 

sentences_unique <- verbs_sentence_wordnet$sentence %>% unique()
length(sentences_unique) #11769

```

```{python embed glosses, echo=F, results='hide', message=F, warning=F, eval=T , cache=F}
#Can't get this and spacy to work in the same run. Once reticulate loads once it sticks with the environment that came first and I can't figure out how to switch it.
#pip install -U sentence-transformers

import torch
use_cuda = torch.cuda.is_available()
if use_cuda:
    print('__CUDNN VERSION:', torch.backends.cudnn.version())
    print('__Number CUDA Devices:', torch.cuda.device_count())
    print('__CUDA Device Name:',torch.cuda.get_device_name(0))
    print('__CUDA Device Total Memory [GB]:',torch.cuda.get_device_properties(0).total_memory/1e9)
    print('__CUDA Device Name:',torch.cuda.get_device_name(1))
    print('__CUDA Device Total Memory [GB]:',torch.cuda.get_device_properties(1).total_memory/1e9)    

import random
import os
from tqdm.auto import tqdm
import pandas as pd
from transformers import pipeline
from transformers.pipelines.pt_utils import KeyDataset

fromscratch=False

if fromscratch:
  from sentence_transformers import SentenceTransformer
  import numpy as np
  glosses=np.array(r.gloss_unique) #sentences_unique_sanitized
  glosses_chars = np.array([len(q) for q in glosses])
  #sentences=sentences[sentence_chars<1000] #cull anything with too many characters
  len(glosses) #4977
  n=len(glosses)
  chunk_length=100
  n_chunks = int(np.ceil(n/chunk_length)) #can only 
  glosses_chunks=[glosses[i:i + chunk_length] for i in range(0, n, chunk_length)]
  len(glosses_chunks)
  len(glosses_chunks[0])  
  model = SentenceTransformer('paraphrase-mpnet-base-v2')
  glosses_embeddings = np.vstack([model.encode(q) for q in glosses_chunks])  #[0:100] #cpu is possible just painfully slow #, device='0'
  glosses_embeddings.shape #(4977, 768)

else:
  print("Skipping")

```


```{python embed sentences for wordnet , echo=F, results='hide', message=F, warning=F, eval=T , cache=F}

#Make sure you have a gpu if you want to run thi

#Now embed the sentences from above (note this is raw original sentences not the normalized ones used in the main paper)
#Can't get this and spacy to work in the same run. Once reticulate loads once it sticks with the environment that came first and I can't figure out how to switch it.
#pip install -U sentence-transformers

fromscratch=False
if fromscratch:
  from sentence_transformers import SentenceTransformer
  import numpy as np
  sentences=np.array(r.sentences_unique) #sentences_unique_sanitized
  sentence_chars = np.array([len(q) for q in sentences])
  #sentences=sentences[sentence_chars<1000] #cull anything with too many characters
  len(sentences) #12161 12162
  n=len(sentences)
  chunk_length=100
  n_chunks = int(np.ceil(n/chunk_length)) #can only 
  sentences_chunks=[sentences[i:i + chunk_length] for i in range(0, n, chunk_length)]
  len(sentences_chunks)
  len(sentences_chunks[0])  
  #model = SentenceTransformer('sentence-transformers/all-mpnet-base-v2')
  #model = SentenceTransformer('sentence-transformers/gtr-t5-xxl')
  #model = SentenceTransformer('sentence-transformers/gtr-t5-xl')
  model = SentenceTransformer('paraphrase-mpnet-base-v2')
  #sentences
  #sentences_test=['That is a happy person','That is a happy dog','That is a not happy person','That person is happy','This person is happy']
  #temp = model.encode(sentences_chunks[0])
  sentences_embeddings = np.vstack([model.encode(q) for q in sentences_chunks])  #[0:100] #cpu is possible just painfully slow #, device='0'
  sentences_embeddings.shape #(12103, 768)
else:
  print("Skipping")

```


```{r wordnet trees, echo=F, results='hide', message=F, warning=F, eval=T , cache=F}

fromsrcatch=F
if(fromsrcatch){
  #py$sentences
  #py$glosses
  glosses_embeddings <- py$glosses_embeddings
  sentences_embeddings <- py$sentences_embeddings

  rownames(sentences_embeddings) <- py$sentences #[1:100] 
  dim(sentences_embeddings)
  rownames(glosses_embeddings) <- py$glosses #[1:100]
  dim(glosses_embeddings)
  
  condition_glosses_embeddings <- verbs_sentence_wordnet$gloss %in% rownames(glosses_embeddings)
  table(condition_glosses_embeddings) #there are 130 glosses that aren't in there
  gloss_clean <- verbs_sentence_wordnet$gloss
  gloss_clean[!condition_glosses_embeddings] <- rownames(glosses_embeddings)[1] #just a placeholder need to kill after
  glosses_embeddings_expanded <- glosses_embeddings[gloss_clean ,]
  dim(glosses_embeddings_expanded)
  
  condition_sentences_embeddings <- verbs_sentence_wordnet$sentence %in% rownames(sentences_embeddings)
  table(condition_sentences_embeddings) #all are in it
  sentences_clean <- verbs_sentence_wordnet$sentence
  sentences_clean[!condition_sentences_embeddings] <- rownames(sentences_embeddings)[1] #just a placeholder need to kill after
  sentences_embeddings_expanded <- sentences_embeddings[sentences_clean ,]
  dim(sentences_embeddings_expanded)
  
  #Isn't it just one minus the other?
  verbs_sentence_wordnet$distances <- rowSums((glosses_embeddings_expanded-sentences_embeddings_expanded)^2)
  verbs_sentence_wordnet <- verbs_sentence_wordnet %>% arrange(crisno, sentence_number_int_aligned, token_id, distances)
  verbs_sentence_wordnet %>% saveRDS(paste0(here::here(), "/replication_paper/data/temp/verbs_sentence_wordnet.Rds"))

} else {
  
  verbs_sentence_wordnet <- readRDS(paste0(here::here(), "/replication_paper/data/temp/verbs_sentence_wordnet.Rds"))
  
}

verbs_sentence_wordnet_top <- verbs_sentence_wordnet %>% group_by(crisno, sentence_number_int_aligned, token_id) %>% filter(row_number()==1)
verbs_sentence_wordnet_top_unique <- verbs_sentence_wordnet_top %>% ungroup() %>% dplyr::select(lemma, wordnetid,tense, gloss) %>% group_by(lemma, wordnetid,tense, gloss) %>% count() %>% arrange(desc(n))

```


```{r create verb table , eval=T, echo=F, results="markup", include=T, message=T, cache=F, ft.arraystretch=0.75}

set_flextable_defaults(fonts_ignore=TRUE)
n_keep=200
verbs_sentence_wordnet_top_ft <-
        verbs_sentence_wordnet_top_unique %>%
        ungroup() %>% 
        head(n_keep) %>%
        dplyr::select(n, lemma, gloss ) %>% #wordnetid
        mutate(gloss=gloss %>% str_replace_all('[^A-Za-z0-9 ,.\"]','')) %>%
  
        flextable::as_flextable() %>% 
        
        #bg( j = condition, part = "body", bg = "#EFEFEF") %>%
        #width(j = 1, width=1.25) %>%
        #width(j = 2:ncol(lit_review_clean), width=0.25) %>%
        flextable::fontsize(size = 6, part = "all") %>% 
        #rotate(rotation="tbrl",part="header") %>%
        set_header_labels( values = list(lemma = "lemma", wordnetid = "wordnetid", gloss="gloss", n="uses")) %>%
        #align(align = "center", part = "body") %>%
        #align(align = "center", part = "header") %>%
        flextable::padding(padding = 0, part = "all") %>%
        flextable::line_spacing(space = 1, part = "body") %>%
        #ftExtra::colformat_md(j = 1, part="body")   #Make sure this goes last or it'll get overwritten by the colformat above
        #fit_to_width(max_width=12) #This is crazy slow
        #flextable::autofit() 
        #set_table_properties(width = 1, layout = "autofit")

      bg( i = which( 1:n_keep %% 2 == 1), part = "body", bg = "#EFEFEF") %>%
      #merge_v(part = "body") %>% 
      flextable::width( j = 1, width=0.3) %>%
      flextable::width( j = 2, width=.75) %>%
      flextable::width( j = 3, width=6) %>%
      #flextable::line_spacing( space = 0.5, part = "body") %>% #i=1:nrow(lit_review_alt),
      flextable::padding(padding = 0, part = "body") %>%
      #hline(i=which( actor_agents$Player!=c(actor_agents$Player[2:length(actor_agents$Player)], NA) ), border = fp_border(color="gray", width = 0.25), part = "body") 
  
      #add_header( "IR Player_Pieces"="Citations"

      #            top = TRUE ) %>%
      set_header_labels(
        values = list(
          "uses" = "Count",
          'lemma'='Lemma',
          'gloss'='Gloss'
          ) 
        ) 
      
      
#https://cran.r-project.org/web/packages/ftExtra/vignettes/format_columns.html

verbs_sentence_wordnet_top_ft  %>% saveRDS(paste0(here::here(), '/replication_paper/tables/verbs_sentence_wordnet_top_ft.Rds'))


```

```{r verb table , eval=T, echo=F, results='markup', include=T, message=F, cache=F, warning=F,  ft.arraystretch=0.75}
#, child=c('ICBEdataset_paper_appendixVerbMeanings.Rmd')

verbs_sentence_wordnet_top_ft  <- readRDS(file=paste0(here::here(), '/replication_paper/tables/verbs_sentence_wordnet_top_ft.Rds'))
verbs_sentence_wordnet_top_ft
```

\clearpage

# Appendix B: Coding Process
\hphantom{em}

## Figure B1: Graphical User Interface {#app:gui}
\hphantom{em}

\begin{figure}[H]
\caption{Graphical User Interface (GUI) for coding ICBe\label{fig:coding_gui}}
\centering{\includegraphics[width=17cm]{./gui_example}}
\end{figure}

## Algorithm B2: Coding Aggregation and Filtering {#app:algo1}
\hphantom{em}

\begin{algorithm}[H]
\SetAlgoLined
\KwData{Coder-Sentence-Tokens}
\KwResult{Sentence-Events}
\ForEach{sentence in sentences}{
  \ForEach{concept in concepts}{
    \ForEach{token in tokens}{
      \lIf{expert votes==0}{reject; \tcc*[f]{Require at least one expert vote}}
      \uElseIf{expert votes > expert voters/2}{accept; \tcc*[f]{And a majority of expert votes}}
      \uElseIf{novice votes > novice voters/2}{accept; \tcc*[f]{Or a majority of novice votes}}
    }
    \If{sum(accepted) == 0}{
      sort tags by votes;
      head 1;
      accept; \tcc*[f]{If still no tag, take one with most votes}
    }
  }
  \ForEach{ActorSet in unique(ActorSets)}{
    emit event;
  }
}
\caption{Aggregating Coder-Tokens into Sentence-Events}
\end{algorithm}



## Figure B3 : Intercoder Agreement {#app:intercoderagreement}
\hphantom{em}

```{r, eval=T, echo=F, results='markup', include=T, message=F, cache=F, warning=F,  ft.arraystretch=0.75, fig.width=6, fig.height=6}

fromscratch=F
if(fromscratch){
  means_group_any <- codings_long_agreement %>% filter(value_normalized!='') %>% 
                     #filter(votes_total>1) %>% #
                     group_by(crisno,sentence_number_int_aligned, varname_normalized) %>% arrange(desc(percent_expert)) %>% filter(row_number()==1) %>% ungroup() %>% 
                     dplyr::select(Experts=percent_expert,Novices=percent_novice) %>% summarise_all(mean)
  
  means_group_keep <- codings_long_agreement %>% filter(value_normalized!='') %>% 
                      filter(algo1==1) %>%
                      #filter(votes_total>1) %>%
                      group_by(crisno,sentence_number_int_aligned, varname_normalized) %>% arrange(desc(percent_expert)) %>% filter(row_number()==1) %>% ungroup() %>% 
                      dplyr::select(Experts_keep=percent_expert,Novices_keep=percent_novice) %>% summarise_all(mean)
  
  means_group <- bind_rows( means_group_any %>% pivot_longer(c(Experts, Novices)),  means_group_keep %>% pivot_longer(c(Experts_keep, Novices_keep)) )
  
  #Calculate average agreements by group
  means_all <- codings_long_agreement %>% 
                #This is top 1 agreement
                filter(value_normalized!='') %>% group_by(crisno,sentence_number_int_aligned, varname_normalized) %>% 
                arrange(desc(percent_expert)) %>% filter(row_number()==1) %>% ungroup() %>% 
                group_by(varname_normalized) %>%
                mutate(n=n()) %>%
                #filter(votes_total>1) %>% #about 9k only had one coder
                #filter(selected_by_experts>=1) %>%
                dplyr::select(Experts=percent_expert,Novices=percent_novice,n) %>% 
                summarise_all(mean, na.rm=T)
  
  means_keap <- codings_long_agreement %>% 
                #Algo 1 agreement
                filter(algo1==1) %>% 
                #This is top 1 agreement
                filter(value_normalized!='') %>% group_by(crisno,sentence_number_int_aligned, varname_normalized) %>% arrange(desc(percent_expert)) %>% filter(row_number()==1) %>% ungroup() %>% 
                group_by(varname_normalized) %>%
                #filter(votes_total>1) %>% #What work is this doing?
                #filter(selected_by_experts>=1) %>%
                dplyr::select(Experts_keep=percent_expert,Novices_keep=percent_novice) %>% summarise_all(mean, na.rm=T)
  
  factor_order <- means_keap %>% arrange(desc(Experts_keep)) %>% pull(varname_normalized)
  p_percent_chose_tag_by_concept <- 
  means_all %>% full_join(means_keap) %>% mutate(varname_normalized = varname_normalized %>% factor(levels=factor_order %>% rev)) %>%
    filter(n>100) %>% dplyr::select(-n) %>% #require at least 100 examples
  pivot_longer(c(-varname_normalized)) %>%
      ggplot(aes(x=selected_by_any_perc, y=varname_normalized)) + 
      #geom_boxplot() + 
      geom_point(aes(x=value, color=name )) +
      xlab("Percent of Coders that selected Tag") +
      ylab("") +
      labs(
        title = "Intercoder Agreement by Concept (Top 1 Tags)",
        subtitle = "Mean by Concept (points), Mean by Group (Vertical Lines)",
        caption = paste0("Mean by Concept (Point); Mean by Group (Line)"), 
       color = "Codings"
       ) + 
      theme_bw() +
      theme(legend.position="bottom") +
      geom_vline(data=means_group, aes(xintercept = value, color = name), linetype="solid", size=1, alpha=0.5)
  
  
  ggplot2::ggsave(file=paste0(here::here(), '/replication_paper/pnas_draft/p_percent_chose_tag_by_concept.png'), 
                  plot = p_percent_chose_tag_by_concept, width=8, height=8)
}

```

\begin{figure}[H]
\caption{Intercoder Agreement by Concept/Type \label{fig:intercoderagreement}}
\centering{\includegraphics[width=15cm]{./p_percent_chose_tag_by_concept.png}}
\end{figure}



## Figure B4 : Intercoder Agreement by Confidence {#app:agreement_by_confidence}
\hphantom{em}

```{r intercoder agreement , eval=T, echo=F, results='markup', include=T, message=F, cache=F, warning=F,  ft.arraystretch=0.75, fig.width=6, fig.height=6}

fromscratch=F
if(fromscratch){
  raterconfidence <- icb_long_clean %>% filter(email_id %>% str_detect('expert') & varname_normalized=='raterconfidence' ) %>%
                     dplyr::select(email_id, crisno, sentence_number_int_aligned, raterconfidence=value_normalized) %>% distinct()
  
  temp <- codings_long_agreement %>% 
          #Algo 1 agreement
          filter(algo1==1) %>% 
          #This is top 1 agreement
          filter(value_normalized!='') %>% group_by(crisno,sentence_number_int_aligned, varname_normalized) %>% arrange(desc(percent_expert)) %>% filter(row_number()==1) %>% ungroup() %>%                    left_join(raterconfidence) %>% 
          group_by(raterconfidence)
  
  p_percent_chose_tag_by_confidence <- temp %>%
    dplyr::select(percent_expert,raterconfidence) %>%
    filter(raterconfidence!='NA') %>%
    ggplot(aes(x=percent_expert, y=raterconfidence)) + geom_boxplot(notch=T) +
    xlab("Percent of Coders that selected Tag") +
    ylab("Self Reported Confidence") +
    labs(
      title = "Observed Intercoder Agreement by Self Reported Confidence"#,
      #subtitle = "Mean by Concept (points), Mean by Group (Vertical Lines)",
      #caption = paste0("Mean by Concept (Point); Mean by Group (Line)"), 
      #color = "Codings"
     ) + 
    theme_bw() +
    theme(legend.position="bottom") 
  
  ggplot2::ggsave(file=paste0(here::here(), '/replication_paper/pnas_draft/p_percent_chose_tag_by_confidence.png'), 
                  plot = p_percent_chose_tag_by_confidence, width=8, height=6)
}

```


\begin{figure}[H]
\caption{Intercoder Agreement by Concept/Type \label{fig:intercoderagreement_confidence}}
\centering{\includegraphics[width=15cm]{./p_percent_chose_tag_by_confidence.png}}
\end{figure}

\clearpage


# Appendix C: Recall
\hphantom{em}

## Algorithm C1: Synthetic Narratives
\hphantom{em}

A synthetic narrative is constructed as follows. First, compile a large corpus, $D$, of timelines, encyclopedia entries, journal articles, news reports, websites, and government documents. Next, segment into sentences, $s \in S$, clean, filter, and break into simpler concise sentences, $s^* \in S^*$, using a large natural language model, BART [@lewisBARTDenoisingSequencetoSequence2019], fine-tuned on summarization tasks, distilbart-cnn-12-6 [@shleiferPretrainedSummarizationDistillation2020]. Then, calculate semantic similarity between each $S*$ by embedding them with a different large language model, MPNet [@songMPNetMaskedPermuted], fine tuned to identify paraphrasing [@reimersSentenceBERTSentenceEmbeddings2019;@reimersMakingMonolingualSentence2020]. Next, constructed an undirected weighted graph of pair above 95th percentile cosine similarity and hierarchically cluster them into potential events $e^* \in E^*$ [@clausetFindingCommunityStructure2004]. The resulting set of $E^*$ are small enough to check by hand, summarize, and place in chronological order. The relevant formulas and algorithm are shown below.

Cosine Similarity
\begin{equation}
cosine\;similarity = \frac{a \cdot b}{ || a  ||\;|| b  || }
\end{equation}

Adjacency Matrix
\begin{equation} \label{eq:sclrec2}
A_{vw}= \begin{cases} 1 \text{ if vertices v and w are connected} \\ 0 \text{ otherwise } \end{cases}
\end{equation}

Identity Function
\begin{equation}
\delta(i,j)= \begin{cases} 1 \text{ if i=j} \\ 0 \text{ otherwise } \end{cases}
\end{equation}

Degree of a vertex
\begin{equation}
k_v = \sum_{w}A_{vw}
\end{equation}

Modularity - Is the difference between observed within-community edges and average expected edges on a random graph
\begin{equation} \label{eq:sclrec2}
Q = \frac{1}{2m}\sum_{vw}[A_{vw}-\frac{k_vk_w}{2m}]\delta(C_w,C_w)
\end{equation}

\begin{algorithm}[H]
\SetAlgoLined
\KwData{Document-Sentences}
\KwResult{Event-Mentions}
\tcc{ Embed text as a 768 dimensional semantic vector with a large language model}
\ForEach{document in Document}{
  \ForEach{sentence in sentence}{
    embedding=distilbart-cnn-6-6(sentence);
  }
}

similarity = cosine similarity(embeddings,embeddings);

\tcc{ Threshold similarity matrix and create weighted undirected graph }

\tcc{ Frame as adding edges so efficient nearest neighbor lookup can be used }

g=EmptyUndirectedWeightedGraph();\tcc*[f]{Sparse undirected graph to store edges}

\ForEach{v in 1:rows(similarity)}{
  \ForEach{w in 1:cols(similarity)}{ 
    \lIf{similarity[v,w]>0.96 and doc(V)!=doc(W)}{append edge v<->w to g}\tcc*[f]{If similar append as undirected edge to graph}
  }
}

\tcc{ Community detection with greedy hierarchically clustering (Clauset et al. 2004)}

gClustered=EmptyUndirectedGraph(vertices(g)); \tcc*[f]{Sparse undirected graph to store edges}
dendrogram=list()
\While{length(edges(g))>1}{

  \ForEach{edge in edges(g)}{
    Qpossible[edge]=Q(gClustered + edge)
  }
  
  \ForEach{ edge in edges(g) } {
    \tcc{ Add the edge with the maximum increase in modularity }
    \tcc{ Remove from original graph as a housekeeping trick }
    \lIf{ QPossible[edge]=max(QPossible) }{ append edge to gClustered and remove edge from g; append QPossible to dendrogram }
  }
}
\tcc{ Cut the dendrogram to maximize modularity and return event clusters}
\Return dendrogram where Q(dendrogram)==max(dendrogram) \tcc*[f]{}
\caption{Clustering and counting sentences about the same event}
\end{algorithm}


\clearpage

## Table C2: Synthetic Narrative Matches Cuban Missile
\hphantom{em}


<!-- Gibler's Narratives

MID#27 
Dispute Number: 27 
Date(s): July 25, 1961 to October 28, 1961 
Participants:  2  United  States  of  America,  200  United  Kingdom,  220  France,  260  
German  Federal  Republic/265  German  Democratic  Republic,  290  Poland,  315  
Czechoslovakia, 365 Russia 
Outcome (and Settlement): Unclear (None) 
Fatalities: None 
Narrative:  The  Soviet  Union  for  several  months  leading  up  to  this  dispute  had  
increasingly  become  stern  in  its  wishes  for  a  united  Germany.  This  sternness  on  
Khrushchev’s part manifested itself in a treaty deadline, set for December 1961. In a  
public address on July 25, 1961, President Kennedy made a request for congressional  
authorization to mobilize selected military units to respond to the threat to Berlin. On  
August 13, the East German government released a declaration that stated that in the  
face of aggressive aspirations, East Germany would take the necessary measures to  
guarantee the security of the German Democratic Republic. The East German military  
fortified its borders with West Berlin and began to build a wall on the border in the  
city. In addition, barricades were built that encircled West Berlin, blockading it from  
East  Germany  entirely.  Two  Russian  divisions  were  reported  to  be  equipped  with  
armor and artillery. 
In response to this blockade, the United States, Britain, and France initiated a troop  
buildup in West Germany and West Berlin on August 17. On October 17, Khrush- 
chev announced that it appeared the West wanted to negotiate, and thus the need for  
the  December  deadline  was  unnecessary.  In  direct  contrast  to  his  words  however,  
on October 27, Soviet tanks were moved up to the sector boundary, amounting to a  
standoff with previously deployed American tanks. As soon as the Soviet government  
heard of this movement they called the forces back. The Soviet tanks withdrew from  
their positions on the morning of October 28. This action marked the end of the Berlin  
Crisis of 1961. 



MID#61 
Dispute Number: 61 
Date(s): August 1, 1962 to December 12, 1962 
Participants: 2 United States of America/365 Russia, 40 Cuba  
Outcome (and Settlement): Yield by side B (Negotiated)  
Fatalities: None 
Narrative:  Tensions  between  the  United  States  and  Cuba  were  high  after  Castro  
removed Batista and came to power in 1959. US policy sought the overthrow of the  
Castro regime in Cuba, and in 1961 the United States supported a group of Cuban  
exiles in the unsuccessful Bay of Pigs invasion. In September 1962 the situation in  
Cuba escalated. 
   On  September  3,  the  Soviets  announced  that  it  would  send  arms  and  technical  
experts to Cuba and help Cuba expand its steel production. Four days later Kennedy  
requested activation of 150,000 reservists, and Congress approved the measure a week  
later. On September 22, the Soviets reiterated that the weapons they sent to Cuba were  
defensive only, and three days later Castro announced that Cuba would lease a port  
to the Soviets for fishing. In early October the United States was examining ways to  
end Cuban trade with the Western states. Castro then mobilized the Cuban forces in  
mid-October. 
   On October 22, US President Kennedy gave a public address in which he stated the  
United States had photographic evidence of Soviet missiles in Cuba that were capable  
of delivering nuclear weapons to much of the Americas; Kennedy announced a quar- 
antine/blockade of Cuba to begin two days later. The Organization of American States  
then passed a resolution calling for removal of Soviet weapons, and the UN Security  
Council debated the dispute. The Soviet Union accused the United States of piracy  
and flaunting international law in implementing a blockade of defensive weapons, and  
the Security Council requested UN Secretary-General U Thant to mediate the dispute. 
   Meanwhile, the leaders of the two countries sent letters back and forth. On October  
26, Khrushchev sent a letter in which he offered to withdraw the missiles in exchange  
for an end to the blockade and a guarantee that the United States would not invade  
Cuba.  Khrushchev  then  sent  another  letter  the  next  day  that  proposed  the  Soviets  
would withdraw the missiles from Cuba if the United States would withdraw its mis- 
siles from Turkey. On October 28, Khrushchev announced over Moscow Radio that  
the  Soviet  Union  would  withdraw  the  weapons  under  international  supervision.  In  
addition, Kennedy secretly agreed to withdraw US missiles from Turkey over four to  
five months. 
   The United States and Soviet Union continued discussions. A couple issues arose  
in  implementing  the  agreement  they  had  made:  first,  the  Soviets  did  not  consider  
IL-28 bombers to be offensive, and, second, Castro refused to allow verification mis- 
sions. On November 20, Kennedy gave a press conference that announced solutions  
to these problems. The Soviets would withdraw the IL-28s within 30 days; the United  
Nations would not send a verification team, but the Soviets would allow US ships to  
stop  and  inspect  departing  Soviet  ships.  The  United  States  would  also  use  its  own  
reconnaissance methods for verification and would lift the blockade. On December  
11, Khrushchev wrote to Kennedy that the Soviets had completed removing the mis- 
siles from Cuba. 
Coding changes: Start Date changed from January 28, 1962. 



MID#246 
Dispute Number: 246 
Date(s): May 1960 to April 19, 1961 
Participants: 365 Russia, 40 Cuba/2 United States of America 
Outcome (and Settlement): Unclear (None) 
Fatalities: None 
Narrative: In 1960, after the Cuban Revolution and the victory of the Communists in  
taking control of the government, Cuba began to nationalize foreign industries in its  
territory. This greatly upset the United States, and the American government began to  
try and coerce Cuba to cooperate with its policies. On April 22, 1960, Fidel Castro, the  
new premier of Cuba, accused the United States and its forces at Guantanamo Bay of  
aiding counterrevolutionaries and of planning an invasion of Cuba. A Cuban attack on  
a US submarine operating off the Cuban coast then occurred in May. Cuba asserted that  
the submarine had violated Cuba’s territorial waters. 
The Soviet Union entered the dispute on the side of Cuba on July 9, when Premier  
Khrushchev  threatened  to  retaliate  with  rockets  should  the  United  States  intervene  
militarily  in  Cuba.  This  tension  increased  through  1960  and  into  1961,  culminating  
in the Bay of Pigs invasion, supported by Central Intelligence Agency–trained Cuban  
exiles April 14–20, 1961. The Soviet Union again warned the United States that mili- 
tary intervention in Cuba would mean certain conflict between the super powers. 
Coding changes: Start Date changed from April 22, 1960. End Date changed from  
April 26, 1961. 



MID#253 
Dispute Number: 253 
Date(s): April 9, 1960 to July 1, 1960 
Participants: 2 United States of America, 385 Norway, 640 Turkey, 740 Japan, 770  
Pakistan/365 Russia 
Outcome (and Settlement): Released (Negotiated) 
Fatalities: 1–25 deaths 
Narrative: In an effort to monitor Soviet nuclear capabilities the United States flew  
U-2  reconnaissance  missions  high  over  the  USSR  from  1956,  believing  its  planes  
were  undetected.  On  May  1,  1960,  the  Soviets  downed  a  US  U-2  piloted  by  Gary  
Powers. Then on July 1, the Soviets downed a US Air Force RB-47 over the Barentz  
Sea, killing four crew members and capturing the other two. In August the Soviets  
convicted Powers of espionage and sentenced him to 10 years in prison. The Soviets  
sought an end to US overflights. 
   The Soviets pursued action in the UN Security Council and General Assembly, but  
every resolution was voted down. However, US overflights did end. Powers’s flight  
was the last authorized by the president and records indicate that the US government  
undertook no more. The Soviets released RB-47 personnel McKone and Olmstead on  
January 25, 1961. 
   Powers and American student Pryor were exchanged for Soviet spy Rudolf Abel  
on February 10, 1962. 
Coding changes: Start Date changed from May 1, 1960. End Date changed from July  
18, 1960. Fatalities changed from None. 



MID#1353 
Dispute Number: 1353 
Date(s): January 6, 1962 to February 20, 1973 
Participants: 365 Russia, 710 China, 816 Vietnam/2 United States of America, 200  
United Kingdom, 800 Thailand, 812 Laos, 900 Australia, 920 New Zealand 
Outcome (and Settlement): Compromise (Negotiated) 
Fatalities: Missing 
Narrative: This dispute began in early 1962 when Pathet Lao communist rebels, with  
support from North Vietnam, laid siege to Nam Tha, near the Thai border. On Febru- 
ary 13, Thai troops were deployed to the Lao border. On May 6, Pathet Lao forces  
attacked Nam Tha while Royal Lao forces ceded territory without a fight. The United  
States responded on May 12 by sending the Seventh Fleet to the Gulf of Siam and  
placing troops on alert. 
   The 1,000 US marines already in Thailand for bilateral training were also moved  
to  the  border.  Civil  war  fighting  continued  throughout  the  decade,  with  occasional  
transnational incidents affecting numerous neighbors and those countries fighting in  
Vietnam. Thailand took a direct role by training Laotian pilots, and South Vietnam  
trained Laotian officers. The United States and Soviets supplied the fighting forces  
and guarded their interests in the region. 
   The overall fight was largely static until 1969, when Pathet Lao began to achieve  
battlefield victories. Then, by 1972, Pathet Lao controlled two-thirds of the country.  
Discussions between the Laotian government and the Pathet Lao began in 1970, and  
formal negotiations took place in Vientiane from October 1972. These talks did not  
advance, though, until the United States applied pressure to the Laotian government.  
The United States wanted to enter the Paris Peace talks for Vietnam with the Laotian  
war already concluded. On February 20, 1973, representatives from the Laotian gov- 
ernment and Pathet Lao signed the Vientiane Agreement. 
Coding changes: End Date changed from February 15, 1973. 




MID#2219 
Dispute Number: 2219 
Date(s): November 19, 1961 to August 14, 1962 
Participants:  265  German  Democratic  Republic,  365  Russia/2  United  States  of  
America, 260 German Federal Republic 
Outcome (and Settlement): Unclear (None) 
Fatalities: 1–25 deaths 
Narrative: On November 22, 1961, an intensified border fortification effort in East  
Berlin began when East German forces erected a new barbed wire fence along the  
Spree  River.  This  effort  triggered  an  increase  in  what  were  already  tense  relations  
between the two Germanys. Border police skirmishes along the border of East and  
West Berlin were not uncommon. For example, on April 21, 1962, a brief gun battle  
took place when Eastern border police threw tear gas canisters over the border into  
West  Berlin.  The  United  States  joined  the  dispute  on  December  3,  1961,  when  it  
deployed  troops  to  monitor  the  west  side  of  the  Berlin  wall  at  the  Friedrichstrasse  
checkpoint. The Soviet Union joined the dispute on February 15, 1962, when Soviet  
MIGs began harassing aircrafts that were too close to East German airspace. The last  
incident in this dispute occurred on August 14, 1962, when border police exchanged  
fire across the border near Kassel. 



MID#3361 
Dispute Number: 3361 
Date(s): December 1961 to December 1962 
Participants: 2 United States of America/365 Russia, 710 China, 816 Vietnam 
Outcome (and Settlement): Unclear (None) 
Fatalities: None 
Narrative:  The  United  States  deployed  two  Army  helicopter  companies  to  South  
Vietnam, and American advisers began participating in South Vietnamese operations.  
China and the Soviet Union warned the United States not to attack North Vietnam. 
Coding changes: End Date changed from February 26, 1962. 
-->


```{r}



cuba_recall <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1NuRWFB1HEbQbJu_JoEzJ9WYk7kfwwCryF7wBfKPT6uc/edit?usp=sharing", 
                                sheet="final") %>% janitor::clean_names() 


replace_emoticons_cuba <- function(x){
  x %>% str_replace_all('\U0001f1e8\U0001f1fa',  paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q241.png) ")) %>%
        #https://emojiterra.com/flag-for-united-states/
        str_replace_all('\U0001f1fa\U0001f1f8',  paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q30.png) ")) %>%
        #https://emojiterra.com/flag-for-russia/
        str_replace_all('\U0001f1f7\U0001f1fa',  paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q15180.png) ")) %>% 
        #Turkey
        str_replace_all('\U0001f1f9\U0001f1f7',  paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q43.png) ")) %>% 
        #U.N.
        str_replace_all('\U0001f1fa\U0001f1f3',  paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q1065.png) "))
}

ft_cuba_recall<- cuba_recall %>% 
                            dplyr::select(date, event, documents, icb_narrative, icbe=ic_be, icb, mids, phoenix_2)  %>%
                            mutate(event = event %>% replace_emoticons_cuba() ) %>%
                            flextable::as_flextable() %>%
                            flextable::set_header_labels(values =
                            list(
                                  event = "Event",
                                  documents = "Mentions",
                                  icb_narrative = "ICB Narrative",
                                  icbe = "ICBe",
                                  icb = "ICB",
                                  mids="MIDs",
                                  phoenix_2="Phoenix"
                                 ) ) %>%
                            flextable::width( j = 1, width=0.25)  %>% 
                            flextable::width( j =2, width=2.0)  %>% 
                            flextable::width( j = 6:8, width=2.0)  %>% 
                            flextable::fontsize(size = 7, part = "all") %>%
                            #valign(j = 1:3, valign = "top", part = "body") %>%
                            flextable::line_spacing( space = 1.0, part = "all") %>% 
                            padding( padding = 1, part = "all") %>% 
                            bg( i = which( (1:nrow(cuba_recall) %% 2)==1   ) , part = "body", bg = "#EFEFEF") %>% #, j=1:3
                            ftExtra::colformat_md(j = 2, part="body")
  
ft_cuba_recall %>% save_as_image(path=here::here("replication_paper", "pnas_draft", "ft_cuba_recall.png"), zoom=1) # webshot = "webshot2"
  

```

\begin{figure}[H]
\caption{ Cuban Missile Crisis Synthetic Narrative Recall Matches \label{fig:ft_cuba_recall}}
\centering{\includegraphics[height=21cm]{./ft_cuba_recall.png}}
\end{figure}
\clearpage




## Table C3: Synthetic Narrative Matches Crimea-Donbas
\hphantom{em}


```{r}

crimea_recall <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1YesAx1CkYCgrEi_WVJ9aho60HesWA6p-3XMma9IzBrI/edit?usp=sharing", 
                                sheet="final") %>% janitor::clean_names()                                


replace_emoticons_crimea <- function(x){
      x %>%
            #https://emojiterra.com/flag-for-united-states/
            str_replace_all('\U0001f1fa\U0001f1f8', paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q30.png) ")) %>%
            #https://emojiterra.com/flag-for-russia/
            str_replace_all('\U0001f1f7\U0001f1fa', paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q159.png) ")) %>% 
            #Ukraine
            str_replace_all('\U0001f1fA\U0001f1e6', paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q212.png) ")) %>% 
            #Crimea
            str_replace_all('Crimea', paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q15966495.png) ")) %>%
            #EU
            str_replace_all('\U0001f1EA\U0001f1FA', paste0(" ![](", here::here(), "/replication_data/in/flags_small//Q458.png) "))
}


ft_crimea_recall<- crimea_recall %>% 
                            dplyr::select(date, event, documents=n_sources, icb_narrative, icbe=ic_be,  phoenix, terrier, icews)  %>%
                            mutate(event = event %>% replace_emoticons_crimea() ) %>%
                            mutate(date = date %>% as.Date()) %>%
                            flextable::as_flextable() %>%
                            flextable::set_header_labels(values =
                            list(
                                  event = "Event",
                                  documents = "Mentions",
                                  icb_narrative = "ICB Narrative",
                                  icbe = "ICBe",
                                  phoenix="Phoenix",
                                  terrier="Terrier",
                                  icews="ICEWS"
                                 ) ) %>%
                            flextable::width( j = 1, width=1.0)  %>% 
                            flextable::width( j =2, width=2.0)  %>% 
                            flextable::width( j = 6:8, width=2.0)  %>% 
                            flextable::fontsize(size = 7, part = "all") %>%
                            #valign(j = 1:3, valign = "top", part = "body") %>%
                            flextable::line_spacing( space = 1.0, part = "all") %>% 
                            padding( padding = 1, part = "all") %>% 
                            bg( i = which( (1:nrow(crimea_recall) %% 2)==1   ) , part = "body", bg = "#EFEFEF") %>% #, j=1:3
                            ftExtra::colformat_md(j = 2, part="body")
  
ft_crimea_recall %>% save_as_image(path=here::here("replication_paper", "pnas_draft", "ft_crimea_recall.png"), zoom=1) # webshot = "webshot2"


```



\begin{figure}[H]
\caption{ Crimea-Donbas Synthetic Narrative Recall Matches \label{fig:ft_crimea_recall}}
\centering{\includegraphics[height=21cm]{./ft_crimea_recall.png}}
\end{figure}
\clearpage

\clearpage

# Appendix D: Precision

\hphantom{em}

\clearpage

## Figure D1 Crimea-Donbos 
\hphantom{em}

```{r crimea case study precision, eval=T, results='hide', echo=F, include=T, message=F, cache=F}

#Move this to the appendix

#<!-- Rex remember that sentence 19 broken and cuts off 
#"Ukraine’s major response to its crisis was verbal and began on 27 February, when it sent a note to Russia demanding that Russian troops stay on base in Crimea, called for #calm, and discussed the" -->
 
#Loaded above now 
#ICBe_events_agreed_markdown <- readRDS( paste0(here::here(), "/replication_data/out/ICBe_V1.1_events_agreed_markdown.Rds")) 
fromscratch=T
if(fromscratch){
  temp <- ICBe_events_agreed_markdown %>%
          filter(crisno==471) %>%
          group_by(crisno, sentence_number_int_aligned) %>%
            filter(!duplicated(value_markdown %>% trimws() )) %>% #note there are dupe markdowns for some reason
          ungroup() %>%
          mutate(banding=sentence_number_int_aligned %% 2)
  temp$is_subsstring <- NA
  for(i in 1:nrow(temp)){
    temp$is_subsstring[i] <-   stringr::str_detect(temp$value_markdown %>% tolower() %>% str_replace_all('[^a-z0-9]',"") ,
                                                                                  pattern = fixed(temp$value_markdown[i] %>% tolower() %>% str_replace_all('[^a-z0-9]',"") )
                                                                                ) %>% replace_na(0) %>%  sum()
  }
  temp <-temp %>%
          mutate(value_markdown = ifelse(is_subsstring<=1,value_markdown,'')) %>%
          group_by(sentence_number_int_aligned) %>%
            filter(value_markdown!='' | length(value_markdown)==1) %>%
          ungroup() %>%
          mutate(crisno= ifelse(!is.na(lag(sentence_span_text)) & sentence_span_text==lag(sentence_span_text), "", crisno)) %>%
          mutate(sentence_number_int_aligned= ifelse(!is.na(lag(sentence_span_text)) &  sentence_span_text==lag(sentence_span_text), "", sentence_number_int_aligned)) %>%
          mutate(sentence_span_text= ifelse(!is.na(lag(sentence_span_text)) &  sentence_span_text==lag(sentence_span_text), "", sentence_span_text))   #C=crisno, 
        #head(100) %>%
  
  ft_crimea_precision_part1 <- temp %>% 
                              dplyr::select(S=sentence_number_int_aligned, ICB=sentence_span_text, ICBe=value_markdown)  %>%
                              filter(row_number()<=61) %>%
                              flextable::as_flextable() %>%
                              flextable::width( j = 1, width=0.25)  %>% 
                              #flextable::width( j = 2, width=0.25)  %>% 
                              flextable::width( j = 2, width=8.0)  %>% 
                              flextable::width( j = 3, width=4.0)  %>% 
                              flextable::fontsize(size = 9, part = "all") %>%
                              valign(j = 1:3, valign = "top", part = "body") %>%
                              flextable::line_spacing( space = 1.0, part = "all") %>% 
                              padding( padding = 1, part = "all") %>% 
                              bg( i = which( temp$banding[1:61]==1 ) , part = "body", bg = "#EFEFEF", j=1:3) %>%
                              ftExtra::colformat_md(j = 3, part="body")
  #ft_cuba_precision
  
  ft_crimea_precision_part1 %>% save_as_image(path=here::here("replication_paper", "pnas_draft", "case_study_crimea_precision_part1.png"), zoom=1) # webshot = "webshot2"
  
  
  ft_crimea_precision_part2 <- temp %>%
                        dplyr::select(S=sentence_number_int_aligned, ICB=sentence_span_text, ICBe=value_markdown)  %>%
                          filter(row_number()>=62  ) %>%
                        flextable::as_flextable() %>%
                        flextable::width( j = 1, width=0.25)  %>% 
                        #flextable::width( j = 2, width=0.25)  %>% 
                        flextable::width( j = 2, width=8.0)  %>% 
                        flextable::width( j = 3, width=4.0)  %>% 
                        flextable::fontsize(size = 9, part = "all") %>%
                        valign(j = 1:3, valign = "top", part = "body") %>%
                        flextable::line_spacing( space = 1.0, part = "all") %>% 
                        padding( padding = 1, part = "all") %>% 
                        bg( i = which( temp$banding[62:111]==1 ) , part = "body", bg = "#EFEFEF", j=1:3) %>%
                        ftExtra::colformat_md(j = 3, part="body")
  #ft_cuba_precision
  
  ft_crimea_precision_part2 %>% save_as_image(path=here::here("replication_paper", "pnas_draft", "case_study_crimea_precision_part2.png"), zoom=1) # webshot = "webshot2"
  
  temp <- NULL
  
}
```

\begin{figure}[H]
\caption{ Annexation of Crimea ICB Narrative and ICBe codings \label{fig:case_study_crimea_precision}}
\centering{\includegraphics[height=21cm]{./case_study_crimea_precision_part1.png}}
\end{figure}
\clearpage

\begin{figure}[H]
\centering{\includegraphics[height=21cm]{./case_study_crimea_precision_part2.png}}
\end{figure}
\clearpage

## Table D2: Stratified Sentence Examples

```{r Stratified Sentence Examples, eval=T, results='hide', echo=F, include=T, message=F, cache=F}

temp <- ICBe_events_agreed_markdown %>% dplyr::select(
  crisno, sentence_span_text,value_markdown,
  act_cooperative , act_deescalate, act_escalate,act_uncooperative,
  interact_decreasecoop,interact_deescalate,
  interact_escalate, interact_increasecoop,
  thinkkind,sayintkind
) %>% pivot_longer(cols=-c(crisno, sentence_span_text,value_markdown)) %>% na.omit() %>% filter(value!='') %>% 
    mutate(value = strsplit(as.character(value), ";")) %>% 
    unnest(value)

temp_sample <- temp %>% mutate(rand=runif(n())) %>% group_by(value)  %>% filter(rand==max(rand)) %>% ungroup() %>% arrange(name, value)

ft_sample_precision_precision1 <- temp_sample %>% 
                                  filter(row_number()<=56) %>%
                                  dplyr::select(name, value, crisno,  ICB=sentence_span_text, ICBe=value_markdown)  %>%
                                  flextable::as_flextable() %>%
                                  flextable::width( j = 1:2, width=0.5)  %>% 
                                  #flextable::width( j = 2, width=0.25)  %>% 
                                  flextable::width( j = 3, width=0.5)  %>% 
                                  flextable::width( j = 4:5, width=12.0)  %>% 
                                  flextable::fontsize(size = 9, part = "all") %>%
                                  valign(j = 1:3, valign = "top", part = "body") %>%
                                  flextable::line_spacing( space = 1.0, part = "all") %>% 
                                  padding( padding = 1, part = "all") %>% 
                                  bg( i = which( ((1:56) %% 2 )==1 ) , part = "body", bg = "#EFEFEF") %>% #, j=1:3
                                  ftExtra::colformat_md(j = 5, part="body")

ft_sample_precision_precision1 %>% save_as_image(path=here::here("replication_paper", "pnas_draft", "ft_sample_precision_precision1.png"), zoom=1) # 

ft_sample_precision_precision2 <- temp_sample %>% 
                                  filter(row_number()>=57) %>%
                                  dplyr::select(name, value, crisno,  ICB=sentence_span_text, ICBe=value_markdown)  %>%
                                  flextable::as_flextable() %>%
                                  flextable::width( j = 1:2, width=0.5)  %>% 
                                  #flextable::width( j = 2, width=0.25)  %>% 
                                  flextable::width( j = 3, width=0.5)  %>% 
                                  flextable::width( j = 4:5, width=12.0)  %>% 
                                  flextable::fontsize(size = 9, part = "all") %>%
                                  valign(j = 1:3, valign = "top", part = "body") %>%
                                  flextable::line_spacing( space = 1.0, part = "all") %>% 
                                  padding( padding = 1, part = "all") %>% 
                                  bg( i = which( ((1:59) %% 2 )==1 ) , part = "body", bg = "#EFEFEF") %>% #, j=1:3
                                  ftExtra::colformat_md(j = 5, part="body")

ft_sample_precision_precision2 %>% save_as_image(path=here::here("replication_paper", "pnas_draft", "ft_sample_precision_precision2.png"), zoom=1) # 


```

\hphantom{em}
\begin{figure}[H]
\caption{ Stratified Sentence Examples  \label{fig:ft_sample_precision_precision1}}
\centering{\includegraphics[height=21cm]{"./ft_sample_precision_precision1.png"}}
\end{figure}
\clearpage


\hphantom{em}
\begin{figure}[H]
\centering{\includegraphics[height=21cm]{"./ft_sample_precision_precision2.png"}}
\end{figure}
\clearpage

## Figure D3 Crisis Maps Cuban Missiles

\hphantom{em}

```{r crisis maps common functions, eval=T, results='hide', echo=F, include=T, message=F, cache=F}

global_check_overlap=F
library(igraph)
library(RColorBrewer)
library(ggraph)
target_file <- paste0(here::here(),"/replication_paper/data/in/icb_manual_recoding_master_sheet.xlsx")
dictionary_actors_labels    <- readxl::read_excel(target_file, sheet="actors") %>% 
                              dplyr::select(crisno, value_normalized=value_normalized_wikidata_id, value_normalized_label) %>% dplyr::distinct() %>% na.omit()

actor_translator <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1a7Id0Zg41PTKEv74H_KjiJzhMak2jGh0leT7B8oVWdI/edit?usp=sharing", 
                                sheet="actor_translator") #%>% janitor::clean_names() 
#Convert to a local file for pushing
#actor_translator    <- readxl::read_excel(target_file, sheet="actor_translator") #Ya we just add colors to the actor translator and we're good
pallet <- c(brewer.pal(n=20, "Dark2"), brewer.pal(n=20, "Set1"), brewer.pal(n=20, "Set2"), brewer.pal(n=20, "Paired")) %>% unique()
library(pals); #install.packages('pals')
pallet <- pals::glasbey()
pallet <- setdiff(pallet, c("#666666", "#999999", "#FFFF99","#FFFF33","#B2DF8A","#B3B3B3","#0000FF")) 
library(colorspace)
#cols <- c("#CDE4F3","#E7F3D3","#F7F0C7","#EFCFE5","#D0D1E7")    
pallet <- rgb(hex2RGB(pallet)@coords * 0.7)
actor_translator$actor_color = rep(pallet, length=nrow(actor_translator))

crisno_name_years <- icb_crises %>% dplyr::select(crisno, crisname, yrtrig, yrterm)



CAMEO_eventcodes <- read_tsv(paste0(here::here(), "/replication_paper/data/in/CAMEO.eventcodes.txt"), col_types='cccc') %>% janitor::clean_names()

cameo_role_codes <- data.frame(
       stringsAsFactors = FALSE,
                   role_code = c("GOV","SPY","OPP",
                            "MIL","PTY","REB","EDU","COP","JUD","CRM",
                            "BUS","MED","CVL","UAF","AGR","ELI","DEV","ENV",
                            "HLH","HRI","LAB","LEG","REF","MOD","RAD"),
  role_code_label = c("Government",
                            "Intelligence agencies",
                            "Opposition groups (often parliamentary)",
                            "Military",
                            "Political party",
                            "Rebels/insurgents",
                            "Education-focused actors",
                            "Law enforcement agencies",
                            "Judicial actors",
                            "Criminal actors",
                            "Business (NOT MNCs)",
                            "Media-related actors/organizations",
                            "Civilians",
                            "Unaffiliated armed forces",
                            "Agriculture-focused actors",
                            "Elites, celebrities",
                            "Development-focused actors",
                            "Environment-focused actors",
                            "Health-focused actors",
                            "Human rights-focused actors",
                            "Labor-focused actors",
                            "Legislative bodies/actors",
                            "Refugee-focused actors",
                            "Moderate/mainstream group",
                            "Radical/extremist/fundamentalist")
) %>% janitor::clean_names()


  subject_rejects <- c(
  "ACTIVISM,1" , "ACTIVISM,2" , "AGRICULTURE,1" , "AGRICULTURE,2" , "AGRICULTURE,3" , "AGRICULTURE,4" , 
  "BAILOUT,1" , "BANKRUPTCY,1" , 
   "BLACK_MARKET,1" , "CHECKPOINT,1" , 
   "CIVIL_SOCIETY,1" , "CLIMATE_CHANGE,1" , "COAL,1" , "COAL,2" , "COAL,3" , "COMMON_ROBBERY,1" , "CORRUPTION,1" , "CORRUPTION,2"     , 
    "DISCRIMINATION,1" , "DISEASE,1" , "DISEASE,2" , "DISEASE,3" , "DISEASE,4" , 
    "DRUG_CARTELS,1" , "DRUG_TRADE,1" , "DRUGS,1" , "DRUGS,2" , "DRUGS,3" , 
    "EXCHANGE_RATE,1" , "FOOD_SECURITY,1" , 
       "HOUSING_PRICES,1" , 
          "ELECTRICITY_OUTAGE,1" , 
          "INT_FINANCIAL_INST,1" , "INT_FINANCIAL_INST,2" , "INTEREST_RATES,1" , "INTEREST_RATES,2" , "LABOR_STRIKE,1" , 
   "LABOR_UNIONS,1" , "LABOR_UNIONS,2" , "LABOR_UNIONS,4" , "LANDMINE,1" , "LGBT,1" , "LITERACY,1" , "MEDIA_CENSORSHIP,1" , "MONOPOLY,1" , 
   "MONOPOLY,2" , 
    "ORGANIZED_CRIME,1" , 
    "POSTSECONDARY_EDUCATION,1" , "POSTSECONDARY_EDUCATION,2" , "POSTSECONDARY_EDUCATION,3" , "POVERTY,1" , "PRIVATIZATION,1" , "PRIVATIZATION,2" , 
   "PUBLIC_TRANSIT,1" , "PUBLIC_TRANSIT,2" , "PUBLIC_TRANSIT,3" , "RAPE,1" , "REFUGEES,1" , "REFUGEES,2" , "REFUGEES,3" , "RENEWABLE_ENERGY,1" , 
   "SCHOOLS,1" , "SCHOOLS,2" , "SCHOOLS,3" , 
   "SEXTRANS_DISEASE,1" , "SHORTAGE,1" , "SOCIAL_MOVEMENT,1" , "STUDENTS,1" , "STUDENTS,2" , "STUDENTS,3" , "SUBSIDIES,1" , 
   "TEACHERS,1" , "TEACHERS,2" , 
    "UNEMPLOYMENT,1" , "VACCINATION,1" , 
   "VACCINATION,2" , "YOUTH_MOVEMENT,1" 
  )
  
cameo_actor_codes <- data.frame(
  stringsAsFactors = FALSE,
                                   code = c("ABN","ABW","ACC",
                                            "ADB","AEA","AEU","AFB","AFG",
                                            "AFGGOVTAL","AFGREBTAL","AFR","AFU",
                                            "AGO","AGOCAB","AGOREBUNI","AGR",
                                            "AGR","AIA","AIE","ALA","ALB",
                                            "ALQ","AMN","AMU","AND","ANT",
                                            "APE","ARB","ARB","ARBBTH","ARE",
                                            "ARG","ARL","ARM","ASA","ASA",
                                            "ASF","ASM","ASN","ATG","ATH",
                                            "ATH","AUS","AUT","AZE","BAH",
                                            "BCA","BDI","BEL","BEN","BFA",
                                            "BGD","BGR","BHR","BHS","BIH","BIH",
                                            "BIHBHF","BIHSRP","BIS","BLK",
                                            "BLR","BLZ","BMU","BOL","BRA",
                                            "BRB","BRN","BTN","BUD","BUD",
                                            "BUS","BUS","BUS","BWA","CAF",
                                            "CAN","CAS","CAU","CEM","CEU",
                                            "CFR","CHE","CHL","CHN","CHNTIC",
                                            "CHR","CHR","CHRCPT","CHRCTH",
                                            "CHRDOX","CHRJHW","CHRLDS","CHRMRN",
                                            "CHRPRO","CHRRAD","CIS","CIV",
                                            "CIV","CMN","CMR","CNY","COD",
                                            "COD Bangladesh","COE","COG","COG",
                                            "COK","COL","COL","COM","CON",
                                            "CON","COP","CPC","CPV","CRB",
                                            "CRI","CRM","CRM","CRO","CSK",
                                            "CSS","CTH","CUB","CVL","CVL",
                                            "CVL","CWN","CYM","CYP","CYPGRK",
                                            "CYPTRK","CZA","CZE","DDR","DEU",
                                            "DEV","DEV","DJI","DMA","DNK",
                                            "DOM","DZA","DZAGOVFLN",
                                            "DZAGOVMSP","DZAGOVRND","DZAOPPENN",
                                            "DZAOPPFIS","DZAOPPFLN","DZAOPPMSP",
                                            "DZAREBFIS","DZAREBGIA","DZAREBGSP",
                                            "EAC","EAF","EBR","ECU","EDU",
                                            "EDU","EEC","EEU","EFT","EGY",
                                            "EGYREBMBR","EIN","EIN","ELI","ELI",
                                            "ENV","ENV","ENV","ERI","ESH",
                                            "ESP","ESPBSQ","EST","ETH",
                                            "EUR","FID","FIN","FJI","FLK","FLK",
                                            "FRA","FRO","FRY","FRYKSV",
                                            "FRYMTN","FRYSRB","FRYVVD","FSM",
                                            "FSM","GAB","GBR","GBRREBIRA",
                                            "GEO","GGY","GHA","GIB","GIN","GLP",
                                            "GMB","GME","GMW","GNB","GNQ",
                                            "GOS","GOV","GOV","GRC","GRD",
                                            "GRL","GTM","GUF","GUM","GUY",
                                            "GYP","GZA","HCH","HCR","HIN",
                                            "HIN","HKG","HKG","HLH","HLH",
                                            "HMS","HND","HRI","HRV","HRV",
                                            "HRW","HTI","HUN","HUT","IAD","IAE",
                                            "ICC","ICG","ICJ","ICO","IDB",
                                            "IDN","IGC","IGO","IGO",
                                            "IGOAFRAFU","IGOAFRAGRIAC","IGOAFRBUSCES",
                                            "IGOAFRBUSCFA","IGOAFRDEVAFB",
                                            "IGOAFRDEVATD","IGOAFRDEVNEP",
                                            "IGOAFROAU","IGOAFRPAP","IGOAGRCPA",
                                            "IGOAGRCPC","IGOAGRICO","IGOAGRIGC",
                                            "IGOARBAPE","IGOARBDEVABD",
                                            "IGOBUSBIS","IGOBUSGOE","IGOBUSGOS",
                                            "IGOBUSGSS","IGOBUSHIP","IGOBUSIMF",
                                            "IGOBUSOPC","IGOBUSPRC","IGOBUSWTO",
                                            "IGOCAFBCA","IGOCAFCEM",
                                            "IGOCAFECA","IGOCASCIS","IGOCOPITP",
                                            "IGOCWN","IGOEAFDEVIAD","IGOEAFEAC",
                                            "IGOEURBUSEFT","IGOEURCOE",
                                            "IGOEURDEVEBR","IGOEUREEC","IGOEURSCE",
                                            "IGOJUDICC","IGOLEGIPU","IGOMEAACC",
                                            "IGOMEAAEU","IGOMEAAMF",
                                            "IGOMEAAMU","IGOMEAARL","IGOMOSDEVIDB",
                                            "IGOMOSOIC","IGONAFCSS","IGONON",
                                            "IGOOAS","IGOPGSGCC","IGOPKO",
                                            "IGOSAFDEVSAD","IGOSASSAA","IGOSEAASN",
                                            "IGOSEADEVADB","IGOSEASOT","IGOUNO",
                                            "IGOUNOAGRFAO","IGOUNOAIE",
                                            "IGOUNODEVWBK","IGOUNOHLHWHO",
                                            "IGOUNOHRIHCH","IGOUNOIAE","IGOUNOJUDICJ",
                                            "IGOUNOJUDWCT","IGOUNOKID",
                                            "IGOUNOLABILO","IGOUNOREFHCR","IGOUNOWFP",
                                            "IGOWAFDEVWAM","IGOWAFUEM",
                                            "IGOWAFWAD","IGOWAFWAS","IGOWEU",
                                            "IGOWSTNAT","IHF","ILO","IMF","IMG",
                                            "IMGMOSALQ","IMGSEAMOSASF",
                                            "IMGSEAMOSJMA","IMY","IND","INDKAS",
                                            "INS","INT","IPU","IRC","IRL",
                                            "IRN","IRQ","IRQBAG","IRQKURKDP",
                                            "ISI","ISL","ISR","ISRGOVCMN",
                                            "ISRGOVLBA","ISRGOVLKD","ISRGOVMRZ",
                                            "ISRGOVSHA","ISROPPLBA","ISROPPLKD",
                                            "ISROPPMRZ","ISROPPSHA","ISRSET",
                                            "ITA","ITP","JAM","JAN","JAN",
                                            "JEW","JEW","JEWHSD","JEWUDX",
                                            "JMA","JOR","JOROPPIAF","JPN",
                                            "JUD","JUD","JUR","KAS","KAZ","KEN",
                                            "KGZ","KHM","KHMREBKMR","KID",
                                            "KIR","KNA","KNA","KOR","KOR",
                                            "KSV","KUR","KWT","LAB","LAB",
                                            "LAM","LAO","LBN","LBNREBAML",
                                            "LBNREBASL","LBNREBHEZ","LBR",
                                            "LBRBOM","LBRBON","LBRCAP","LBRGBA",
                                            "LBRGGC","LBRGOVLAP","LBRGOVNDP",
                                            "LBRGOVNPF","LBRGOVUPP","LBRKRH",
                                            "LBRKRU","LBRLOF","LBRMAN","LBRMNT",
                                            "LBRMRG","LBRMRY","LBRNIM",
                                            "LBROPPALC","LBROPPLAP","LBROPPNDM",
                                            "LBROPPNDP","LBROPPUPP","LBRREBAFL",
                                            "LBRREBINP","LBRREBLPC",
                                            "LBRREBLUR","LBRREBNPF","LBRREBULM",
                                            "LBRRVC","LBRSIN","LBY","LCA","LEG",
                                            "LEG","LIE","LKA","LKAREBJVP",
                                            "LSO","LTU","LUX","LVA","MAC",
                                            "MAR","MARREBPLS","MCO","MDA","MDE",
                                            "MDG","MDT","MDV","MEA","MED",
                                            "MED","MEX","MHL","MIL","MIL",
                                            "MKD","MLI","MLT","MMR","MMR",
                                            "MNC","MNC","MNE","MNG","MNP",
                                            "MOD","MOD","MOS","MOS","MOSALE",
                                            "MOSDRZ","MOSRAD","MOSSFI",
                                            "MOSSHI","MOSSUN","MOZ","MRT","MSF",
                                            "MSR","MTN","MTQ","MUS","MWI",
                                            "MYS","MYT","NAF","NAM","NAT",
                                            "NCL","NER","NFK","NGA","NGAABI",
                                            "NGAABU","NGAADA","NGAAKI","NGAANB",
                                            "NGABAU","NGABAY","NGABIA",
                                            "NGABNU","NGABOR","NGACRR","NGADEL",
                                            "NGAEBO","NGAEKI","NGAENU",
                                            "NGAGOM","NGAHAU","NGAIBO","NGAIJW",
                                            "NGAIMO","NGAJIG","NGAKAD","NGAKAN",
                                            "NGAKAT","NGAKEB","NGAKOG",
                                            "NGAKWA","NGALAG","NGANAS","NGANDR",
                                            "NGANGR","NGANNG","NGAOGO",
                                            "NGAOGU","NGAOND","NGAOPPANP",
                                            "NGAOPPCFD","NGAOPPNDC","NGAOSU","NGAOYO",
                                            "NGAPLA","NGAREBMAD","NGARIV",
                                            "NGASOK","NGATAR","NGATIV","NGAYOB",
                                            "NGAYRB","NGAZAM","NGM",
                                            "NGMGRP","NGO","NGO","NGOCHRCSI",
                                            "NGOHLHCRC","NGOHLHIRC","NGOHLHMSF",
                                            "NGOHLHRCR","NGOHRIAMN","NGOHRIFID",
                                            "NGOHRIHRW","NGOHRIIHF","NGOICG",
                                            "NGOJUDJUR","NGOREFIOM","NGOUAJ",
                                            "NGOWEF","NGOXFM","NIC","NIU",
                                            "NIU","NLD","NMR","NOR","NPL",
                                            "NRU","NZL","OAS","OAU","OCC",
                                            "OIC","OMN","OPC","OPP","OPP","PAG",
                                            "PAK","PAKKAS","PAL","PALPLO",
                                            "PALREBANO","PALREBPLF","PAN",
                                            "PCN","PER","PGS","PHL","PLW",
                                            "PNG","PNGBOU","POL","PPL","PRI",
                                            "PRK","PRK","PRO","PRT","PRY",
                                            "PSE","PSE","PSEGOVFTA","PSEGOVHMS",
                                            "PSEGZS","PSEREBAAM","PSEREBDFL",
                                            "PSEREBHMS","PSEREBISJ",
                                            "PSEREBPFL","PSEWSB","PTY","PYF","QAT",
                                            "RAD","RAD","REB","REB","REB",
                                            "REF","REF","REL","REU","ROM",
                                            "ROU","RUS","RUSCNY","RWA",
                                            "RWAGOVRPF","RWAUAFRPF","SAA","SAD",
                                            "SAF","SAM","SAS","SAU","SCG","SCG",
                                            "SCGKSV","SCGMTN","SCGSRB",
                                            "SCGVVD","SCN","SDN","SDNDFR",
                                            "SDNREBNDA","SDNREBSPL","SEA","SEN",
                                            "SENREBMDF","SER","SGP","SHI",
                                            "SHN","SHN","SIK","SIK","SJM","SLA",
                                            "SLB","SLE","SLEREBKAM",
                                            "SLEREBRUF","SLV","SMR","SNL","SOM",
                                            "SOT","SPM","SPY","SPY","SRB",
                                            "SRB","SRBKSV","SRBVVD","SRP","SSD",
                                            "STP","SUN","SUR","SVK","SVN",
                                            "SWE","SWZ","SYC","SYR","TAM",
                                            "TAM","TAO","TAO","TCA","TCD",
                                            "TER","TGO","THA","TJK","TKL",
                                            "TKM","TMP","TMP","TON","TRG",
                                            "TRK","TTO","TUN","TUR","TURANK",
                                            "TURGOVAKP","TURGOVANP","TURGOVCHP",
                                            "TURGOVDSP","TURGOVDYP",
                                            "TURGOVMHP","TURGOVREP","TURIST","TURIZM",
                                            "TUROPPAKP","TUROPPANP",
                                            "TUROPPCHP","TUROPPDSP","TUROPPDTP",
                                            "TUROPPDYP","TUROPPFAZ","TUROPPHDP",
                                            "TUROPPMHP","TUROPPREP","TURREBDSL",
                                            "TURREBPKK","TURSOE","TUT","TUV",
                                            "TWN","TZA","UAF","UAF","UER",
                                            "UGA","UGAREBADF","UGAREBLRA",
                                            "UIG","UIG","UIS","UKR","UNO",
                                            "UNR","URY","USA","USR","UZB",
                                            "VAT","VCT","VEN","VGB","VIR","VIR",
                                            "VNM","VNM","VUT","WAD","WAF",
                                            "WAS","WBK","WCT","WEF","WFP",
                                            "WHO","WLF","WSM","WST","WST",
                                            "WTO","XFM","YEM","YMN","YMS",
                                            "YUG","YUG","YUGBSN","YUGCTA",
                                            "YUGKSV","YUGMCD","YUGMTN","YUGSLN",
                                            "YUGSRB","YUGVVD","ZAF","ZMB",
                                            "ZRO","ZWE"),
                                   name = c("ethnic Albanian",
                                            "Aruba","Arab Cooperation Council",
                                            "Asian Development Bank",
                                            "Association of Southeast Asian Nations Defense Ministers",
                                            "Arab Economic Unity Council","African Development Bank",
                                            "Afghanistan","Taliban (d.r.)",
                                            "Taliban (d.r.)","Africa","African Union",
                                            "Angola","Cabinda Enclave",
                                            "National Union for the Total Independence of Angola (UNITA)",
                                            "Agriculture (secondary role code)",
                                            "Agriculture-focused actors","Anguilla",
                                            "International Energy Agency",
                                            "˚Aland Islands","Albania","Al Qaeda",
                                            "Amnesty International",
                                            "Arab Maghreb Union","Andorra",
                                            "Netherlands Antilles",
                                            "Org of Arab Petroleum Exporting Countries","Arab (ethnic group)",
                                            "Arab","Baath Party",
                                            "United Arab Emirates","Argentina","Arab League",
                                            "Armenia","Asia (region)","Asia",
                                            "Abu Sayyaf","American Samoa",
                                            "Association of Southeast Asian Nations","Antigua and Barbuda",
                                            "Agnostic/Atheist","Atheist/Agnostic",
                                            "Australia","Austria","Azerbaijan",
                                            "Bahai",
                                            "Bank of Central African States","Burundi","Belgium","Benin",
                                            "Burkina Faso","Bangladesh",
                                            "Bulgaria","Bahrain","Bahamas",
                                            "Bosnia and Herzegovina (d.r.)",
                                            "Bosnia and Herzegovina",
                                            "Bosniak/Croat Federation of Bosnia and Herzegovina (d.r.)",
                                            "Bosnian Serb Republika Srpska (d.r.)",
                                            "Bank for International Settlements","Balkans","Belarus",
                                            "Belize","Bermuda","Bolivia","Brazil",
                                            "Barbados","Brunei Darussalam",
                                            "Bhutan","Buddhist","Buddhism",
                                            "Business (secondary role code)",
                                            "Business (NOT MNCs)","Business",
                                            "Botswana","Central African Republic",
                                            "Canada","Central Asia","Caucasus",
                                            "Cmn Mrkt for East and Southern Africa","Central Europe",
                                            "Central Africa","Switzerland","Chile","China",
                                            "Tibet","Christian",
                                            "Christianity","Coptic","Catholic","Orthodox",
                                            "Jehovah’s Witnesses",
                                            "Latter Day Saints","Maronite","Protestant",
                                            "“fundamentalist” Christian",
                                            "Commonwealth of Independent States",
                                            "Cte d’Ivoire (Ivory Coast)",
                                            "Cote d'Ivoire","Communist Party","Cameroon",
                                            "Chechnya",
                                            "Democratic Republic of the Congo (Kinshasa)",
                                            "Congo, Democratic Republic of",
                                            "Council of Europe",
                                            "People’s Republic of the Congo (Brazzaville)",
                                            "Congo, Republic of","Cook Islands","Colombia",
                                            "Columbia","Comoros","Confucian",
                                            "Confucianism",
                                            "Law enforcement agencies",
                                            "Association of Coffee Producing States","Cape Verde","Caribbean",
                                            "Costa Rica",
                                            "Criminal (secondary role code)","Criminal actors",
                                            "ethnic Croat","Czechoslovakia",
                                            "Community of Sahel-Saharan States",
                                            "Catholic","Cuba",
                                            "Civilian (secondary role code)","Civilians",
                                            "Civilian individuals/groups",
                                            "Commonwealth of Nations","Cayman Islands",
                                            "Cyprus","Greek Cypriot",
                                            "Turkish Cypriot","Czechoslovakia",
                                            "Czech Republic","East Germany","Germany",
                                            "Development (secondary role code)",
                                            "Development-focused actors","Djibouti",
                                            "Dominica","Denmark",
                                            "Dominican Republic","Algeria",
                                            "National Liberation Front (FLN)",
                                            "Movement of the Society for Peace",
                                            "Democratic National Rally","Ennahda Movement",
                                            "Islamic Salvation Front",
                                            "National Liberation Front (FLN)",
                                            "Movement of the Society for Peace",
                                            "Islamic Salvation Army",
                                            "Armed Islamic Group (GIA)","Salafist Group",
                                            "East African Community","Eastern Africa",
                                            "European Bank for Reconstruct and Dev","Ecuador",
                                            "Education (secondary role code)",
                                            "Education-focused actors","European Union",
                                            "Eastern Europe",
                                            "European Free Trade Association","Egypt","Muslim Brotherhood",
                                            "East Indies (region)",
                                            "East Indies","Elites (secondary role code)",
                                            "Elites, celebrities",
                                            "Environment (secondary role code)",
                                            "Environment-focused actors","Environmental",
                                            "Eritrea","Western Sahara","Spain",
                                            "Basque","Estonia","Ethiopia",
                                            "Europe",
                                            "International Federation of Human Rights","Finland","Fiji",
                                            "Falkland Islands (Malvinas)",
                                            "Falkland Islands","France",
                                            "Faeroe Islands",
                                            "Federal Republic of Yugoslavia","Kosovo (d.r.)",
                                            "Montenegro (d.r.)","Serbia (d.r.)",
                                            "Vojvodina (d.r.)","Micronesia",
                                            "Micronesia, Federated States of","Gabon",
                                            "United Kingdom","Irish Republican Army",
                                            "Georgia","Guernsey","Ghana",
                                            "Gibraltar","Guinea","Guadeloupe",
                                            "Gambia",
                                            "Democratic Republic of Germany (East Berlin)",
                                            "Federal Republic of Germany (Bonn)","Guinea-Bissau",
                                            "Equatorial Guinea",
                                            "Group of seven","Government (primary role code",
                                            "Government","Greece","Grenada",
                                            "Greenland","Guatemala",
                                            "French Guiana","Guam","Guyana","Gypsy",
                                            "Gaza Strip",
                                            "UN High Commission for Human Rights",
                                            "UN High Commission for Refugees","Hindu","Hinduism",
                                            "Hong Kong (Special Administrative Region of China)","Hong Kong",
                                            "Health (secondary role code)",
                                            "Health-focused actors","Hamas","Honduras",
                                            "Human rights-focused actors",
                                            "Croatia (d.r.)","Croatia",
                                            "Human Rights Watch","Haiti","Hungary",
                                            "Hutu (ethnic group)",
                                            "Intergovernmental Auth. on Development",
                                            "International Atomic Energy Agency",
                                            "International Criminal Court",
                                            "International Crisis Group",
                                            "International Court of Justice",
                                            "International Cocoa Organization",
                                            "Islamic Development Bank","Indonesia",
                                            "International Grains Council",
                                            "Inter-governmental organizations",
                                            "Inter-Government Organizations","African Union",
                                            "Inter-African Coffee Organization (IACO)",
                                            "Common Market for Eastern and Southern Africa",
                                            "Franc Zone Financial Community of Africa",
                                            "African Development Bank",
                                            "Eastern and Southern African Trade and Development Bank",
                                            "New Economic Partnership for Africa’s Development",
                                            "Organization of African Unity (OAU)",
                                            "Pan African Parliament",
                                            "Cocoa Producer’s Alliance",
                                            "Association of Coffee Producing Countries",
                                            "International Cocoa Organization (ICCO)",
                                            "International Grains Council",
                                            "Organization of Arab Petroleum Exporting Countries (OAPEC)",
                                            "Arab Bank for Economic Development in Africa",
                                            "Bank for International Settlements",
                                            "Group of Eight (G-8)","Group of Seven (G-7)",
                                            "Group of Seventy-Seven (G-77)",
                                            "Highly Indebted Poor Countries (HIPC)",
                                            "International Monetary Fund (IMF)",
                                            "Organization of Petroleum Exporting Countries (OPEC)","Paris Club",
                                            "World Trade Organization (WTO)",
                                            "Bank of Central African States (BEAC)",
                                            "Monetary and Economic Community of Central Africa (CEMAC)",
                                            "Economic Community of Central African States",
                                            "Commonwealth of Independent States","Interpol",
                                            "Commonwealth of Nations",
                                            "Intergovernmental Authority on Development (IGAD)",
                                            "East African Community",
                                            "European Free Trade Association","Council of Europe",
                                            "European Bank for Reconstruction and Development","European Union",
                                            "Council of Security and Cooperation in Europe (OSCE)",
                                            "International Criminal Court",
                                            "Inter-Parliamentary Union","Arab Cooperation Council",
                                            "Arab Economic Unity Council",
                                            "Arab Monetary Fund for Economic and Social Development","Arab Maghreb Union",
                                            "Arab League",
                                            "Islamic Development Bank",
                                            "Organization of Islamic Conferences (OIC)",
                                            "Community of Sahel-Saharan States (CENSAD)",
                                            "Organization of Non-Aligned Countries",
                                            "Organization of American States",
                                            "Gulf Cooperation Council",
                                            "Peacekeeping force (organization unknown)",
                                            "Southern African Development Community",
                                            "South Asian Association",
                                            "Association of Southeast Asian Nations (ASEAN)","Asian Development Bank",
                                            "Southeast Asia Collective Defense Treaty (SEATO)","United Nations",
                                            "United Nations Food and Agriculture Organization",
                                            "International Energy Agency","The World Bank",
                                            "World Health Organization (WHO)",
                                            "United Nations High Commission for Human Rights (OHCHR)",
                                            "International Atomic Energy Agency (IAEA)",
                                            "International Court of Justice (ICJ)",
                                            "International War Crimes Tribunals",
                                            "United Nations Children’s Fund (UNICEF)",
                                            "International Labor Organization",
                                            "United Nations High Commission for Refugees (OHCR)","World Food Program",
                                            "West Africa Monetary and Economic Union",
                                            "Economic and Monetary Union of West Africa (UEMOA)",
                                            "West Africa Development Bank",
                                            "Economic Community of West African States (ECOWAS)",
                                            "Western European Union",
                                            "North Atlantic Treaty Organization (NATO)",
                                            "Internat. Helsinki Fed for Human Rights",
                                            "International Labor Organization","International Monetary Fund",
                                            "International Militarized Group",
                                            "Al Qaeda","Abu Sayyaf",
                                            "Jemaah Islamiya","Isle of Man","India",
                                            "Indian-controlled Kashmir",
                                            "Insurgents",
                                            "Ambiguous international or transnational actor",
                                            "Inter-Parliamentary Union",
                                            "International Red Cross","Ireland","Iran","Iraq",
                                            "Baghdad",
                                            "Kurdish Democratic Party (KDP)","ISIS/ISIL","Iceland","Israel",
                                            "Israeli Communist Party (d.r.)",
                                            "Israeli Labor Party (d.r.)",
                                            "Likud Party (d.r.)","Meretz Party (d.r.)",
                                            "Shas Party (d.r.)",
                                            "Israeli Labor Party (d.r.)",
                                            "Likud Party (d.r.)","Meretz Party (d.r.)",
                                            "Shas Party (d.r.)","Israeli Settlers",
                                            "Italy","Interpol","Jamaica","Jain",
                                            "Jainism","Jew","Judaism",
                                            "Hasidic Jew","Ultra-Orthodox Jew",
                                            "Jemaah Islamiya","Jordan",
                                            "Islamic Action Front","Japan",
                                            "Judiciary (primary role code)","Judicial actors",
                                            "International Commission of Jurists",
                                            "Kashmir","Kazakhstan","Kenya",
                                            "Kyrgyzstan","Cambodia",
                                            "Khmer Rouge",
                                            "United Nations Children's Fund","Kiribati","Saint Kitts-Nevis",
                                            "Saint Kitts and Nevis",
                                            "Republic of Korea (Seoul)",
                                            "Korea, Republic of","Kosovo","Kurd (ethnic group)",
                                            "Kuwait",
                                            "Labor (secondary role code)","Labor-focused actors",
                                            "Latin America","Laos","Lebanon",
                                            "Amal Militia","South Lebanon Army",
                                            "Hezbullah","Liberia","Bomi (Liberia)",
                                            "Bong (Liberia)",
                                            "Grand Cape Mount (Liberia)",
                                            "Grand Bassa (Liberia)","Grand Gedeh (Liberia)",
                                            "Liberia Action Party (d.r.)",
                                            "National Democratic Party of Liberia (d.r.)",
                                            "National Patriotic Front of Liberia (NPFL) (d.r.)",
                                            "United People’s Party (d.r.)","Krahn (ethnic group)",
                                            "Grand Kru (Liberia)",
                                            "Lofa (Liberia)",
                                            "Mandingo, Mandingoe (ethnic group)","Montserrado (Liberia)",
                                            "Margibi (Liberia)","Maryland (Liberia)",
                                            "Nimba (Liberia)",
                                            "All Liberia Coalition Party",
                                            "Liberia Action Party (d.r.)","New Deal Movement",
                                            "National Democratic Party of Liberia (d.r.)",
                                            "United People’s Party (d.r.)","Armed Forces of Liberia (d.r.)",
                                            "Independent NPFL",
                                            "Liberia Peace Council",
                                            "Liberians United for Reconciliation and Democracy (LURD)",
                                            "National Patriotic Front of Liberia (NPFL) (d.r.)",
                                            "United Liberation Front for Democracy",
                                            "Rivercess (Liberia)","Sino (Liberia)","Libya",
                                            "Saint Lucia",
                                            "Legislature (secondary role code)",
                                            "Legislative bodies/actors","Liechtenstein","Sri Lanka",
                                            "People’s Liberation Front",
                                            "Lesotho","Lithuania","Luxembourg",
                                            "Latvia",
                                            "Macao (Special Administrative Region of China)","Morocco",
                                            "Polisario Guerillas","Monaco",
                                            "Moldova","Middle East","Madagascar",
                                            "Mediterranean","Maldives",
                                            "Middle East","Medical (secondary role code)",
                                            "Media-related actors/organizations","Mexico","Marshall Islands",
                                            "MIlitary (primary role code)",
                                            "Military","Macedonia","Mali","Malta",
                                            "Myanmar (Burma)","Myanmar",
                                            "Multi-national corporation",
                                            "Multinational Corporation","Montenegro",
                                            "Mongolia","Northern Mariana Islands",
                                            "Moderate (tertiary role code)",
                                            "Moderate/mainstream group","Muslim",
                                            "Islam","Alewi","Druze",
                                            "“Fundamentalist,” “radical,” “extremist” Muslim","Sufi","Shia","Sunni",
                                            "Mozambique","Mauritania",
                                            "Doctors Without Borders","Montserrat",
                                            "Montenegro","Martinique","Mauritius",
                                            "Malawi","Malaysia","Mayotte",
                                            "North Africa","Namibia",
                                            "North Atlantic Treaty Organization","New Caledonia",
                                            "Niger","Norfolk Island",
                                            "Nigeria","Abia (Nigeria)",
                                            "Abuja (Nigeria)","Adamawa (Nigeria)",
                                            "Akwa Ibom (Nigeria)","Anambra (Nigeria)",
                                            "Bauchi (Nigeria)",
                                            "Bayelsa (Nigeria)","Biafra (Nigeria)",
                                            "Benue (Nigeria)","Borno (Nigeria)",
                                            "Cross River (Nigeria)","Delta (Nigeria)",
                                            "Edo (Nigeria)","Ekiti (Nigeria)",
                                            "Enugu (Nigeria)","Gombe (Nigeria)",
                                            "Hausa (ethnic group)",
                                            "Ibo, Igbo (ethnic group)",
                                            "Ijaws (ethnic group)","Imo (Nigeria)",
                                            "Jigawa (Nigeria)","Kaduna (Nigeria)",
                                            "Kano (Nigeria)","Katsina (Nigeria)",
                                            "Kebbi (Nigeria)","Kogi (Nigeria)",
                                            "Kwara (Nigeria)","Lagos (Nigeria)",
                                            "Nassarawa (Nigeria)",
                                            "Niger Delta Region (Nigeria)","Niger (Nigeria)",
                                            "North Nigeria (Nigeria)",
                                            "Ogoni (ethnic group)","Ogun (Nigeria)",
                                            "Ondo (Nigeria)",
                                            "All Nigeria People’s Party","Campaign for Democracy",
                                            "National Democratic Coalition of Nigeria (NADECO)","Osun (Nigeria)",
                                            "Oyo (Nigeria)","Plateu State (Nigeria)",
                                            "Movement for the Advancement of Democracy (MAD)","Rivers (Nigeria)",
                                            "Sokoto (Nigeria)",
                                            "Taraba (Nigeria)","Tiv (ethnic group, language)",
                                            "Yobe (Nigeria)",
                                            "Yoruba (ethnic group)","Zamfara (Nigeria)",
                                            "Non-governmental movements","Greenpeace",
                                            "Non-governmental organizations",
                                            "Non-Governmental Organization",
                                            "Christian Solidarity International",
                                            "International Fed. of Red Cross and Red Crescent (ICRC)","Red Cross",
                                            "Medecins Sans Frontieres (Doctors Without Borders)","Red Crescent",
                                            "Amnesty International",
                                            "International Federation of Human Rights (FIDH)",
                                            "Human Rights Watch",
                                            "International Helsinki Federation for Human Rights","International Crisis Group",
                                            "International Commission of Jurists",
                                            "International Organization for Migration","Union of Arab Journalists",
                                            "World Economic Forum","Oxfam",
                                            "Nicaragua","Niue","Niue Island",
                                            "Netherlands","North America",
                                            "Norway","Nepal","Nauru","New Zealand",
                                            "Organization of American States",
                                            "Organization of African Unity",
                                            "Occupied",
                                            "International Cocoa Organization","Oman",
                                            "Org. of Petroleum Exporting Countries",
                                            "Opposition (primary role code)",
                                            "Opposition groups (often parliamentary)",
                                            "Animist/Pagan","Pakistan",
                                            "Pakistani-controlled Kashmir","Palestinian",
                                            "Palestine Liberation Organization",
                                            "Abu Nidal Organization",
                                            "Palestine Liberation Front","Panama","Pitcairn",
                                            "Peru","Persian Gulf",
                                            "Philippines","Palau","Papua New Guinea",
                                            "Bougainville","Poland","Papel",
                                            "Puerto Rico",
                                            "Democratic People’s Rep. of Korea (Pyongyang)",
                                            "Korea, Democratic People's Republic of",
                                            "Protestant","Portugal","Paraguay",
                                            "Palestinian Occupied Territories",
                                            "Palestine","Fatah (d.r.)",
                                            "Hamas (d.r.)","Gaza Strip",
                                            "Al Aqsa Martyrs Brigade",
                                            "Democratic Front for the Liberation of Palestine (DFLP)",
                                            "Hamas (d.r.)",
                                            "Palestinian Islamic Jihad",
                                            "People’s Front for the Liberation of Palestine (PFLP)",
                                            "West Bank","Political party",
                                            "French Polynesia","Qatar",
                                            "Radical (tertiary role code)",
                                            "Radical/extremist/fundamentalist",
                                            "Rebel (primary role code)","Rebels/insurgents",
                                            "Rebel / insurgents",
                                            "Refugee (secondary role code)","Refugee-focused actors",
                                            "Unspecified religious","Runion",
                                            "Romania","Romania","Russia",
                                            "Chechnya","Rwanda",
                                            "Rwandan Patriotic Front (d.r.)",
                                            "Rwandan Patriotic Front (d.r.)",
                                            "South Asian Association",
                                            "Southern African Development Community","Southern Africa",
                                            "South America","South Asia",
                                            "Saudi Arabia","Serbia and Montenegro (d.r.)",
                                            "Serbia and Montenegro",
                                            "Kosovo (d.r.)","Montenegro (d.r.)",
                                            "Serbia (d.r.)","Vojvodina (d.r.)",
                                            "Scandinavia","Sudan","Darfur",
                                            "National Democratic Alliance",
                                            "Sudan People’s Liberation Army","Southeast Asia",
                                            "Senegal",
                                            "Movement of Democratic Forces of Casamance","ethnic Serb",
                                            "Singapore","Shia",
                                            "Saint Helena","Shintoism","Sikh","Sikhism",
                                            "Svalbard and Jan Mayen Islands",
                                            "Slav","Solomon Islands",
                                            "Sierra Leone","Kamojor militia",
                                            "Revolutionary United Front","El Salvador",
                                            "San Marino","Sinhalese (ethnic group)",
                                            "Somalia",
                                            "SE Asia Collective Defense Treaty",
                                            "Saint Pierre and Miquelon","Spy (primary role code)",
                                            "Intelligence agencies",
                                            "Serbia (d.r.)","Serbia","Kosovo (d.r.)",
                                            "Vojvodina (d.r.)","Republica Srpska",
                                            "South Sudan",
                                            "Sao Tome and Principe","Soviet Union","Suriname",
                                            "Slovakia","Slovenia","Sweden",
                                            "Swaziland","Seychelles","Syria",
                                            "Tamil (ethnic group)","Tamil","Taoist",
                                            "Taoism","Turks and Caicos Islands",
                                            "Chad",
                                            "Terai (region in northern India/southern Nepal)","Togo",
                                            "Thailand","Tajikistan","Tokelau",
                                            "Turkmenistan",
                                            "East Timor (Timor-Leste)","East Timor","Tonga",
                                            "Tuareg (ethnic group)","ethnic Turk",
                                            "Trinidad and Tobago","Tunisia",
                                            "Turkey","Ankara",
                                            "Justice and Development Party (AKP) (d.r.)",
                                            "Motherland Party (ANAP) (d.r.)",
                                            "Republican People’s Party (CHP) (d.r.)",
                                            "Democratic Left Party (DSP) (d.r.)",
                                            "True Path Party (DYP) (d.r.)",
                                            "National Action Party (MHP) (d.r.)",
                                            "Welfare Party (Refah) (d.r.)","Istanbul",
                                            "Izmir",
                                            "Justice and Development Party (AKP) (d.r.)",
                                            "Motherland Party (ANAP) (d.r.)",
                                            "Republican People’s Party (CHP) (d.r.)",
                                            "Democratic Left Party (DSP) (d.r.)",
                                            "Democratic Society Party (DTP)",
                                            "True Path Party (DYP) (d.r.)",
                                            "Virtue Party (Fazilet)",
                                            "Democratic People’s Party (DEHAP/HADEP)",
                                            "National Action Party (MHP) (d.r.)",
                                            "Welfare Party (Refah) (d.r.)","Dev-Sol",
                                            "Kurdistan Workers’ Party (PKK)",
                                            "Southeast Turkey","Tutsi (ethnic group)",
                                            "Tuvalu","Taiwan","Tanzania",
                                            "Unidentified Armed Force (tertiary role code)","Unaffiliated armed forces",
                                            "International Academy of Architecture","Uganda",
                                            "Allied Democratic Forces","Lord’s Resistance Army",
                                            "Uighur (Chinese ethnic minority)",
                                            "Uighur","Unidentified state actors",
                                            "Ukraine","United Nations",
                                            "Unrecognized","Uruguay","United States",
                                            "Union of Soviet Socialist Republics (USSR)","Uzbekistan",
                                            "Holy See (Vatican City)",
                                            "Saint Vincent and the Grenadines","Venezuela",
                                            "British Virgin Islands",
                                            "U.S. Virigin Islands","U.S. Virgin Islands",
                                            "Vietnam","Viet Nam","Vanuatu",
                                            "West African Development Bank","West Africa",
                                            "Econ Community of West African States","World Bank",
                                            "International War Crimes Tribunals",
                                            "World Economic Forum","World Food Program",
                                            "World Health Organization",
                                            "Wallis and Futuna Islands","Samoa",
                                            "“the West”","the West",
                                            "World Trade Organization","Oxfam","Yemen",
                                            "North Yemen","South Yemen",
                                            "Socialist Federal Republic of Yugoslavia (d.r.)",
                                            "Yugoslavia",
                                            "Yugoslavia’s Republic of Bosnia (d.r.)",
                                            "Yugoslavia’s Republic of Croatia (d.r.)",
                                            "Kosovo (d.r.)",
                                            "Yugoslavia’s Republic of Macedonia (d.r.)",
                                            "Montenegro (d.r.)",
                                            "Yugoslavia’s Republic of Slovenia (d.r.)",
                                            "Yugoslavia’s Republic of Serbia (d.r.)","Vojvodina (d.r.)",
                                            "South Africa","Zambia",
                                            "Zoroastrian","Zimbabwe")
                     )
  
cameo_actor_codes <- cameo_actor_codes %>% filter(!duplicated(code)) %>% 
  mutate(name = name %>% 
           str_replace_all("\\(secondary role code\\)|\\(primary role code\\)","") %>% 
           str_replace_all("\\(secondary role code\\)|\\(secondary role code|\\(primary role code|\\(primary role code\\)","")   %>% 
           str_replace_all(" \\)","")   %>% 
           trimws()
         )
dim(cameo_actor_codes)

```


```{r ICB Data Loads , eval=T, results='hide', echo=F, include=T, message=F, cache=F}
#ICB Data Loads

#Note yemen 679 doesn't show up in this data
icb_df <- data.frame(
  stringsAsFactors = FALSE,
          icb_name = c("Afghanistan","Albania",
                       "Algeria","Andorra","Angola","Antigua & Barbuda",
                       "Argentina","Armenia","Australia","Austria","Azerbaijan",
                       "Bahamas","Bahrain","Bangladesh","Barbados","Belarus",
                       "Belgium","Belize","Benin (Dahomey)","Bhutan","Bolivia",
                       "Bosnia","Botswana","Brazil","Brunei","Bulgaria",
                       "Burkina Faso (Upper Volta)","Burma (see Myanmar)",
                       "Burundi","Cambodia","Cameroon","Canada","Cape Verde",
                       "Central African Republic","Chad","Chile","China",
                       "China","Colombia","Comoros","Congo Brazzaville",
                       "Congo, Democratic","Costa Rica","Cote D’Ivoire","Croatia",
                       "Cuba","Cyprus","Czech Republic","Czechoslovakia",
                       "Dahomey (see Benin)","Denmark","Djibouti (Somalia Fr.)",
                       "Dominica","Dominican Republic","Ecuador","Egypt (UAR)",
                       "El Salvador","Equatorial Guinea","Eritrea","Estonia",
                       "Ethiopia","Federated States of Micronesia","Fiji",
                       "Finland","Formosa","France","French West Africa",
                       "Gabon","Gambia","Georgia",
                       "German Democratic Republic (East Germany)",
                       "Germany (German Federal Republic, West Germany)","Germany (Prussia)","Ghana",
                       "Great Britain (see United Kingdom)","Greece","Grenada","Guatemala",
                       "Guinea","Guinea Bissau","Guyana","Haiti","Hijaz (Hejaz)",
                       "Honduras","Hungary","Iceland","India","Indonesia",
                       "Iran","Iraq","Ireland (Eire)","Israel","Italy",
                       "Ivory Coast (see Cote D’Ivoire)","Jamaica","Japan",
                       "Jordan","Kazakhstan","Kenya","Korea","Kosovo","Kuwait",
                       "Kyrgyz Republic","Laos","Latvia","Lebanon","Lesotho",
                       "Liberia","Libya","Liechtenstein","Lithuania",
                       "Luxemberg","Macedonia","Madagascar (Malagasy Republic)",
                       "Malawi","Malaysia","Maldives","Mali","Malta",
                       "Marshall Islands","Mauritania","Mauritius","Mexico","Moldova",
                       "Monaco","Mongolia","Morocco","Mozambique",
                       "Myanmar (Burma)","Najd (Nejd)","Namibia (South West Africa)",
                       "Nepal","Netherlands","Nevis","New Zealand",
                       "Nicaragua","Niger","Nigeria",
                       "North Korea (People’s Republic of Korea)","Norway","Oman","Pakistan","Palau","Panama",
                       "Papua and New Guinea","Paraguay","Peru",
                       "Philippines","Poland","Portugal","Principe","Qatar",
                       "Republic of (Congo Kinshasa) (Zaire)","Rhodesia (see Zimbabwe)",
                       "Rumania","Russia (Soviet Union)","Rwanda",
                       "San Marino","Sao Tome","Saudi Arabia","Senegal",
                       "Serbia (see Yugoslavia)","Seychelles","Sierra Leone","Singapore",
                       "Slovakia","Slovenia","Solomons","Somalia",
                       "Somalia Fr. (see Djibouti)","South Africa",
                       "South Korea (Republic of Korea)","South Sudan",
                       "South West Africa (see Namibia)","Spain","Spanish Sahara (see Western Sahara)",
                       "Sri Lanka (Ceylon)","St. Kitts","St. Lucia",
                       "St. Vincent & The Grenadines","Sudan","Surinam","Swaziland",
                       "Sweden","Switzerland","Syria","Taiwan (China",
                       "Tajikistan","Tanzania","Thailand","Tibet","Togo",
                       "Trinidad & Tobago","Tunisia","Turkey","Turkmenistan","Uganda",
                       "Ukraine","United Arab Emirates",
                       "United Kingdom (Great Britain)","Upper Volta (see Burkina Faso)","Uruguay",
                       "USA","USSR (see Russia)","Uzbekistan","Vanuatu",
                       "Venezuela","Vichy France",
                       "Vietnam, Democratic Republic of (North Vietnam)","Vietnam, Republic of (South Vietnam)",
                       "Western Sahara (Spanish Sahara)","Western Samoa",
                       "Yemen (Arab Republic of Yemen, North Yemen)",
                       "Yemen, People’s Republic of (South Yemen)","Yugoslavia (Serbia)",
                       "Zambia","Zanzibar","Zimbabwe (Rhodesia)"),
       icb_letters = c("AFG","ALB","ALG","AND",
                       "ANG","AAB","ARG","ARM","AUL","AUS","AZE","BHM",
                       "BAH","BNG","BAR","BLR","BEL","BLZ","BEN","BHU","BOL",
                       "BOS","BOT","BRA","BRU","BUL","BFO",NA,"BUI",
                       "CAM","CAO","CAN","CAP","CEN","CHA","CHL",NA,"CHN",
                       "COL","COM","CON","DRC","COS","CDI","CRO","CUB",
                       "CYP","CZR","CZE",NA,"DEN","DJI","DMA","DOM",
                       "ECU","EGY","SAL","EQG","ERI","EST","ETH","FSM","FIJ",
                       "FIN","TAW","FRN","FWA","GAB","GAM","GRG","GDR",
                       "GFR","GMY","GHA",NA,"GRC","GRN","GUA","GUI",
                       "GNB","GUY","HAI","HIJ","HON","HUN","ICE","IND",
                       "INS","IRN","IRQ","IRE","ISR","ITA",NA,"JAM","JPN",
                       "JOR","KZK","KEN","KOR","KOS","KUW","KYR","LAO",
                       "LAT","LEB","LES","LBR","LIB","LIE","LIT","LUX",
                       "MAC","MAG","MAW","MAL","MAD","MLI","MLT","MSI",
                       "MAA","MAS","MEX","MLD","MNC","MON","MOR","MZM","MYA",
                       "NAJ","NAM","NEP","NTH","SKN","NEW","NIC","NIR",
                       "NIG","PRK","NOR","OMA","PAK","PAL","PAN","PNG",
                       "PAR","PER","PHI","POL","POR","STP","QAT","DRC",
                       NA,"RUM","RUS","RWA","SNM",NA,"SAU","SEN",NA,
                       "SEY","SIE","SIN","SLO","SLV","SOL","SOM",NA,"SAF",
                       "ROK","SSD",NA,"SPN",NA,"SRI",NA,"SLU","SVG",
                       "SUD","SUR","SWA","SWD","SWZ","SYR",NA,"TAJ","TAZ",
                       "THI","TBT","TOG","TRI","TUN","TUR","TKM","UGA",
                       "UKR","UAE","UKG",NA,"URU","USA",NA,"UZB","VAN",
                       "VEN","VFR","DRV","RVN","SPA","WSM","YEM","YPR",
                       "YUG","ZAM","ZAN","ZIM"),
          icb_code = c("700","339","615","232",
                       "540","058","160","371","900","305","373","031",
                       "692","771","053","370","211","080","434","760","145",
                       "346","571","140","835","355","439",NA,"516",
                       "811","471","020","402","482","483","155",NA,"710",
                       "100","581","484","490","094","437","344","040",
                       "352","316","315",NA,"390","522","054","042",
                       "130","651","092","411","531","366","530","987","950",
                       "375","713","220","480","481","420","372","265",
                       "260","255","452",NA,"350","55","090","438",
                       "404","110","041","671","091","310","395","750","850",
                       "630","645","205","666","325",NA,"051","740",
                       "663","705","501","730","347","690","703","812",
                       "367","660","570","450","620","223","368","212",
                       "343","580","553","820","781","432","338","983","435",
                       "590","070","359","221","712","600","541","775",
                       "672","565","790","210","060","920","093","436",
                       "475","731","385","698","770","986","095","910",
                       "150","135","840","290","235","403","694","490",NA,
                       "360","365","517","331",NA,"670","433",NA,"591",
                       "451","830","317","349","940","520",NA,"560",
                       "732","626",NA,"230",NA,"780",NA,"056","057","625",
                       "115","572","380","225","652",NA,"702","510",
                       "800","711","461","052","616","640","701","500",
                       "369","696","200",NA,"165","002",NA,"704","935",
                       "101","219","816","817","605","990","678","680",
                       "345","551","511","552")
)

df_IWCA <- data.frame(
  stringsAsFactors = FALSE,
              IWCA = c(1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L),
        IWCA_label = c("not an intra-war crisis (IWC)",
                       "Entry of a major actor into an ongoing war",
                       "Perceived high probability of a major actor entering a war",
                       "Exit of a major actor",
                       "Perceived high probability of major power exiting a war",
                       "Technological escalation of a war","Major non-technological escalation",
                       "Defeat in a significant battle","Internal deterioration","Other")
)

df_break <- 
data.frame(
  stringsAsFactors = FALSE,
             BREAK = c(1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L),
       BREAK_label = c("Verbal act","Political act",
                       "Economic act","External change",
                       "Other non-violent act",
                       "Internal verbal or physical challenge to regime or elite","Non-violent military act","Indirect violent act",
                       "Violent act")
)


#icbdy_20 <- read_tsv(here::here(), "/replication_paper/data/in/icbdy_20.dat")
icbdy_20 <- readRDS(paste0(here::here(), '/replication_paper/data/in/icbdy_20.Rds'))

icbdy_20_clean <- icbdy_20 %>%
                  left_join( icb_df %>% dplyr::select(STATEA=icb_code, actor_1=icb_name ) %>% mutate(STATEA=STATEA %>% as.numeric())  ) %>%
                  left_join( icb_df %>% dplyr::select(STATEB=icb_code, actor_2=icb_name ) %>% mutate(STATEB=STATEB %>% as.numeric())  ) %>%
                  left_join(df_IWCA %>% dplyr::select(IWCA=IWCA, IWCA_label=IWCA_label )  ) %>%
                  left_join(df_IWCA %>% dplyr::select(IWCB=IWCA, IWCB_label=IWCA_label )  )  

icb_diadic <- icbdy_20_clean %>% dplyr::select(CRISNO, NAMEA, NAMEB,  STATEA, STATEB, actor_1,actor_2, IWCA_label,IWCB_label) #%>% filter(is.na(actor_1) | is.na(actor_2))


icb2v14 <- read_csv(paste0(here::here(), "/replication_paper/data/in/icb2v14.csv"))


df_trigger <- data.frame(
  stringsAsFactors = FALSE,
            triggr = c(1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L),
                    triggr_label = c("Verbal act","Political act","Economic act",
                                     "External change","Other non-violent act",
                                     "Internal verbal or physical challenge to regime or elite",
                                     "Non-violent military act","Indirect violent act","Violent act")
              )

df_majres <- data.frame(
  stringsAsFactors = FALSE,
            majres = c(1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L),
                   majres_label = c("No response-inaction","Verbal act",
                                    "Political act","Economic act",
                                    "Other non-violent act",
                                    "Non-violent military act",
                                    "Multiple including non-violent military act",
                                    "Violent military act",
                                    "Multiple including violent military act")
             )

df_outcome <- 
data.frame(
  stringsAsFactors = FALSE,
            outcom = c(1L, 2L, 3L, 4L, 5L),
      outcom_label = c("Victory", "Compromise", "Stalemate", "Defeat", "Other")
)

df_outfor <- 
data.frame(
  stringsAsFactors = FALSE,
            outfor = c(1L,2L,3L,4L,5L,6L,7L,8L,
                       9L,10L,11L,12L,13L,14L,15L),
      outfor_label = c("Formal agreement - voluntary",
                       "Semi-formal agreement - voluntary",
                       "Tacit understanding","Unilateral - self","Unilateral - ally",
                       "Unilateral - adversary","Compliance","Imposed - imposer",
                       "Imposed - imposee","Spillover",
                       "Other - global organization intervention","Other - ally",
                       "Other - internal or non-state actor","Other - misc.","Faded")
)

icb2v14_clean <- icb2v14 %>% 
                 left_join(icb_df %>% dplyr::select(cracid=icb_code, actor_label=icb_name ) %>% mutate(cracid=cracid %>% as.numeric()) ) %>%  #you can't actually match on the letter codes you have to match on the numbers, uhhhhhg
                 left_join( df_trigger  ) %>% 
                 left_join( df_majres ) %>% 
                 left_join( df_outcome ) %>% 
                 left_join( df_outfor )

icb_monadic <-  
  bind_rows(
   icb2v14_clean%>% mutate(sent= yrtrig + tidyr::replace_na((motrig/12),0) + tidyr::replace_na(datrig/31/12,0) ) %>% mutate(type='start') %>% dplyr::select(year=yrtrig, month=motrig, crisno,type, sent, actor_label, leaf=triggr_label),
   icb2v14_clean %>% mutate(sent= yerres + tidyr::replace_na((monres/12),0) + tidyr::replace_na(dayres/31/12,0) ) %>% mutate(type='mid') %>% dplyr::select(year=yerres, month=monres, crisno,type, sent, actor_label, leaf=majres_label),
   icb2v14_clean %>% mutate(sent= yrterm + tidyr::replace_na((moterm/12),0) + tidyr::replace_na(daterm/31/12,0) ) %>% mutate(type='end') %>% dplyr::select(year=yrterm, month=moterm, crisno,type, sent, actor_label, leaf=outfor_label)
  ) %>% as.data.frame()


```

```{r icb crisis maps, eval=T, results='hide', echo=F, include=T, message=F, cache=F}

library(igraph)
library(ggraph)
#ICB Function {Plots
icb_crisismaps <- function(thiscrisis=196, prune_rare=T){
      
    print(thiscrisis)
    save_icb_file <- paste0(here::here(), "/replication_paper/pnas_draft/p_icb_metro_plot_",thiscrisis,".Rds")
  
    icb_diadic_subset <- icb_diadic %>% filter(CRISNO==thiscrisis) #Not all of them are diadic apparently
    icb_monadic_subset <- icb_monadic %>% rename(actor=actor_label) %>% filter(crisno==thiscrisis) %>%
                       mutate(sent=sent %>% rank() %>% round()) %>% mutate(actor_sent= actor %>% paste0("_", str_pad(sent, 2, pad = "0") ))   %>% arrange(sent, actor)

    g <- make_empty_graph(n = 0, directed = TRUE)
      #graph_from_data_frame(vertices=nodes) #relations, directed=TRUE, 
    
    icb_events_subset_diad <- bind_rows(
            icb_diadic_subset %>% dplyr::select(actor_1,actor_2) %>% left_join(icb_monadic_subset %>% filter(type=="start") %>% 
                                                                                 mutate(actor_1=actor) %>% dplyr::select(year, month,sent, actor_1,leaf) ) %>%
              rename(actor_2=actor_1,actor_1=actor_2),
            icb_diadic_subset %>% dplyr::select(actor_1,actor_2) %>% left_join(icb_monadic_subset %>% filter(type=="start") %>%
                                                                                 mutate(actor_2=actor) %>% dplyr::select(year, month,sent, actor_2,leaf) ),
            
            icb_diadic_subset %>% dplyr::select(actor_1,actor_2) %>% left_join(icb_monadic_subset %>% filter(type=="mid") %>%
                                                                                 mutate(actor_1=actor) %>% dplyr::select(year, month,sent, actor_1,leaf) ) %>%
              rename(actor_2=actor_1,actor_1=actor_2),
            icb_diadic_subset %>% dplyr::select(actor_1,actor_2) %>% left_join(icb_monadic_subset %>% filter(type=="mid") %>% 
                                                                                 mutate(actor_2=actor) %>% dplyr::select(year, month,sent, actor_2,leaf) ),
            
            icb_diadic_subset %>% dplyr::select(actor_1,actor_2) %>% left_join(icb_monadic_subset %>% filter(type=="end") %>% 
                                                                                 mutate(actor_1=actor) %>% dplyr::select(year, month,sent, actor_1,leaf) ) %>%
              rename(actor_2=actor_1,actor_1=actor_2),
            icb_diadic_subset %>% dplyr::select(actor_1,actor_2) %>% left_join(icb_monadic_subset %>% filter(type=="end") %>% 
                                                                                 mutate(actor_2=actor) %>% dplyr::select(year, month,sent, actor_2,leaf) ),
          
          ) %>% dplyr::select(year, month,sent, actor_1, actor_2, leaf) %>% distinct() %>% na.omit()
    
     if(nrow(icb_events_subset_diad)==0){
      print("No dyadic icb rows skipping")
      return()
    }
    
    #Order actors by how many interactions they have together
    temp <- icb_events_subset_diad  %>% dplyr::select(-year, -month) %>% arrange(actor_1, actor_2) %>% distinct()
    
    temp2 <- bind_rows(
      temp,
      temp %>% setNames(c("story_date", "actor_2", "actor_1" ))
    ) %>% count(actor_1, actor_2) %>% arrange(actor_1, actor_2) %>% arrange(n)
    
    temp2_wide <- temp2 %>% pivot_wider(id_cols=c(actor_1), names_from=actor_2, values_from=n) %>% mutate_if(is.numeric, tidyr::replace_na, 0) %>% as.data.frame()
    rownames(temp2_wide) <- temp2_wide$actor_1
    temp2_wide$actor_1 <- NULL
    temp2_wide <- temp2_wide %>% as.matrix()
    temp2_wide <- 1 - (temp2_wide/max(temp2_wide))
    temp2_wide <- temp2_wide[sort(rownames(temp2_wide)), sort(colnames(temp2_wide))]
    hc <- hclust(temp2_wide %>% as.dist(), method="single")
    
    temp_list <- list()
    for(i in 1:nrow(temp2_wide)){
      temp_list[[as.character(i)]] <- cutree(hc, k=i)
    }
    
    #ideal_ordering <- bind_rows(temp_list) %>% t() %>% as.data.frame() %>% apply(1, paste, collapse='') %>% sort() %>% names() #this will break with more than 9
    #  arrange(across(starts_with("V")))
    ideal_ordering <- hc$labels[hc$order] #There's a bug here, put all the isolated nodes by themselves first
    
    #####Nodes
    icb_events_subset_nodes <- 
              bind_rows(
                        icb_events_subset_diad %>% dplyr::select(year, month,sent=sent, actor=actor_1) ,
                        icb_events_subset_diad %>% dplyr::select(year, month,sent=sent, actor=actor_2) 
              ) %>% na.omit() %>% distinct()  %>% arrange(actor,sent) %>% mutate(actor_sent= actor %>% paste0("_", str_pad(sent, 2, pad = "0") )) %>% #don't na omit this one
              mutate(x=actor %>% factor(levels=actor %>% unique() %>% setdiff(ideal_ordering) %>% c(ideal_ordering)) %>% as.numeric() *100 ,
                     y=sent*-1 *100)
    
    #we centralize everything in qcodes so colors should be consistent across plots for the same actors    
    icbe_actor_to_qcode <- icb_events_long %>%
                       dplyr::filter(crisno==thiscrisis  ) %>% 
                       filter(varname_normalized %>% str_detect("actor")) %>% 
                       dplyr::select(value_normalized,value_qcode) %>% 
                       na.omit() %>% distinct()
  
    actor_colors_df <- icbe_actor_to_qcode %>%
      left_join(actor_translator %>% dplyr::select(value_qcode=QCode, actor_color))
    actor_colors <- actor_colors_df$actor_color
    names(actor_colors) = actor_colors_df$value_normalized
    
  
    actors=icb_events_subset_nodes$actor %>% unique() %>% as.factor()
    actor_colors = c(brewer.pal(n=11, "Dark2"), brewer.pal(n=11, "Set1"))[1:length(actors)] #ok so pick a bewer pallet with lots of values and then assign it to specific values
    names(actor_colors) = levels(actors)

    date_sineposts <- icb_events_subset_nodes  %>%
                        mutate(x=max(x)+50) %>%
                        dplyr::select(sent, point_in_time_year=year, point_in_time_month=month,x,y) %>%
                        na.omit() %>% 
                        distinct() %>%  
                        mutate(sent=as.numeric(sent)) %>% arrange(sent) %>%
                        mutate(year_float=point_in_time_year+(point_in_time_month/12)) %>%
                        group_by(sent) %>%
                        filter(year_float==min(year_float)) %>%
                        ungroup() %>% as.data.frame() %>%
                        filter( row_number()==1 |  ( year_float > lag(year_float)  ) )  %>%
                        filter(!duplicated(year_float ) ) %>%
                        mutate(label=paste0(point_in_time_year,"-",month.abb[point_in_time_month]))
    
    ####Actor levels
    icb_events_subset_nodes_min <- 
                  icb_events_subset_nodes %>% group_by(actor) %>% filter(sent==sent %>% min()) %>% ungroup() %>%
                  #left_join(dictionary_actors_labels %>% filter(crisno==thiscrisis) %>% distinct() %>% rename(actor=value_normalized) ) %>% #only need to do for our q codes
                  #rename(qcode=actor, actor=value_normalized_label) %>%
                  rowwise() %>%
                  mutate(actor=actor %>% stringi::stri_wrap(width=15) %>% paste0(collapse='\n'))
    
    
    for(i in 1:nrow(icb_events_subset_nodes)){
      g <- g %>%  add_vertices(1, name=icb_events_subset_nodes$actor_sent[i],
                                  actor = icb_events_subset_nodes$actor[i], 
                                  sent = icb_events_subset_nodes$sent[i]  ) #, type = nodes$type[i] #, leaf = nodes$leaf[i]
    }
    
    xy <- cbind(icb_events_subset_nodes$x, icb_events_subset_nodes$y )
    
    
    #####Time Edges
    icb_events_subset_nodes_edges_time <- cbind(icb_events_subset_nodes, bind_rows(icb_events_subset_nodes[-1,],icb_events_subset_nodes[1,] ) ) %>% 
      janitor::clean_names() %>% filter(actor==actor_2 & sent_2>sent) %>% distinct()
    
    g <- g %>% 
         add_edges(icb_events_subset_nodes_edges_time[,c('actor_sent','actor_sent_2')] %>% as.matrix() %>% t() %>% as.vector(),
                   actor=icb_events_subset_nodes_edges_time$actor, timeedge=T, leaf='', eventedge=F)
    
    
    ######Directed
    icb_events_subset_directed <- 
              icb_events_subset_diad %>% 
              dplyr::select(sent=sent, actor_1=actor_1, actor_2=actor_2, leaf ) %>% distinct() %>%
              mutate(actor_sent_1= actor_1 %>% paste0("_", str_pad(sent, 2, pad = "0") )) %>%
              mutate(actor_sent_2= actor_2 %>% paste0("_", str_pad(sent, 2, pad = "0") )) %>%
              group_by(sent,actor_1, actor_sent_1,actor_sent_2) %>%
                summarise(leaf=paste(leaf, collapse="\n") %>% tolower() ) #%>%
              #filter(actor_sent_2 %>% str_detect("Q30") | actor_sent_1 %>% str_detect("Q30"))
    
    g <- g %>% add_edges(icb_events_subset_directed[,c('actor_sent_1','actor_sent_2')] %>% as.matrix() %>% t() %>% as.vector(),
                         timeedge=F, 
                         leaf=icb_events_subset_directed$leaf, 
                         eventedge=T,
                         actor=icb_events_subset_directed$actor_1) 


    p_icb_metro_map <- g %>%  
          ggraph("manual",x=xy[,1],y=xy[,2]) +  #geom_edge_parallel
    
          #Time edges
          geom_edge_link(aes(
                          edge_colour=actor,
                          filter=timeedge==T
                          ),
                          edge_width=0.1, 
                          show.legend = F
                         ) +
          geom_node_point(aes(color=actor),size=1,stroke=0.5) +
    
          #Event edges
          #geom_path(data = hbundle, aes(x, y, group = group), col = "#9d0191", size = 0.05) +
          geom_edge_arc(aes(  
                              colour=actor,
                              label=leaf,
                              filter=eventedge==T #& bundle_count==1
                              ),
                          vjust = -0.75,
                          lineheight = .75,
                          sep = unit(1, 'mm'), 
                          edge_width=0.25, 
                          show.legend = F,
                          arrow = arrow(length = unit(2, 'mm')),
                          label_size=3,
                          check_overlap=global_check_overlap,
                          start_cap = circle(3, 'mm'),
                          end_cap = circle(3, 'mm'),
                          angle_calc = 'along'
                         ) +

              #Not in phoenix
              #geom_text(data=fatalities %>% filter(interact_fatalities>1), aes(x=x+4,y=y, size=interact_fatalities+1), color='black', label='☠', angle=0) + 
              #Not in phoenix
              #geom_text(data=icb_events_subset_monad, aes(x=x,y=y, label=leaf), nudge_y=40, angle=0, lineheight = .75, size=3) +
              geom_text(data=date_sineposts, aes(x=x,y=y, label=label), color="grey", nudge_y=0, angle=0, size=4, lineheight = .75, fontface = "bold",check_overlap=global_check_overlap) + #-45
              geom_text(data=icb_events_subset_nodes_min, aes(x=x,y=y, label=actor, color=actor), nudge_y=150, angle=0, size=4, lineheight = .75, fontface = "bold") + #-45
              scale_color_manual(values = actor_colors)  +
              scale_edge_color_manual(values = actor_colors) +
              #theme_bw() + 
              #labs( title = plot_title ) +
              theme_graph() +
              theme(legend.position = "none") #+
              #Not in phoenix
              #ggimage::geom_image(data= units, aes(x=x+offeset,y=y-30, image = IMAGE), size = 0.015)
    
        
      p_icb_metro_map$sentence_count <- icb_events_subset_nodes$sent %>% unique() %>% length()
      p_icb_metro_map$actor_colors <- actor_colors
      p_icb_metro_map$icb_monadic_subset <- icb_monadic_subset
      
      p_icb_metro_map %>% saveRDS(save_icb_file)
      
}

c(196, 471) %>% sapply(FUN=function(x) icb_crisismaps(x)) #This just runs every time no from scratch because the files are small


```

```{r mids data loads, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

mid4_df <- data.frame(
  stringsAsFactors = FALSE,
               act = c(1L,2L,3L,4L,5L,6L,7L,8L,
                       9L,10L,11L,12L,13L,14L,15L,16L,17L,18L,19L,
                       20L,21L,22L),
         act_label = c("1. None (1)",
                       "2. Threat to use force (2)",
                       "3. Threat to blockade (2)",
                       "4. Threat to occupy terr. (2)",
                       "5. Threat to declare war (2)",
                       "6. Threat to join war (2)",
                       "7. Show of troops (3)",
                       "8. Show of ships (3)",
                       "9. Show of planes (3)",
                       "10. Alert (3)",
                       "12. Mobilization (3)",
                       "13. Fortify border (3)",
                       "14. Border violation (4)",
                       "15. Blockade (4)",
                       "16. Occupation of territory (4)",
                       "17. Seizure (4)",
                       "18. Clash (4)",
                       "19. Raid (4)",
                       "20. Declaration of war (4)",
                       "22. Begin interstate war (5)",
                       "23. Join interstate war (5)",
                       "24. Use CBR Weapons (5)")
) %>% mutate(act_label= act_label %>% str_replace('[0-9]{1,2}\\. ','') %>% str_replace('\\([1-9]\\)','') )

mid_df <- data.frame(
  stringsAsFactors = FALSE,
               act = c(0L,1L,2L,3L,4L,5L,6L,7L,
                       8L,9L,10L,11L,12L,13L,14L,15L,16L,17L,18L,19L,
                       20L,21L),
         act_label = c("No militarized action (1)",
                       "Threat to use force (2)","Threat to blockade (2)",
                       "Threat to occupy terr. (2)","Threat to declare war (2)",
                       "Threat to use CBR weapons","Threat to join war (2)",
                       "Show of force (3)","Alert (3)","Nuclear alert (3)",
                       "Mobilization (3)","Fortify border (3)","Border violation (4)",
                       "Blockade (4)","Occupation of territory (4)",
                       "Seizure (4)","Attack (4)","Clash (4)","Declaration of war (4)",
                       "Use of CBR weapons (4)","Begin interstate war (5)",
                       "Join interstate war (5)")
)  %>% mutate(act_label= act_label %>% str_replace('[0-9]{1,2}\\. ','') %>% str_replace('\\([1-9]\\)','') )


mid_df2 <- data.frame(
  stringsAsFactors = FALSE,
                outcome = c(0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L),
                outcome_label = c("0. Ongoing MID",
                       "1. Victory for State A","2. Victory for state B",
                       "3. Yield by State A","4. Yield by State B","5. Stalemate",
                       "6. Compromise","7. Released (for seizures)","8. Unclear",
                       "-9 Missing")
) %>% mutate(outcome_label= outcome_label %>% str_replace('[0-9]{1,2}\\. ','') %>% str_replace('\\([1-9]\\)','') )

dyadic_mid <- read_csv(paste0(here::here(), "/replication_paper/data/in/dyadic_mid_4.02.csv"))

dyadic_mid_clean <- dyadic_mid %>% distinct() %>%
                      left_join(actor_translator %>% dplyr::select(statea=COWcode, actor_1=QCode_name, actor_1_qcode=QCode)) %>% #I think we add color here
                      left_join(actor_translator %>% dplyr::select(stateb=COWcode, actor_2=QCode_name, actor_2_qcode=QCode)) %>%
                      left_join(mid_df  %>% dplyr::select( mid5hiacta=act , leaf_1=act_label )) %>%
                      left_join(mid_df  %>% dplyr::select( mid5hiactb=act , leaf_2=act_label )) %>%
                      left_join(mid_df2  %>% dplyr::select( outcome=outcome , outcome_label=outcome_label )) 

```

```{r mids crisismaps, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F }

mids_crisismaps <- function(thiscrisis=196, prune_rare=T){

  print(thiscrisis)
  #thiscrisis=471
  plot_title <- crisno_name_years %>% filter(crisno==thiscrisis) %>% mutate(title="Crisis #" %>% paste0(crisno, " ", crisname, " (", yrtrig, "-",yrterm,")")) %>% pull(title)
  save_mids_file <- paste0(here::here(), "/replication_paper/pnas_draft/p_mids_metro_plot_",thiscrisis,".Rds")

  year_start <-icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig
  year_end   <- icb_crises[icb_crises$crisno==thiscrisis,]$yrterm 
  
  start_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$start_simple
  end_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$end_simple

  actor_sent_counts <- icb_events_long %>%
                       dplyr::filter(crisno==thiscrisis  ) %>% 
                       filter(varname_normalized %>% str_detect("actor")) %>% 
                       dplyr::select(sent=sentence_number_int_aligned,value_normalized,value_qcode) %>% 
                       na.omit() %>%
                       count(value_normalized,value_qcode) %>% arrange(n %>% desc() )
  
  dyadic_mid_clean_subset <- dyadic_mid_clean %>%
                             filter( actor_1_qcode %in% actor_sent_counts$value_qcode & actor_2_qcode %in% actor_sent_counts$value_qcode ) %>%
                             filter(strtyr>=year_start & endyear<=year_end) %>% arrange(strtyr, strtmnth, endday)
  dim(dyadic_mid_clean_subset) #
  if(nrow(dyadic_mid_clean_subset)==0 | 
     (c(dyadic_mid_clean_subset$namea,dyadic_mid_clean_subset$nameb) %>% na.omit() %>% unique() %>%  length())<2  #Reject if not 2 actors
     ){
    print("No mids events for this crisis")
    return()
  }
    
  dyadic_mid_clean_dyad <- 
    bind_rows(
      dyadic_mid_clean_subset %>% dplyr::select(year=strtyr,month=strtmnth,day=strtday, actor_1,actor_2, leaf=leaf_1) , #
      dyadic_mid_clean_subset %>% dplyr::select(year=endyear,month=endmnth,day=endday, actor_1,actor_2, leaf=outcome_label)
  ) %>% mutate(leaf=ifelse(leaf=="Yield by State A" , "Yield to",leaf)) %>%
    filter(!leaf %in% "Yield by State B") %>%
    mutate(sent= ( year+(month/12)+(day/31/1000) ) %>% rank() %>% round())
  


  g <- make_empty_graph(n = 0, directed = TRUE)
    #graph_from_data_frame(vertices=nodes) #relations, directed=TRUE, 
  
  icb_events_subset_diad <- dyadic_mid_clean_dyad %>% dplyr::select(year, month, sent=sent, actor_1=actor_1, actor_2=actor_2 ) %>% distinct()
  #Order actors by how many interactions they have together
  temp <- icb_events_subset_diad  %>% dplyr::select(-year, -month) %>% arrange(actor_1, actor_2) %>% distinct()
  
  temp2 <- bind_rows(
    temp,
    temp %>% setNames(c("story_date", "actor_2", "actor_1" ))
  ) %>% count(actor_1, actor_2) %>% arrange(actor_1, actor_2) %>% arrange(n)
  
  temp2_wide <- temp2 %>% pivot_wider(id_cols=c(actor_1), names_from=actor_2, values_from=n) %>% mutate_if(is.numeric, tidyr::replace_na, 0) %>% as.data.frame()
  rownames(temp2_wide) <- temp2_wide$actor_1
  temp2_wide$actor_1 <- NULL
  temp2_wide <- temp2_wide %>% as.matrix()
  temp2_wide <- 1 - (temp2_wide/max(temp2_wide))
  temp2_wide <- temp2_wide[sort(rownames(temp2_wide)), sort(colnames(temp2_wide))]
  hc <- hclust(temp2_wide %>% as.dist(), method="single")
  
  temp_list <- list()
  for(i in 1:nrow(temp2_wide)){
    temp_list[[as.character(i)]] <- cutree(hc, k=i)
  }
  
  #ideal_ordering <- bind_rows(temp_list) %>% t() %>% as.data.frame() %>% apply(1, paste, collapse='') %>% sort() %>% names() #this will break with more than 9
  #  arrange(across(starts_with("V")))
  ideal_ordering <- hc$labels[hc$order] #There's a bug here, put all the isolated nodes by themselves first
  
  #####Nodes
  icb_events_subset_nodes <- 
            bind_rows(
                      icb_events_subset_diad %>% dplyr::select(year, month, sent=sent, actor=actor_1) ,
                      icb_events_subset_diad %>% dplyr::select(year, month, sent=sent, actor=actor_2) 
            ) %>% na.omit() %>% distinct()  %>% arrange(actor,sent) %>% mutate(actor_sent= actor %>% paste0("_", str_pad(sent, 2, pad = "0") )) %>% #don't na omit this one
            mutate(x=actor %>% factor(levels=actor %>% unique() %>% setdiff(ideal_ordering) %>% c(ideal_ordering)) %>% as.numeric() *100 ,
                   y=sent*-1 *100)
  
  #we centralize everything in qcodes so colors should be consistent across plots for the same actors    
  icbe_actor_to_qcode <- icb_events_long %>%
                     dplyr::filter(crisno==thiscrisis  ) %>% 
                     filter(varname_normalized %>% str_detect("actor")) %>% 
                     dplyr::select(value_normalized,value_qcode) %>% 
                     na.omit() %>% distinct()

  actor_colors_df <- icbe_actor_to_qcode %>%
    left_join(actor_translator %>% dplyr::select(value_qcode=QCode, actor_color))
  actor_colors <- actor_colors_df$actor_color
  names(actor_colors) = actor_colors_df$value_normalized
  

  actors=icb_events_subset_nodes$actor %>% unique() %>% as.factor()
  actor_colors = c(brewer.pal(n=11, "Dark2"), brewer.pal(n=11, "Set1"))[1:length(actors)] #ok so pick a bewer pallet with lots of values and then assign it to specific values
  names(actor_colors) = levels(actors)
    
  
  

  date_sineposts <- icb_events_subset_nodes  %>%
                    mutate(x=max(x)+50) %>%
                    dplyr::select(sent, year, month,x,y) %>%
                    na.omit() %>% 
                    distinct() %>%  
                    mutate(sent=as.numeric(sent)) %>% arrange(sent) %>%
                    mutate(year_float=year+(month/12)) %>%
                    group_by(sent) %>%
                    filter(year_float==min(year_float)) %>%
                    ungroup() %>% as.data.frame() %>%
                    filter( row_number()==1 |  ( year_float > lag(year_float)  ) )  %>%
                    filter(!duplicated(year_float ) ) %>%
                    mutate(label=paste0(year,"-",month.abb[month]))
  
    
  ####Actor lavels
  icb_events_subset_nodes_min <- 
    icb_events_subset_nodes %>% group_by(actor) %>% filter(sent==sent %>% min()) %>% ungroup() %>%
    rowwise() %>%
    mutate(actor=actor %>% stringi::stri_wrap(width=15) %>% paste0(collapse='\n'))
  
  
  for(i in 1:nrow(icb_events_subset_nodes)){
    g <- g %>%  add_vertices(1, name=icb_events_subset_nodes$actor_sent[i],
                                actor = icb_events_subset_nodes$actor[i], 
                                sent = icb_events_subset_nodes$sent[i]  ) #, type = nodes$type[i] #, leaf = nodes$leaf[i]
  }
  
  xy <- cbind(icb_events_subset_nodes$x, icb_events_subset_nodes$y )
  
  
  #####Time Edges
  icb_events_subset_nodes_edges_time <- cbind(icb_events_subset_nodes, bind_rows(icb_events_subset_nodes[-1,],icb_events_subset_nodes[1,] ) ) %>% janitor::clean_names() %>% filter(actor==actor_2 & sent_2>sent) %>% distinct()
  
  g <- g %>% 
       add_edges(icb_events_subset_nodes_edges_time[,c('actor_sent','actor_sent_2')] %>% as.matrix() %>% t() %>% as.vector(),
                 actor=icb_events_subset_nodes_edges_time$actor, timeedge=T, leaf='', eventedge=F)
  
  
  ######Directed
  icb_events_subset_directed <- 
            dyadic_mid_clean_dyad %>% 
            dplyr::select(sent=sent, actor_1=actor_1, actor_2=actor_2, leaf ) %>% distinct() %>%
            mutate(actor_sent_1= actor_1 %>% paste0("_", str_pad(sent, 2, pad = "0") )) %>%
            mutate(actor_sent_2= actor_2 %>% paste0("_", str_pad(sent, 2, pad = "0") )) %>%
            group_by(sent,actor_1, actor_sent_1,actor_sent_2) %>%
              summarise(leaf=paste(leaf, collapse="\n") %>% tolower() ) #%>%
            #filter(actor_sent_2 %>% str_detect("Q30") | actor_sent_1 %>% str_detect("Q30"))
  
  g <- g %>% add_edges(icb_events_subset_directed[,c('actor_sent_1','actor_sent_2')] %>% as.matrix() %>% t() %>% as.vector(),
                       timeedge=F, 
                       leaf=icb_events_subset_directed$leaf, 
                       eventedge=T,
                       actor=icb_events_subset_directed$actor_1) 

    p_mids_metro_map <- g %>%  
          ggraph("manual",x=xy[,1],y=xy[,2]) +  #geom_edge_parallel
    
          #Time edges
          geom_edge_link(aes(
                          edge_colour=actor,
                          filter=timeedge==T
                          ),
                          edge_width=0.1, 
                          show.legend = F
                         ) +
          geom_node_point(aes(color=actor),size=1,stroke=0.5) +
    
          #Event edges
          #geom_path(data = hbundle, aes(x, y, group = group), col = "#9d0191", size = 0.05) +
          geom_edge_arc(aes(  
                              colour=actor,
                              label=leaf,
                              filter=eventedge==T #& bundle_count==1
                              ),
                          vjust = -0.75,
                          lineheight = .75,
                          sep = unit(1, 'mm'), 
                          edge_width=0.25, 
                          show.legend = F,
                          arrow = arrow(length = unit(2, 'mm')),
                          label_size=3,
                          check_overlap=global_check_overlap,
                          start_cap = circle(3, 'mm'),
                          end_cap = circle(3, 'mm'),
                          angle_calc = 'along'
                         ) +

              #Not in phoenix
              #geom_text(data=fatalities %>% filter(interact_fatalities>1), aes(x=x+4,y=y, size=interact_fatalities+1), color='black', label='☠', angle=0) + 
              #Not in phoenix
              #geom_text(data=icb_events_subset_monad, aes(x=x,y=y, label=leaf), nudge_y=40, angle=0, lineheight = .75, size=3) +
              geom_text(data=date_sineposts, aes(x=x,y=y, label=label), color="grey", nudge_y=0, angle=0, size=4, lineheight = .75, fontface = "bold",check_overlap=global_check_overlap) + #-45
              geom_text(data=icb_events_subset_nodes_min, aes(x=x,y=y, label=actor, color=actor), nudge_y=150, angle=0, size=4, lineheight = .75, fontface = "bold") + #-45
              scale_color_manual(values = actor_colors)  +
              scale_edge_color_manual(values = actor_colors) +
              #theme_bw() + 
              #labs( title = plot_title ) +
              theme_graph() +
              theme(legend.position = "none") #+
              #Not in phoenix
              #ggimage::geom_image(data= units, aes(x=x+offeset,y=y-30, image = IMAGE), size = 0.015)
    
    
  p_mids_metro_map$sentence_count <- icb_events_subset_nodes$sent %>% unique() %>% length()
  p_mids_metro_map$actor_colors <- actor_colors
  p_mids_metro_map$dyadic_mid_clean <- dyadic_mid_clean
  
  
  p_mids_metro_map %>% saveRDS(save_mids_file)
}

c(196, 471) %>% sapply(FUN=function(x) mids_crisismaps(x))

  
```


```{r phoenix data loads, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F,}
#[@althausClineCenterHistorical2020a]
#https://databank.illinois.edu/datasets/IDB-2796521

library(tidyverse)
library(countrycode)
library(igraph)
library(ggraph)

#8,491,556
library(stringr)
fromscratch=F
if(fromscratch){

  convert_aid = function(x) { x %>% mutate(aid = aid %>% format( scientific = FALSE)) %>% mutate_all(as.character) }
  meta1_nyt2 <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "MetaDataBLN-NYT_1980-2018.csv"), col_types=rep('c',50)  %>% paste0(collapse='')) #%>% convert_aid()
  meta2_swb <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "MetaDataBLN-SWB_1979-2019.csv"), col_types=rep('c',50)  %>% paste0(collapse='')) #%>% convert_aid()
  meta_fbis <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "MetaDataFBIS_1995-2004.csv"), col_types=rep('c',50)  %>% paste0(collapse='')) #%>% convert_aid()
  meta_nyt <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "MetaDataNYT_1945-2005.csv"), col_types=rep('c',50)  %>% paste0(collapse='')) #%>% convert_aid()
  meta_wsj <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "MetaDataWSJ_1945-2006.csv"), col_types=rep('c',50)  %>% paste0(collapse='')) #%>% convert_aid()
  
  events_nyt2 <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "PhoenixBLN-NYT_1980-2018.csv"), col_types=rep('c',50)  %>% paste0(collapse='')) # %>% convert_aid() 
  events_swb <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "PhoenixBLN-SWB_1979-2019.csv"), col_types=rep('c',50) %>% paste0(collapse='')) #%>% convert_aid() 
  events_fbis <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "PhoenixFBIS_1995-2004.csv"), col_types=rep('c',50) %>% paste0(collapse='')) #%>% convert_aid()  
  events_nyt <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "PhoenixNYT_1945-2005.csv"), col_types=rep('c',50) %>% paste0(collapse='')) #%>% convert_aid()  
  events_wsj <- read_csv(here::here("git_ignore_folder", "DOI-10-13012-b2idb-0647142_v3", "PhoenixWSJ_1945-2006.csv"), col_types=rep('c',50) %>% paste0(collapse='')) #%>% convert_aid()  
  
  setdiff(events_nyt2$aid , meta1_nyt2$aid) %>% length() #0 #316,201 #yup that was it if you import as numeric it converts to scientific internally and breaks everything 
  setdiff(meta1_nyt2$aid , events_nyt2$aid) %>% length() #0 #613,981 #Have to keep as a string throughout
  
  phoenix <- bind_rows(events_nyt2 %>% left_join(meta1_nyt2),
                       events_swb %>% left_join(meta2_swb),
                       events_fbis %>% left_join(meta_fbis),
                       events_nyt %>% left_join(meta_nyt),
                       events_wsj %>% left_join(meta_wsj)
                       )
  
  target_file <- paste0(here::here(),"/replication_paper/data/in/icb_manual_recoding_master_sheet.xlsx")
  actor_translator    <- readxl::read_excel(target_file, sheet="actor_translator") 

  root_codes <- phoenix$root_code %>% unique()

  #library("remotes")
  #remotes::install_github("andybega/icews")
  library(icews)
  data("cameo_codes") #we're going to grab the cameo codes from the ICEWS package because they're a nightmare
  cameo_codes_goldstein <- cameo_codes %>% left_join(goldstein_mappings) %>% mutate(name=name %>% tolower())

  phoenix_clean <- phoenix %>% 
                   #head(10000) %>%
                   left_join(cameo_codes_goldstein %>% dplyr::select(code=cameo_code , cameo_event_label=name,
                                                                     cameo_penta_category=penta_category, cameo_quad_category=quad_category, 
                                                                     cameo_goldstein=goldstein, cameo_lvl0=lvl0 ) ) %>%
                   left_join(    cameo_codes_goldstein %>% filter(level==0) %>% dplyr::select(cameo_lvl0=lvl0, cameo_lvl0_label=name)) %>% #
                   #
                   left_join(cameo_actor_codes %>% dplyr::select(source=code, source_label=name)  )  %>%
                   left_join(cameo_actor_codes %>% dplyr::select(target=code, target_label=name)  )  %>%
                   #
                   left_join(cameo_actor_codes %>% dplyr::select(source_root=code, source_label=name)  )  %>%
                   left_join(cameo_actor_codes %>% dplyr::select(target_root=code, target_label=name)  )  %>%
                   #
                   left_join(cameo_actor_codes %>% dplyr::select(source_agent=code, source_agent_label=name) %>% distinct() %>% na.omit() ) %>%
                   left_join(cameo_actor_codes %>% dplyr::select(target_agent=code, target_agent_label=name) %>% distinct() %>% na.omit() ) %>%
                   #
                   separate(source_others, c("source_others1", "source_others2", "source_others3"), sep = ";", remove=F, extra="drop") %>% 
                   separate(target_others, c("target_others1", "target_others2", "target_others3"), sep = ";", remove=F, extra="drop") %>%
                   left_join(cameo_actor_codes %>% dplyr::select(source_others1=code, source_others1_label=name) %>% distinct() %>% na.omit() ) %>%
                   left_join(cameo_actor_codes %>% dplyr::select(target_others1=code, target_others1_label=name) %>% distinct() %>% na.omit() )  %>% 
                   left_join(cameo_actor_codes %>% dplyr::select(source_others2=code, source_others2_label=name) %>% distinct() %>% na.omit() ) %>%
                   left_join(cameo_actor_codes %>% dplyr::select(target_others2=code, target_others2_label=name) %>% distinct() %>% na.omit() )  %>% 
                   left_join(cameo_actor_codes %>% dplyr::select(source_others3=code, source_others3_label=name) %>% distinct() %>% na.omit() ) %>%
                   left_join(cameo_actor_codes %>% dplyr::select(target_others3=code, target_others3_label=name) %>% distinct() %>% na.omit() )  %>% 
    
                   mutate(date_simple=as.numeric(year) + (as.numeric(month)/12) ) %>%

                   mutate(joined_issues=ifelse( joined_issues=='',";", joined_issues)  ) %>% #Apparently unnesting an empty string just gets dropped
                   mutate(joined_issues = strsplit(as.character(joined_issues), ";") ) %>%  unnest(joined_issues)  %>% #This drops if the row is missing, I did not know that was it
                   #
                   left_join(actor_translator %>% dplyr::select(source_root=phoenix_2020, source_root_label=QCode_name, source_root_qcode=QCode) %>% distinct() %>% na.omit() ) %>%
                   left_join(actor_translator %>% dplyr::select(target_root=phoenix_2020, target_root_label=QCode_name, target_root_qcode=QCode) %>% distinct() %>% na.omit() ) %>%
                   mutate(month_label = lubridate::month(month %>% as.numeric(),label=TRUE,abbr=F)) %>%
                   mutate(source_agent_label = source_agent_label %>% tolower()) %>%
                   mutate(target_agent_label = target_agent_label %>% tolower()) %>%
                   mutate(source_others1_label=source_others1_label %>% tolower()) %>%
                   mutate(target_others1_label=target_others1_label %>% tolower()) %>%
                   mutate(source_others2_label=source_others2_label %>% tolower()) %>%
                   mutate(target_others2_label=target_others2_label %>% tolower()) %>%
                   mutate(source_others3_label=source_others3_label %>% tolower()) %>%
                   mutate(target_others3_label=target_others3_label %>% tolower()) %>%
                   unite(text, 
                          source_root_label, source_agent_label, source_others1_label, source_others2_label, source_others3_label,
                          cameo_event_label, 
                          target_agent_label, target_root_label, target_others1_label, target_others2_label, target_others3_label, 
                          sep=" ", remove = F, na.rm = T) %>%
                    mutate(text = ifelse(!is.na(placename),paste0(text, " in ", placename),text) ) %>% 
                    mutate(text = ifelse(!is.na(joined_issues),paste0(text, " on the topic of ", joined_issues %>% tolower() %>% str_replace(",[0-9]","") ),text) ) %>% 
                    mutate(text = paste0("On ", month_label, " ",day %>% as.numeric()," ",year, ", ", text)) %>%
                    mutate(text=text %>% str_replace(", not specified below","")) %>% 
                    arrange(year, month, day)  %>% mutate(date = paste(day,"-",month,"-",year) %>% lubridate::dmy())
              
  dim(phoenix_clean) #8,495,402 #3,721,110 #2,813,748 #2912035 #3,508,495 #4,854,787
  phoenix_clean %>% arrow::write_parquet(here::here("git_ignore_folder",  "phoenix_clean.parquet") )
  
  library(dplyr)
  library(digest)
  keep_list <- c("Ukraine", "Russia","Russian Federation", 'North Atlantic Treaty Organization','NATO', 'European Union', 'Crimea','Donbas') #, 'United Nations'
  phoenix_clean_471 <- phoenix_clean %>% 
                        mutate(year = year %>% as.numeric() ) %>%
                       filter( year>= 2013 & year<= 2015 ) %>%
                       #filter( date>= as.Date("2013-01-01") & date<= as.Date("2015-12-31") ) %>%
                       filter( text %>% str_detect(paste0(c(keep_list,keep_list %>% tolower()),collapse="|"))) 
  dim(phoenix_clean_471) #68,334
  
  #phoenix_clean_471 %>% write_tsv("/mnt/8tb_a/rwd_github_private/ICBEdataset/replication_paper/data/out/phoenix_clean_471.tsv")
  dim(phoenix_clean_471) 
  
  #phoenix_clean_471 %>%
  #  unite('actors_left' , source_label, source_root_label , source_agent_label, source_others1_label,source_others2_label,source_others3_label, sep=" ", , na.rm =T, remove=F) %>%
  #  unite('actors_right', target_label, target_root_label , target_agent_label, target_others1_label,target_others2_label,target_others3_label, sep=" ", , na.rm =T, remove=F) %>%
  #  dplyr::select(eid, year, month, day, actors_left, actors_right,cameo_event_label, text , title, primary_source, original_source) %>% 
  #  write_tsv("/mnt/8tb_a/rwd_github_private/ICBEdataset/replication_paper/data/out/phoenix_clean_471_small.tsv")
  
  
  library(dplyr)
  library(digest)
  keep_list <- c("Cuba", "Russia","Russian Federation", 'North Atlantic Treaty Organization','NATO', 'United States') #, 'United Nations'
  phoenix_clean_196 <- phoenix_clean %>% 
                       mutate(year = year %>% as.numeric() ) %>%
                       filter( year>= 1958 & year<= 1963 ) %>%
                       #filter( date>= as.Date("2013-01-01") & date<= as.Date("2015-12-31") ) %>%
                       filter( text %>% str_detect(paste0(c(keep_list,keep_list %>% tolower()),collapse="|"))) 
  dim(phoenix_clean_196) #62,192
  
  #phoenix_clean_196 %>% write_tsv("/mnt/8tb_a/rwd_github_private/ICBEdataset/replication_paper/data/out/phoenix_clean_196.tsv")
  #dim(phoenix_clean_196) 
  
  #phoenix_clean_196 %>%
  #  unite('actors_left' , source_label, source_root_label , source_agent_label, source_others1_label,source_others2_label,source_others3_label, sep=" ", , na.rm =T, remove=F) %>%
  #  unite('actors_right', target_label, target_root_label , target_agent_label, target_others1_label,target_others2_label,target_others3_label, sep=" ", , na.rm =T, remove=F) %>%
  #  dplyr::select(eid, year, month, day, actors_left, actors_right,cameo_event_label, text , title, primary_source, original_source) %>% 
  #  write_tsv("/mnt/8tb_a/rwd_github_private/ICBEdataset/replication_paper/data/out/phoenix_clean_196_small.tsv")

}

```

```{r phoenix_barmaps, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)
library(stringr)

phoenix_barmaps <- function(thiscrisis=196, topactor=F){

    print(thiscrisis)
    plot_title <- crisno_name_years %>% filter(crisno==thiscrisis) %>% mutate(title="Crisis #" %>% paste0(crisno, " ", crisname, " (", yrtrig, "-",yrterm,")")) %>% pull(title)
    save_file_penta <- paste0(here::here(), "/replication_paper/pnas_draft/p_phoenix_plot_penta_",thiscrisis,".Rds")
    save_file_lv0 <- paste0(here::here(), "/replication_paper/pnas_draft/p_phoenix_plot_lv0_",thiscrisis,".Rds")
    
    date_start <- lubridate::as_date(paste0(icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig , "-", icb_crises[icb_crises$crisno==thiscrisis,]$motrig, "-01"))
    date_end <- lubridate::as_date(paste0(icb_crises[icb_crises$crisno==thiscrisis,]$yrterm , "-", icb_crises[icb_crises$crisno==thiscrisis,]$moterm, "-01"))
    date_end <- date_end %>% lubridate::ceiling_date() %>% lubridate::as_date()
    
    year_start <-icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig
    year_end   <- icb_crises[icb_crises$crisno==thiscrisis,]$yrterm 
    
    start_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$start_simple
    end_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$end_simple

    actors <- icb_events_long %>% filter(crisno %in% thiscrisis) %>% filter(varname_normalized %>% str_detect('actor')) %>% 
              dplyr::select(value_normalized,value_qcode) %>% distinct()

    phoenix_clean_subset <- phoenix_clean %>% 
                            mutate(story_date = story_date %>% lubridate::mdy()) %>%
                            filter(story_date>=(date_start-lubridate::years(1)) & story_date<=(date_end+lubridate::years(1))) %>%  
                            unite('dyad_a', source_root_label, source_agent_label, source_others1_label, source_others2_label, source_others3_label, na.rm = TRUE, remove = FALSE) %>%
                            unite('dyad_b', target_root_label, target_agent_label, target_others1_label, target_others2_label, target_others3_label, na.rm = TRUE, remove = FALSE) %>%
                            mutate(dyad=paste0(dyad_a,"->",dyad_b)) %>%
                            mutate(dyad_event=paste0(dyad, "_", cameo_event_label)) %>%
                            mutate(dyad_penta_category=paste0(dyad, "_", cameo_penta_category)) %>%
                            mutate(dyad_lvl0_label=paste0(dyad, "_", cameo_lvl0_label)) %>%
      
                            unite('temp', everything() , na.rm = TRUE, remove = FALSE) %>%
                            filter(temp %>% str_detect(actors$value_normalized %>% paste0(collapse="|"))) %>%
                            dplyr::select(-temp)
      
    dim(phoenix_clean_subset)
    
    dyad_event_counts <-     phoenix_clean_subset  %>% 
                             mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                             filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                             count(cameo_penta_category, dyad_penta_category) %>% 
                             group_by(cameo_penta_category) %>%
                             arrange(cameo_penta_category,  desc(n) ) %>% 
                             filter(row_number()<=10) %>% ungroup() 

    names_to_qcodes <- actor_translator %>% dplyr::select(QCode, contains("name")) %>%
                       pivot_longer(-c(QCode)) %>% na.omit() %>% dplyr::select(-name) %>% distinct() %>%
                       mutate(markdown = glue::glue("![]({flag_folder_small}/{QCode}.png)") ) 
    names_to_qcodes <- bind_rows(names_to_qcodes, names_to_qcodes %>% mutate(value= value %>% tolower() )) %>% distinct() %>%
                       arrange(desc(nchar(value))) #sort by length so you never accidentally replace a subset
    
    phoenix_clean_subset_top10 <- phoenix_clean_subset %>% 
                                  filter(dyad_penta_category %in% dyad_event_counts$dyad_penta_category  ) %>%
                                  mutate(dyad_markdown=dyad)
    for(i in 1:nrow(names_to_qcodes)){
      phoenix_clean_subset_top10 <- phoenix_clean_subset_top10 %>%
                                    dplyr::mutate(dyad_markdown = dyad_markdown %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  )) 
    }
    library(ggtext)
    phoenix_clean_subset_top10 <- phoenix_clean_subset_top10 %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government","gov")) %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("\\(tertiary role code\\)","")) %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("unidentified armed force"," unknown force"))
    
    p_phoenix_penta <- phoenix_clean_subset_top10 %>%
          filter(!is.na(cameo_penta_category)) %>%
          group_by(dyad_markdown, cameo_penta_category, date) %>%
          summarise(mean_goldstein=mean(cameo_goldstein), n=n()) %>%
          group_by(cameo_penta_category, dyad_markdown) %>% mutate(n_all=sum(n, na.rm=T)) %>% ungroup() %>%
          mutate(dyad_markdown = tidytext::reorder_within(dyad_markdown, n_all, within = cameo_penta_category)) %>%
          ggplot( aes(x = date, y = dyad_markdown, fill = mean_goldstein)) +
          geom_tile() + theme_bw() +
          tidytext::scale_y_reordered() +
          geomtextpath::geom_textvline(xintercept = as.Date(date_start), label="Crisis Start (ICB)" , linetype="dotted", color = "black", size=3) +
          geomtextpath::geom_textvline(xintercept = as.Date(date_end), label="Crisis End (ICB)" , linetype="dotted", color = "black", size=3) +
          facet_wrap(~cameo_penta_category, scale="free_y", ncol=1)  +
          theme(plot.margin = unit(c(0,0,0,0), "cm")) + theme( axis.text.y = element_markdown(size = 12, lineheight = 0.1)  ) +
          scale_fill_gradient2() +
          theme(legend.position="none") +
         ylab("") + xlab("")
    
    p_phoenix_penta %>% saveRDS(save_file_penta)
        
    #cameo_lvl0_label
    dyad_event_counts <-     phoenix_clean_subset  %>% 
                             mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                             filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                             count(cameo_lvl0_label, dyad_lvl0_label) %>% 
                             group_by(cameo_lvl0_label) %>%
                             arrange(cameo_lvl0_label,  desc(n) ) %>% 
                             filter(row_number()<=10) %>% ungroup() 

    names_to_qcodes <- actor_translator %>% dplyr::select(QCode, contains("name")) %>%
                       pivot_longer(-c(QCode)) %>% na.omit() %>% dplyr::select(-name) %>% distinct() %>%
                       mutate(markdown = glue::glue("![]({flag_folder_small}/{QCode}.png)") ) 
    names_to_qcodes <- bind_rows(names_to_qcodes, names_to_qcodes %>% mutate(value= value %>% tolower() )) %>% distinct() %>%
                       arrange(desc(nchar(value))) #sort by length so you never accidentally replace a subset
    
    phoenix_clean_subset_top10 <- phoenix_clean_subset %>% 
                                  filter(dyad_lvl0_label %in% dyad_event_counts$dyad_lvl0_label  ) %>%
                                  mutate(dyad_markdown=dyad)
    for(i in 1:nrow(names_to_qcodes)){
      phoenix_clean_subset_top10 <- phoenix_clean_subset_top10 %>%
                                    dplyr::mutate(dyad_markdown = dyad_markdown %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  )) 
    }
    library(ggtext)
    phoenix_clean_subset_top10 <- phoenix_clean_subset_top10 %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government","gov")) %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("\\(tertiary role code\\)","")) %>%
                                   mutate(dyad_markdown = dyad_markdown %>% str_replace_all("unidentified armed force"," unknown force"))
    
    phoenix_clean_subset_top10_day <- phoenix_clean_subset_top10 %>%
                                      mutate(story_date=paste(month, day, year, sep="/")) %>%
                                      filter(!is.na(cameo_lvl0_label)) %>%
                                      mutate(date = story_date %>% lubridate::mdy()) %>%
                                      group_by(dyad_markdown, cameo_lvl0_label, date) %>%
                                      summarise(mean_goldstein=mean(cameo_goldstein), n=n())
        
    p_phoenix_lv0 <- phoenix_clean_subset_top10_day %>%
                      group_by(cameo_lvl0_label, dyad_markdown) %>% mutate(n_all=sum(n, na.rm=T)) %>% ungroup() %>%
                      mutate(dyad_markdown = tidytext::reorder_within(dyad_markdown, n_all, within = cameo_lvl0_label)) %>%
                      ggplot( aes(x = date, y = dyad_markdown, fill = mean_goldstein)) +
                      geom_tile() + theme_bw() +
                      tidytext::scale_y_reordered() +
                      geomtextpath::geom_textvline(xintercept = as.Date(date_start), label="Crisis Start (ICB)" , linetype="dotted", color = "black", size=3) +
                      geomtextpath::geom_textvline(xintercept = as.Date(date_end), label="Crisis End (ICB)" , linetype="dotted", color = "black", size=3) +
                      facet_wrap(~cameo_lvl0_label, scale="free_y", ncol=3)  +
                      theme(plot.margin = unit(c(0,0,0,0), "cm")) + theme( axis.text.y = element_markdown(size = 12, lineheight = 0.1)  ) +
                      scale_fill_gradient2() +
                      theme(legend.position="none") +
                      ylab("") + xlab("")
    
        p_phoenix_lv0 %>% saveRDS(save_file_lv0)


                
}

fromscratch=F
if(fromscratch){
  phoenix_clean <- arrow::read_parquet(here::here("git_ignore_folder", "phoenix_clean.parquet") ) 
  c(196, 471) %>% sapply(FUN=function(x) phoenix_barmaps(x))
}

```

```{r Terrierr Data Loads, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

#https://osf.io/4m2u7/

terrier_agent_labels <- data.frame(
       stringsAsFactors = FALSE,
                   agent = c("GOV","SPY","OPP",
                            "MIL","PTY","REB","EDU","COP","JUD","CRM",
                            "BUS","MED","CVL","UAF","AGR","ELI","DEV","ENV",
                            "HLH","HRI","LAB","LEG","REF","MOD","RAD"),
                    agent_label = c("Government",
                            "Intelligence agencies",
                            "Opposition groups (often parliamentary)",
                            "Military",
                            "Political party",
                            "Rebels/insurgents",
                            "Education-focused actors",
                            "Law enforcement agencies",
                            "Judicial actors",
                            "Criminal actors",
                            "Business (NOT MNCs)",
                            "Media-related actors/organizations",
                            "Civilians",
                            "Unaffiliated armed forces",
                            "Agriculture-focused actors",
                            "Elites, celebrities",
                            "Development-focused actors",
                            "Environment-focused actors",
                            "Health-focused actors",
                            "Human rights-focused actors",
                            "Labor-focused actors",
                            "Legislative bodies/actors",
                            "Refugee-focused actors",
                            "Moderate/mainstream group",
                            "Radical/extremist/fundamentalist")
) %>% janitor::clean_names() %>%
  mutate(agent_label = agent_label %>% tolower() )

#if(file.exists(paste0(here::here(), "/replication_paper/data/ignore/terrier/largegeolocateddata//"))){
#  terrier_fromscratch <-readline(prompt="Load original Terrier data? (T/F)")
#}
#terrier_fromscratch <- terrier_fromscratch %in% "T"

#CAMEO_eventcodes <- read_tsv(paste0(here::here(), "/replication_paper/data/in/CAMEO.eventcodes.txt"), col_types='cc' ) %>% janitor::clean_names()
#codes_used <-terrier_clean %>% count(cameo_code)

#Switching to data table with dplyr wrapper
library(data.table)
library(dtplyr)
library(dplyr, warn.conflicts = FALSE)
terrier_fromscratch <- F
if(terrier_fromscratch){
    files <- list.files(path = paste0(here::here(), "/git_ignore_folder/largegeolocateddata/"), pattern = ".tsv$", full.names = T)
    terrier <- rbindlist(lapply(files, FUN=function(x) fread(x,header=F, colClasses=paste0(rep('character',50), collapse='')  )  ) ) #%>% janitor::clean_names()
    dim(terrier) #28,438,029 #28,370,448       28
  
    actor_translator_terrier <- actor_translator %>% dplyr::select( terrier,  QCode, QCode_name) %>% filter(!duplicated(terrier)) %>% as.data.table() %>% na.omit()

    #library("remotes")
    #remotes::install_github("andybega/icews")
    library(icews)
    data("cameo_codes") #we're going to grab the cameo codes from the ICEWS package because they're a nightmare
    cameo_codes_goldstein <- cameo_codes %>% left_join(goldstein_mappings) %>% mutate(name=name %>% tolower())
    
    library(tictoc)
    tictoc::tic()
    dim(terrier) #28,438,029
    #terrier_clean_temp %>% as.data.table() %>% dim()
    #Maybe it's just ISO3 country codes?
    terrier_clean_temp <- terrier %>% 
        #head(100000) %>% 
        as_tibble() %>%
        dplyr::select(
          #id=V1,
          hash=V2,
          cameo_code=V3,
          src_country=V8,
          src_agent=V9,
          src_other_agent=V10,
          
          target_country=V12 ,
          target_agent=V13,
          target_other_agent=V14,
          
          year=V17,
          month=V18,
          day=V19,
          where=V21#,
          #source=V7
          #random_text=x28
        ) %>% 
        left_join(cameo_codes_goldstein %>% mutate(cameo_code=cameo_code ) %>% dplyr::select(cameo_code=cameo_code, cameo_label= name, cameo_goldstein=goldstein,
                                                                                             cameo_penta_category=penta_category, cameo_lvl0=lvl0)  ) %>% #
        left_join(    cameo_codes_goldstein %>% filter(level==0) %>% dplyr::select(cameo_lvl0=lvl0, cameo_lvl0_label=name)) %>% #
        mutate( cameo_label= cameo_label %>% str_replace(', not specified below','')) %>% 
      
        mutate( cameo_label= cameo_label %>% str_replace(', not specified below','')) %>% 
        tidyr::separate(target_other_agent, c("target_other_agent1", "target_other_agent2", "target_other_agent3",
                                              'trash1','trash2','trash3','trash4','trash5','trash6','trash7','trash8','trash9','trash10'), sep = ";", remove=F, extra="drop") %>%
        dplyr::select(-starts_with("trash")) %>%
        tidyr::separate(src_other_agent   , c("src_other_agent1"   , "src_other_agent2"   , "src_other_agent3",
                                              'trash1','trash2','trash3','trash4','trash5','trash6','trash7','trash8','trash9','trash10','trash11'), sep = ";", remove=F, extra="drop") %>%
        dplyr::select(-starts_with("trash")) %>%
  
        left_join(cameo_actor_codes %>% dplyr::select(src_country=code, src_country_label= name) %>% as.data.table()  ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(target_country=code, target_country_label= name) %>% as.data.table()  ) %>%
      
        left_join(cameo_actor_codes %>% dplyr::select(src_agent=code, src_agent_label= name) %>% as.data.table()  ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(src_other_agent1=code, src_other_agent1_label= name) %>% as.data.table()  ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(src_other_agent2=code, src_other_agent2_label= name) %>% as.data.table()  ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(src_other_agent3=code, src_other_agent3_label= name) %>% as.data.table()  ) %>%
      
        left_join(cameo_actor_codes %>% dplyr::select(target_agent=code, target_agent_label= name) %>% as.data.table()   ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(target_other_agent1=code, target_other_agent1_label= name) %>% as.data.table()  ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(target_other_agent2=code, target_other_agent2_label= name) %>% as.data.table()  ) %>%
        left_join(cameo_actor_codes %>% dplyr::select(target_other_agent3=code, target_other_agent3_label= name) %>% as.data.table()  ) %>%
      
        left_join(actor_translator_terrier %>% dplyr::select(src_country   = terrier, actor_1_qcode = QCode, actor_1_label=QCode_name) %>% as.data.table() %>% na.omit() ) %>%
        left_join(actor_translator_terrier %>% dplyr::select(target_country= terrier, actor_2_qcode = QCode, actor_2_label=QCode_name) %>% as.data.table() %>% na.omit()  ) %>%
        mutate(month_label = lubridate::month(month %>% as.numeric(),label=TRUE,abbr=F)) %>%
        mutate(cameo_label = cameo_label %>% tolower() ) %>% 
                       mutate(year= year %>% as.numeric() ) %>% 
                       mutate(month= month %>% as.numeric() ) %>% 
                       mutate(day= day %>% as.numeric() )  %>%
       as_tibble()
    tictoc::toc() #313.74 
    dim(terrier_clean_temp) #31,117,198 #39322909
    
    #terrier_clean_temp %>% saveRDS( here::here("replication_paper", "data", "in", "terrier_clean.Rds"))
    library(arrow) #you have to actually load the library
    terrier_clean_temp  %>%
      arrow::write_parquet(here::here("git_ignore_folder", "terrier_clean.parquet") )
}

```

```{r terrier_barmaps, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)
library(stringr)

terrier_barmaps <- function(thiscrisis=471, topactor=F){

    print(thiscrisis)
    plot_title <- crisno_name_years %>% filter(crisno==thiscrisis) %>% mutate(title="Crisis #" %>% paste0(crisno, " ", crisname, " (", yrtrig, "-",yrterm,")")) %>% pull(title)
    save_file_penta <- paste0(here::here(), "/replication_paper/pnas_draft/p_terrier_plot_penta_",thiscrisis,".Rds")
    save_file_lv0 <- paste0(here::here(), "/replication_paper/pnas_draft/p_terrier_plot_lv0_",thiscrisis,".Rds")
    
    date_start <- lubridate::as_date(paste0(icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig , "-", icb_crises[icb_crises$crisno==thiscrisis,]$motrig, "-01"))
    date_end <- lubridate::as_date(paste0(icb_crises[icb_crises$crisno==thiscrisis,]$yrterm , "-", icb_crises[icb_crises$crisno==thiscrisis,]$moterm, "-01"))
    date_end <- date_end %>% lubridate::ceiling_date() %>% lubridate::as_date()
    
    year_start <-icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig
    year_end   <- icb_crises[icb_crises$crisno==thiscrisis,]$yrterm 
    
    start_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$start_simple
    end_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$end_simple

    actors <- icb_events_long %>% filter(crisno %in% thiscrisis) %>% filter(varname_normalized %>% str_detect('actor')) %>% 
              dplyr::select(value_normalized,value_qcode) %>% distinct()

    terrier_clean_subset <- terrier_clean %>% 
                    mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() ) %>%
                    filter(story_date>=(date_start-lubridate::years(1)) & story_date<=(date_end+lubridate::years(1))) %>%  
                    unite('temp', src_country_label,src_agent_label,src_other_agent1_label,src_other_agent2_label,src_other_agent3_label,
                          target_country_label, target_agent_label,target_other_agent1_label,target_other_agent2_label,target_other_agent3_label,
                          where,
                          na.rm = TRUE, remove = FALSE) %>%
                    filter(temp %>% str_detect(actors$value_normalized %>% paste0(collapse="|"))) %>%
                    unite('dyad_a', src_country_label,src_agent_label,src_other_agent1_label,src_other_agent2_label,src_other_agent3_label, na.rm = TRUE, remove = FALSE) %>%
                    unite('dyad_b', target_country_label, target_agent_label,target_other_agent1_label,target_other_agent2_label,target_other_agent3_label, na.rm = TRUE, remove = FALSE) %>%
                    mutate(dyad=paste0(dyad_a,"->",dyad_b)) %>%
                    mutate(dyad_event=paste0(dyad, "_", cameo_label)) %>%
                    mutate(dyad_penta_category=paste0(dyad, "_", cameo_penta_category)) %>%
                    mutate(dyad_lvl0_category=paste0(dyad, "_", cameo_lvl0_label)) %>%
                    dplyr::select(-temp)
      
    dim(terrier_clean_subset) #928,640
    


    names_to_qcodes <- actor_translator %>% dplyr::select(QCode, contains("name")) %>%
                       pivot_longer(-c(QCode)) %>% na.omit() %>% dplyr::select(-name) %>% distinct() %>%
                       mutate(markdown = glue::glue("![]({flag_folder_small}/{QCode}.png)") ) 
    names_to_qcodes <- bind_rows(names_to_qcodes, names_to_qcodes %>% mutate(value= value %>% tolower() )) %>% distinct() %>%
                       arrange(desc(nchar(value))) #sort by length so you never accidentally replace a subset
    
    #Penta
    dyad_event_counts <-     terrier_clean_subset  %>% 
                         mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                         filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                         count(cameo_penta_category, dyad_penta_category) %>% 
                         group_by(cameo_penta_category) %>%
                         arrange(cameo_penta_category,  desc(n) ) %>% 
                         filter(row_number()<=10) %>% ungroup() 
        
    terrier_clean_subset_top10 <- terrier_clean_subset %>% 
                                  filter(dyad_penta_category %in% dyad_event_counts$dyad_penta_category  ) %>%
                                  mutate(dyad_markdown=dyad)


    terrier_clean_subset_top10_day <- terrier_clean_subset_top10 %>%
          mutate(story_date=paste(month, day, year, sep="/")) %>%
          filter(!is.na(cameo_penta_category)) %>%
          mutate(date = story_date %>% lubridate::mdy()) %>%
          group_by(dyad_markdown, cameo_penta_category, date) %>%
          summarise(mean_goldstein=mean(cameo_goldstein), n=n())
      
    for(i in 1:nrow(names_to_qcodes)){
      #print(i)
      terrier_clean_subset_top10_day <- terrier_clean_subset_top10_day %>%
                                    dplyr::mutate(dyad_markdown = dyad_markdown %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  ))
    } #This is a bottleneck now and needs to move to after the group
    library(ggtext)
    terrier_clean_subset_top10_day <- terrier_clean_subset_top10_day %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government|Government","gov")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all(fixed("(tertiary role code)"),"")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("Unidentified Armed Force","Unknown Mil."))
    
    p_terrier_penta <-  terrier_clean_subset_top10_day %>%
          group_by(cameo_penta_category, dyad_markdown) %>% mutate(n_all=sum(n, na.rm=T)) %>% ungroup() %>%
          mutate(dyad_markdown = tidytext::reorder_within(dyad_markdown, n_all, within = cameo_penta_category)) %>%
          ggplot( aes(x = date, y = dyad_markdown, fill = mean_goldstein)) +
          geom_tile() + theme_bw() +
          tidytext::scale_y_reordered() +
          geomtextpath::geom_textvline(xintercept = as.Date(date_start), label="Crisis Start (ICB)" , linetype="dotted", color = "black", size=3) +
          geomtextpath::geom_textvline(xintercept = as.Date(date_end), label="Crisis End (ICB)" , linetype="dotted", color = "black", size=3) +
          facet_wrap(~cameo_penta_category, scale="free_y", ncol=1)  +
      theme(plot.margin = unit(c(0,0,0,0), "cm")) + theme( axis.text.y = element_markdown(size = 12, lineheight = 0.1)  ) +   scale_fill_gradient2() +
          theme(legend.position="none") +
         ylab("") + xlab("")  
          
    p_terrier_penta %>% saveRDS(save_file_penta)

    
    #_lvl0
    dyad_event_counts <-     terrier_clean_subset  %>% 
                         mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                         filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                         count(cameo_lvl0_label, dyad_lvl0_category) %>% 
                         group_by(cameo_lvl0_label) %>%
                         arrange(cameo_lvl0_label,  desc(n) ) %>% 
                         filter(row_number()<=10) %>% ungroup()     

    terrier_clean_subset_top10 <- terrier_clean_subset %>% 
                                  filter(dyad_lvl0_category %in% dyad_event_counts$dyad_lvl0_category  ) %>%
                                  mutate(dyad_markdown=dyad)
            
    terrier_clean_subset_top10_day <- terrier_clean_subset_top10 %>%
          mutate(story_date=paste(month, day, year, sep="/")) %>%
          filter(!is.na(cameo_penta_category)) %>%
          mutate(date = story_date %>% lubridate::mdy()) %>%
          group_by(dyad_markdown, cameo_lvl0_label, date) %>%
          summarise(mean_goldstein=mean(cameo_goldstein), n=n())
      
    for(i in 1:nrow(names_to_qcodes)){
      #print(i)
      terrier_clean_subset_top10_day <- terrier_clean_subset_top10_day %>%
                                    dplyr::mutate(dyad_markdown = dyad_markdown %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  ))
    } #This is a bottleneck now and needs to move to after the group
    library(ggtext)
    terrier_clean_subset_top10_day <- terrier_clean_subset_top10_day %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("Inter-governmental organizations","IGOs")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government[^a-z]|Government[^a-z]","gov")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all(fixed("(tertiary role code)"),"")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("Unidentified Armed Force","Unknown Mil."))
    
    p_terrier_lv0 <-  terrier_clean_subset_top10_day %>%
          group_by(cameo_lvl0_label, dyad_markdown) %>% mutate(n_all=sum(n, na.rm=T)) %>% ungroup() %>%
          mutate(dyad_markdown = tidytext::reorder_within(dyad_markdown, n_all, within = cameo_lvl0_label)) %>%
          ggplot( aes(x = date, y = dyad_markdown, fill = mean_goldstein)) +
          geom_tile() + theme_bw() +
          tidytext::scale_y_reordered() +
          geomtextpath::geom_textvline(xintercept = as.Date(date_start), label="Crisis Start (ICB)" , linetype="dotted", color = "black", size=3) +
          geomtextpath::geom_textvline(xintercept = as.Date(date_end), label="Crisis End (ICB)" , linetype="dotted", color = "black", size=3) +
          facet_wrap(~cameo_lvl0_label, scale="free_y", ncol=3)  +
      theme(plot.margin = unit(c(0,0,0,0), "cm")) + theme( axis.text.y = element_markdown(size = 12, lineheight = 0.1)  ) + 
       scale_fill_gradient2() +
          theme(legend.position="none") +
         ylab("") + xlab("")  
          
    p_terrier_lv0 %>% saveRDS(save_file_lv0)
        
                
}


fromscratch=F
if(fromscratch){
  #done
  #install.packages("arrow")
  terrier_clean <-  arrow::read_parquet( here::here("git_ignore_folder", "terrier_clean.parquet")) #203mb
  dim(terrier_clean) #28,438,029 #39,322,909 #7,847,463
  
  c(196, 471) %>% sapply(FUN=function(x) terrier_barmaps(x))
}

```

```{r ICEWS data loads, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

fromscratch=F
if(fromscratch){
  #accidentally loaded the pdfs
  files <- list.files(path = paste0(here::here(), "/git_ignore_folder/dataverse_files/"), full.names = T, pattern = ".tab$|.tsv$") #there's both tab and tsv for some reason
  icews <- bind_rows(lapply(files, FUN=function(x) read_tsv(x, show_col_types = FALSE) )  ) %>% janitor::clean_names() %>% distinct()
  dim(icews) #18,403,260 #15,751,586
  
  codes_used <-icews %>% count(cameo_code)
  
  actor_translator_icews <- actor_translator %>%  dplyr::select(ICEWS_Actor.Name, ICEWS_Country, QCode, QCode_name)
  #%>% mutate(icews=ifelse(ICEWS_Country=="International Government Organizations", ICEWS_Actor.Name, ICEWS_Country))
  
  #Going to heavily filter on source sectors and source name
  #c(icews$source_sectors,icews$source_name) %>% table()
  
  #This doesn't totally work because India has 3 copies. The lower thing gets a different q code than the higher thing, so we first have to try to match on the lower, and if that fails match on the higher kinda
  #Indian Administered Kashmir		India
  
    #library("remotes")
  #remotes::install_github("andybega/icews")
  library(icews)
  data("cameo_codes") #we're going to grab the cameo codes from the ICEWS package because they're a nightmare
  cameo_codes_goldstein <- cameo_codes %>% left_join(goldstein_mappings) %>% mutate(name=name %>% tolower())
    
  dim(icews) #18,403,260 #15,751,586
  icews_clean <- icews %>% 
                 #filter(event_id==20776790) %>% 
                 #head(10000) %>%
                 mutate_if(is.character, na_if, "null") %>%
                 mutate_if(is.character, na_if, "NULL") %>%
                 #head(1000) %>%
                 mutate(where = coalesce(city, district,province)) %>%
                 left_join(cameo_codes_goldstein %>% mutate(cameo_code=cameo_code ) %>%
                             dplyr::select(cameo_code=cameo_code, cameo_label= name, cameo_goldstein=goldstein, cameo_penta_category=penta_category,
                                           cameo_lvl0=lvl0)  ) %>% #it's that insane cameo code bug
                 left_join(    cameo_codes_goldstein %>% filter(level==0) %>% dplyr::select(cameo_lvl0=lvl0, cameo_lvl0_label=name)) %>% #it's that insane cameo code bug    
                 mutate( cameo_label= cameo_label %>% str_replace(', not specified below','')) %>% 
    
                left_join( actor_translator_icews %>% dplyr::select(source_name=ICEWS_Actor.Name,  source_q_code_actor=QCode, source_q_label_actor=QCode_name) %>% 
                             distinct() %>% na.omit() ) %>%
                left_join( actor_translator_icews %>% filter(is.na(ICEWS_Actor.Name)) %>% 
                             dplyr::select(source_country=ICEWS_Country,  source_q_code_country=QCode, source_q_label_country=QCode_name) %>% 
                             distinct() %>% na.omit() ) %>%
                mutate(source_q_code=ifelse(!is.na(source_q_code_actor) , source_q_code_actor, source_q_code_country)) %>%
                mutate(source_label=ifelse(!is.na(source_q_code_actor) , source_q_label_actor, source_q_label_country)) %>%
  
                left_join( actor_translator_icews %>% dplyr::select(target_name=ICEWS_Actor.Name,  target_q_code_actor=QCode, target_q_label_actor=QCode_name) %>% 
                             distinct() %>% na.omit() ) %>%
                left_join( actor_translator_icews %>% filter(is.na(ICEWS_Actor.Name)) %>% 
                             dplyr::select(target_country=ICEWS_Country,  target_q_code_country=QCode, target_q_label_country=QCode_name) %>%
                             distinct() %>% na.omit() ) %>%
                mutate(target_q_code=ifelse(!is.na(target_q_code_actor) , target_q_code_actor, target_q_code_country)) %>%
                mutate(target_label=ifelse(!is.na(target_q_code_actor) , target_q_label_actor, target_q_label_country)) %>%
  
                mutate(source_target_q_code= paste0(source_q_code,"_",target_q_code)) %>%
    
                left_join( actor_translator_icews %>% filter(is.na(ICEWS_Actor.Name)) %>% dplyr::select(country=ICEWS_Country,  country_q_code=QCode) %>% distinct() %>% na.omit() ) %>%
                mutate(year = event_date %>% lubridate::year()  )  %>%
                mutate(month = event_date %>% lubridate::month()  )  %>%
                mutate(day = event_date %>% lubridate::day()  )  %>%
                mutate(month_label = lubridate::month(month %>% as.numeric(),label=TRUE,abbr=F)) %>%
                mutate(source_sectors = source_sectors %>% tolower()) %>%
                mutate(target_sectors = target_sectors %>% tolower()) %>%
                mutate(cameo_label = cameo_label %>% str_replace(", not specified below","") ) %>%
                mutate(who_a = coalesce(source_name,source_sectors %>% tolower(), source_label ) ) %>%
                mutate(who_b = coalesce(target_name,target_sectors %>% tolower(), target_label ) ) %>%
                mutate(who_a = ifelse(who_a %in% source_country, NA, who_a)) %>%
                mutate(who_b = ifelse(who_b %in% target_country, NA, who_b)) %>%
                unite(text, 
                      source_country,who_a,  
                      cameo_label, 
                      who_b, target_country, sep=" ", remove = F, na.rm = T) %>%
                mutate(text = ifelse(!is.na(where),paste0(text, " in ", where),text) ) %>% 
                mutate(text = paste0("On ", month_label, " ",day," ",year, ", ", text)) 
  
    dim(icews_clean) #17,541,701 #1,965,573 it's still too many but it's just close enough now #1,965,573
  
    icews_clean %>% arrow::write_parquet(here::here("git_ignore_folder", "icews_clean.parquet") )
    

    #icews_clean %>% count(source_country) %>% dim() #233
    #icews_clean %>% count(source_country, source_sectors) %>% dim() #404673
    #icews_clean %>% count(source_country, source_sectors, source_name) %>% dim() #569374
    #icews_clean %>% count(cameo_label) %>% dim() #272
    
    dim(icews_clean) #17,541,701
    library(dplyr)
    library(digest)
    keep_list <- c("Ukraine", "Russia","Russian Federation", 'North Atlantic Treaty Organization', 'NATO', 'European Union', 'Crimea','Donbas','Donetsk', 'Luhansk' ) #, 'United Nations'
    keep_list <- c(keep_list, keep_list %>% tolower())
    icews_clean_471 <- icews_clean %>% 
                       filter( event_date>= as.Date("2013-01-01") & event_date<= as.Date("2015-12-31") ) %>%
                      unite('temp', country , target_name , target_country, where , 
                            source_q_label_country,target_q_label_country,  source_label, target_label,who_a, who_b,province, district, city,
                            na.rm = TRUE, remove = FALSE) %>% #this is probably slow need to check
                       filter( temp %>% str_detect(paste0(keep_list,collapse="|"))) %>%
                       dplyr::select(-temp)
    dim(icews_clean_471) #281,427
    
    #icews_clean_471 %>% write_tsv("/mnt/8tb_a/rwd_github_private/ICBEdataset/replication_paper/data/out/icews_clean_471.tsv")
    
    #icews_clean_471 %>%
    #  unite('actors_left' , source_country, source_label, source_name, source_sectors,  sep=" ", , na.rm =T, remove=F) %>%
    #  unite('actors_right', target_country, target_label, target_name, target_sectors, sep=" ", , na.rm =T, remove=F) %>%
    #  dplyr::select(event_id, year, month, day, actors_left, actors_right,cameo_event_label=cameo_label, text ) %>% 
    #  write_tsv("/mnt/8tb_a/rwd_github_private/ICBEdataset/replication_paper/data/out/icews_clean_471_small.tsv")


}

    
```

```{r icews_barmaps, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)
library(stringr)

icews_barmaps <- function(thiscrisis=471, topactor=F){

    print(thiscrisis)
    plot_title <- crisno_name_years %>% filter(crisno==thiscrisis) %>% mutate(title="Crisis #" %>% paste0(crisno, " ", crisname, " (", yrtrig, "-",yrterm,")")) %>% pull(title)
    save_file_penta <- paste0(here::here(), "/replication_paper/pnas_draft/p_icews_plot_penta_",thiscrisis,".Rds")
    save_file_lv0 <- paste0(here::here(), "/replication_paper/pnas_draft/p_icews_plot_lv0_",thiscrisis,".Rds")

    date_start <- lubridate::as_date(paste0(icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig , "-", icb_crises[icb_crises$crisno==thiscrisis,]$motrig, "-01"))
    date_end <- lubridate::as_date(paste0(icb_crises[icb_crises$crisno==thiscrisis,]$yrterm , "-", icb_crises[icb_crises$crisno==thiscrisis,]$moterm, "-01"))
    date_end <- date_end %>% lubridate::ceiling_date() %>% lubridate::as_date()
    
    year_start <- icb_crises[icb_crises$crisno==thiscrisis,]$yrtrig
    year_end   <- icb_crises[icb_crises$crisno==thiscrisis,]$yrterm 
    
    start_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$start_simple
    end_simple <- icb_crises[icb_crises$crisno==thiscrisis,]$end_simple

    actors <- icb_events_long %>% filter(crisno %in% thiscrisis) %>% filter(varname_normalized %>% str_detect('actor')) %>% 
              dplyr::select(value_normalized,value_qcode) %>% distinct()
    #library(re2r) #didn't speed it up and enabling parallel was actually slower, not sure what's going on usually very fast
    library(tictoc)
    tictoc::tic() 
    icews_clean_subset <- icews_clean %>% 
                          mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() ) %>%
                          filter(story_date>=(date_start-lubridate::years(1)) & story_date<=(date_end+lubridate::years(1))) %>%  
                          unite('temp', country , target_name , target_country, where , 
                                source_q_label_country,target_q_label_country,  source_label, target_label,who_a, who_b,province, district, city,
                                na.rm = TRUE, remove = FALSE) %>% #this is probably slow need to check
                          filter(temp %>% str_detect(actors$value_normalized %>% paste0(collapse="|"))) %>% #this is slow and maybe replacing with re2r will fix
                          unite('dyad_a', source_name ,  na.rm = TRUE, remove = FALSE) %>%
                          unite('dyad_b', target_name ,  na.rm = TRUE, remove = FALSE) %>%
                          mutate(dyad=paste0(dyad_a,"->",dyad_b)) %>%
                          mutate(dyad_event=paste0(dyad, "_", cameo_label)) %>%
                          mutate(dyad_penta_category=paste0(dyad, "_", cameo_penta_category)) %>%
                          mutate(dyad_lv10=paste0(dyad, "_", cameo_lvl0_label)) %>%
                          dplyr::select(-temp)
    tictoc::toc() #85.212
    dim(icews_clean_subset) #441,588 #586,406
 
    #Penta
    dyad_event_counts <-     icews_clean_subset  %>% 
                             mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                             filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                             count(cameo_penta_category, dyad_penta_category) %>% 
                             group_by(cameo_penta_category) %>%
                             arrange(cameo_penta_category,  desc(n) ) %>% 
                             filter(row_number()<=10) %>% ungroup() 

    names_to_qcodes <- actor_translator %>% dplyr::select(QCode, contains("name")) %>%
                       pivot_longer(-c(QCode)) %>% na.omit() %>% dplyr::select(-name) %>% distinct() %>%
                       mutate(markdown = glue::glue("![]({flag_folder_small}/{QCode}.png)") ) 
    names_to_qcodes <- bind_rows(names_to_qcodes, names_to_qcodes %>% mutate(value= value %>% tolower() )) %>% distinct() %>%
                       arrange(desc(nchar(value))) #sort by length so you never accidentally replace a subset
    
    icews_clean_subset_top10 <- icews_clean_subset %>% 
                                filter(dyad_penta_category %in% dyad_event_counts$dyad_penta_category  ) 

    icews_clean_subset_top10_day <- icews_clean_subset_top10 %>%
                                    mutate(story_date=paste(month, day, year, sep="/")) %>%
                                    filter(!is.na(cameo_penta_category)) %>%
                                    mutate(date = story_date %>% lubridate::mdy()) %>%
                                    group_by(dyad_markdown=dyad, cameo_penta_category, date) %>% #rename dyad dyad_markdown here
                                    summarise(mean_goldstein=mean(cameo_goldstein), n=n())
      
    for(i in 1:nrow(names_to_qcodes)){
      #print(i)
      icews_clean_subset_top10_day <- icews_clean_subset_top10_day %>%
                                    dplyr::mutate(dyad_markdown = dyad_markdown %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  ))
    } #This is a bottleneck now and needs to move to after the group
    library(ggtext)
    icews_clean_subset_top10_day <- icews_clean_subset_top10_day %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government|Government","gov")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("(tertiary role code)","")) %>%
                                     mutate(dyad_markdown = dyad_markdown %>% str_replace_all("International Committee of the Red Cross","Red Cross"))
    
    p_icews_penta <-  icews_clean_subset_top10_day %>%
            group_by(cameo_penta_category, dyad_markdown) %>% mutate(n_all=sum(n, na.rm=T)) %>% ungroup() %>%
            mutate(dyad_markdown = tidytext::reorder_within(dyad_markdown, n_all, within = cameo_penta_category)) %>%
            ggplot( aes(x = date, y = dyad_markdown, fill = mean_goldstein)) +
            geom_tile() + theme_bw() +
            tidytext::scale_y_reordered() +
            geomtextpath::geom_textvline(xintercept = as.Date(date_start), label="Crisis Start (ICB)" , linetype="dotted", color = "black", size=3) +
            geomtextpath::geom_textvline(xintercept = as.Date(date_end), label="Crisis End (ICB)" , linetype="dotted", color = "black", size=3) +
            facet_wrap(~cameo_penta_category, scale="free_y", ncol=1)  +
            theme(plot.margin = unit(c(0,0,0,0), "cm")) + 
            theme( axis.text.y = element_markdown(size = 12, lineheight = 0.1)  ) + 
            scale_fill_gradient2() +
            theme(legend.position="none") +
            ylab("") + xlab("")  #+
            #geomtextpath::geom_textvline(xintercept = as.Date('2015-02-21'), label="MINSK II" , linetype="dotted", color = "red", size=3)  #+
            #labs(subtitle=keys %>% paste(collapse="; "))
    
    
    p_icews_penta %>% saveRDS(save_file_penta)
        
        
    #lv0
    dyad_event_counts <-     icews_clean_subset  %>% 
                             mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                             filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                             count(cameo_lvl0_label, dyad_lv10) %>% 
                             group_by(cameo_lvl0_label) %>%
                             arrange(cameo_lvl0_label,  desc(n) ) %>% 
                             filter(row_number()<=10) %>% ungroup() 

    names_to_qcodes <- actor_translator %>% dplyr::select(QCode, contains("name")) %>%
                       pivot_longer(-c(QCode)) %>% na.omit() %>% dplyr::select(-name) %>% distinct() %>%
                       mutate(markdown = glue::glue("![]({flag_folder_small}/{QCode}.png)") ) 
    names_to_qcodes <- bind_rows(names_to_qcodes, names_to_qcodes %>% mutate(value= value %>% tolower() )) %>% distinct() %>%
                       arrange(desc(nchar(value))) #sort by length so you never accidentally replace a subset
    
    icews_clean_subset_top10 <- icews_clean_subset %>% 
                                filter(dyad_lv10 %in% dyad_event_counts$dyad_lv10  ) %>%
                                mutate(dyad_markdown=dyad)

    dyad_unique <-     bind_rows(
      icews_clean_subset_top10 %>% dplyr::select(dyad_unique=dyad_a) %>% distinct(),
      icews_clean_subset_top10 %>% dplyr::select(dyad_unique=dyad_b) %>% distinct()
    ) %>% distinct() %>% mutate(dyad_unique_markup = dyad_unique)
    
    for(i in 1:nrow(names_to_qcodes)){
      #print(i)
      dyad_unique <- dyad_unique %>% dplyr::mutate(dyad_unique_markup = dyad_unique_markup %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  ))
      #print(head(dyad_unique,2))
    }
        
    icews_clean_subset_top10_day <- icews_clean_subset_top10 %>%
                                    left_join(dyad_unique %>% dplyr::select(dyad_a=dyad_unique, dyad_a_markup=dyad_unique_markup) ) %>%
                                    left_join(dyad_unique %>% dplyr::select(dyad_b=dyad_unique, dyad_b_markup=dyad_unique_markup) ) %>%
                                    mutate(dyad_markdown=paste0(dyad_a_markup,"->",dyad_b_markup)) %>%
                                    mutate(story_date=paste(month, day, year, sep="/")) %>%
                                    filter(!is.na(cameo_lvl0_label)) %>%
                                    mutate(date = story_date %>% lubridate::mdy()) %>%
                                    group_by(dyad_markdown, cameo_lvl0_label, date) %>%
                                    summarise(mean_goldstein=mean(cameo_goldstein), n=n())
    
    library(ggtext)
    icews_clean_subset_top10_day <- icews_clean_subset_top10_day %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government|Government","gov")) %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("(tertiary role code)","")) %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("International Committee of the Red Cross","Red Cross"))
    
    p_icews_lv0 <-  icews_clean_subset_top10_day %>%
            group_by(cameo_lvl0_label, dyad_markdown) %>% mutate(n_all=sum(n, na.rm=T)) %>% ungroup() %>%
            mutate(dyad_markdown = tidytext::reorder_within(dyad_markdown, n_all, within = cameo_lvl0_label)) %>%
            ggplot( aes(x = date, y = dyad_markdown, fill = mean_goldstein)) +
            geom_tile() + theme_bw() +
            tidytext::scale_y_reordered() +
            geomtextpath::geom_textvline(xintercept = as.Date(date_start), label="Crisis Start (ICB)" , linetype="dotted", color = "black", size=3) +
            geomtextpath::geom_textvline(xintercept = as.Date(date_end), label="Crisis End (ICB)" , linetype="dotted", color = "black", size=3) +
            facet_wrap(~cameo_lvl0_label, scale="free_y", ncol=3)  +
            theme(plot.margin = unit(c(0,0,0,0), "cm")) +
            theme( axis.text.y = element_markdown(size = 12, lineheight = 0.1)  ) +
            scale_fill_gradient2() +
            theme(legend.position="none") +
            ylab("") + xlab("")  
    
    
    p_icews_lv0 %>% saveRDS(save_file_lv0)
        
    #Make one more special grouping for the main paper
    dyad_event_counts <-     icews_clean_subset  %>% 
                             mutate(story_date=paste(month, day, year, sep="/")  %>% lubridate::mdy() )  %>%
                             filter(story_date>=(date_start %>% as.Date()) & story_date<=(date_end %>% as.Date() )) %>%
                             count(cameo_label, dyad_event) %>%  #down to the lowest level of aggregation
                             group_by(cameo_label) %>%
                             arrange(cameo_label,  desc(n) ) %>% 
                             filter(row_number()<=10) %>% ungroup() 

    names_to_qcodes <- actor_translator %>% dplyr::select(QCode, contains("name")) %>%
                       pivot_longer(-c(QCode)) %>% na.omit() %>% dplyr::select(-name) %>% distinct() %>%
                       mutate(markdown = glue::glue("![]({flag_folder_small}/{QCode}.png)") ) 
    names_to_qcodes <- bind_rows(names_to_qcodes, names_to_qcodes %>% mutate(value= value %>% tolower() )) %>% distinct() %>%
                       arrange(desc(nchar(value))) #sort by length so you never accidentally replace a subset
    
    icews_clean_subset_top10 <- icews_clean_subset %>% 
                                filter(dyad_event %in% dyad_event_counts$dyad_event  ) %>%
                                mutate(dyad_markdown=dyad)

    dyad_unique <-     bind_rows(
      icews_clean_subset_top10 %>% dplyr::select(dyad_unique=dyad_a) %>% distinct(),
      icews_clean_subset_top10 %>% dplyr::select(dyad_unique=dyad_b) %>% distinct()
    ) %>% distinct() %>% mutate(dyad_unique_markup = dyad_unique)
    
    for(i in 1:nrow(names_to_qcodes)){
      #print(i)
      dyad_unique <- dyad_unique %>% dplyr::mutate(dyad_unique_markup = dyad_unique_markup %>% str_replace_all(names_to_qcodes$value[i], names_to_qcodes$markdown[i]  ))
      #print(head(dyad_unique,2))
    }
        
    icews_clean_subset_top10_day <- icews_clean_subset_top10 %>%
                                    left_join(dyad_unique %>% dplyr::select(dyad_a=dyad_unique, dyad_a_markup=dyad_unique_markup) ) %>%
                                    left_join(dyad_unique %>% dplyr::select(dyad_b=dyad_unique, dyad_b_markup=dyad_unique_markup) ) %>%
                                    mutate(dyad_markdown=paste0(dyad_a_markup,"->",dyad_b_markup)) %>%
                                    mutate(story_date=paste(month, day, year, sep="/")) %>%
                                    filter(!is.na(cameo_label)) %>%
                                    mutate(date = story_date %>% lubridate::mdy()) %>%
                                    group_by(dyad_markdown, cameo_label, date) %>%
                                    summarise(mean_goldstein=mean(cameo_goldstein), n=n())
    
    library(ggtext)
    icews_clean_subset_top10_day <- icews_clean_subset_top10_day %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("government|Government","gov")) %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("law enforcement agencies","law enforcement")) %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("(tertiary role code)","")) %>%
                                    mutate(dyad_markdown = dyad_markdown %>% str_replace_all("International Committee of the Red Cross","Red Cross"))
    icews_clean_subset_top10_day %>% write_tsv(here::here("replication_paper", "data", "out", "icews_clean_471_lowest.tsv"))
    #just out the tsv and plot how you want in the main paper
            
}



fromscratch=F
if(fromscratch){
  #done
  #install.packages("arrow")
  icews_clean <-  arrow::read_parquet(here::here("git_ignore_folder", "icews_clean.parquet") )

  c( 471) %>% sapply(FUN=function(x) icews_barmaps(x))
}

```

```{r crisis 196, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

## Dyadic ICB
save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_icb_metro_plot_196.Rds')
p_metro_plot <- readRDS(save_file)
actor_colors <- p_metro_plot$actor_colors
subtitle="ICB Dyadic Events"
caption=paste0("Data: Dyadic International Crisis Behavior (ICB) (Hewitt 2003)
             ", p_metro_plot$labels$caption) #tag original to bottom

p_196_icb <- p_metro_plot +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
  labs(
    #title = plot_title ,
    #subtitle = subtitle ,
    #caption = caption
  ) 

save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_icb_metro_plot_196.Rds')
p_metro_plot <- readRDS(save_file)
p_196_phoenix <- p_metro_plot +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
  labs(
    #title = plot_title ,
    #subtitle = subtitle ,
    #caption = caption
  ) 

## MIDs
library(ggplot2)
save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_mids_metro_plot_196.Rds') 
p_metro_plot <- readRDS(save_file)
actor_colors <- p_metro_plot$actor_colors
subtitle="Dyadic Militarized Interstate Disputes (MIDs)"
caption=paste0("Source: CrisisEvents.org (Douglass et al. 2021)
                Data: Dyadic Militarized Interstate Disputes (MIDs) (Maoz et al. 2019)
             ", p_metro_plot$labels$caption
             ) #tag original to bottom
p_196_mids <- p_metro_plot +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
  labs(
    #title = plot_title ,
    #subtitle = subtitle ,
    #caption = caption
  ) 
#ggsave(file=paste0(here::here(), '/replication_paper/pnas_draft/p_mids_metro_plot_196.png'),
#       plot = p_metro_plot ,
#       width=12, height=14)



## Phoenix Crisis Map
#ICBe  196
library(ggplot2)
save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_phoenix_plot_penta_196.Rds')
subtitle="Phoenix Dyadic Events"
caption=paste0("Data: Cline Center Historical Phoenix Event Data (Althaus et al. 2017)
             ", p_metro_plot$labels$caption) #tag original to bottom

p_196_phoenix <- readRDS(save_file) +
    labs(
      #title = plot_title ,
      #subtitle = subtitle ,
      #caption = caption
    )
#ggsave(file=paste0(here::here(), '/replication_paper/pnas_draft/p_phoenix_metro_plot_196.png'),
#       plot = p_metro_plot ,
#       width=12, height=14)

library(cowplot)
p_196_combined <- 
           plot_grid(
            p_196_icb  +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
           scale_x_continuous(expand = expansion(mult = c(0.2, 0.2))) +
           scale_y_continuous(expand = expansion(mult = c(0.15, 0.15))) , 
           
           p_196_mids +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
           scale_x_continuous(expand = expansion(mult = c(0.2, 0.2))) +
           scale_y_continuous(expand = expansion(mult = c(0.15, 0.15))) , 
   
           p_196_phoenix +
           theme(plot.margin=unit(c(0,0,0,0),"in")) + theme(legend.position="none") 
           #scale_x_continuous(expand = expansion(mult = c(0.2, 0.2))) +
           #scale_y_continuous(expand = expansion(mult = c(0.8, 0.2))) ,  
           ,
           labels = c('ICB','MIDs','Phoenix'), align = "h", ncol = 3 , rel_widths = c(1, 1,1) 
)

save_plot(file=paste0(here::here(), '/replication_paper/pnas_draft/p_196_combined.png'),
          p_196_combined, base_height = 12, base_width = 20)
#I'm just going to rotate on disk and load it as a normal figure
#\begin{sidewaysfigure}[H] #can't trust sideways plots either so have to rate the image
```

\begin{sideways}%[htbp]
\centering{\includegraphics[width=21cm]{./p_196_combined.png}}
\end{sideways}
\clearpage

```{r, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

if(fromscratch){
  p_phoenix_plot_lv0_196 <- readRDS(here::here("replication_paper", "pnas_draft", "p_phoenix_plot_lv0_196.Rds"))
  save_plot(file=paste0(here::here(), '/replication_paper/pnas_draft/p_phoenix_plot_lv0_196.png'),
            p_phoenix_plot_lv0_196 + theme(legend.position="none") + ylab(''), base_height = 15, base_width = 20, limitsize = FALSE)
}
```


\hphantom{em}
\begin{sidewaysfigure}[ht]
\caption{Crisis Maps - Cuban Missiles - Phoenix Disaggregated \label{fig:p_phoenix_plot_lv0_196}}
\centering{\includegraphics[width=21cm]{./p_phoenix_plot_lv0_196.png}}
\end{sidewaysfigure}
\clearpage

## Figure D4 Crisis Maps Crimea-Donbas

\hphantom{em}

```{r eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

#\caption{Crisis Maps - Cuban Missile Crisis}
#\captionof{figure}{Crisis Maps - Cuban Missile Crisis }
#\caption{Crisis Maps - Cuban Missile Crisis \label{fig:p_196_combined}}
#\begin{sidewaysfigure}[ht]
#\end{sidewaysfigure}

#Crisis maps for the non ICBe datasets for the two case studies

library(ggplot2)
library(cowplot)
library(ggtext)

## MIDs
library(ggplot2)
save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_mids_metro_plot_471.Rds') 
p_metro_plot <- readRDS(save_file)
actor_colors <- p_metro_plot$actor_colors
subtitle="Dyadic Militarized Interstate Disputes (MIDs)"
caption=paste0("Source: CrisisEvents.org (Douglass et al. 2021)
                Data: Dyadic Militarized Interstate Disputes (MIDs) (Maoz et al. 2019)
             ", p_metro_plot$labels$caption
             ) #tag original to bottom
p_471_mids <- p_metro_plot +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
  labs(
    #title = plot_title ,
    #subtitle = subtitle ,
    #caption = caption
  ) 
#ggsave(file=paste0(here::here(), '/replication_paper/pnas_draft/p_mids_metro_plot_196.png'),
#       plot = p_metro_plot ,
#       width=12, height=14)



## Phoenix Crisis Map
#ICBe  196
library(ggplot2)
save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_phoenix_plot_penta_471.Rds')
subtitle="Phoenix Dyadic Events"
caption=paste0("Data: Cline Center Historical Phoenix Event Data (Althaus et al. 2017)
             ", p_metro_plot$labels$caption) #tag original to bottom

p_471_phoenix <- readRDS(save_file) +
    labs(
      #title = plot_title ,
      #subtitle = subtitle ,
      #caption = caption
    )
#ggsave(file=paste0(here::here(), '/replication_paper/pnas_draft/p_phoenix_metro_plot_196.png'),
#       plot = p_metro_plot ,
#       width=12, height=14)


save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_terrier_plot_penta_471.Rds')
subtitle="Terrier Dyadic Events"
caption=paste0("Data: Terrier (Grant et al. 2021)
             ", p_metro_plot$labels$caption) #tag original to bottom

p_471_terrier <- readRDS(save_file) +
    labs(
      #title = plot_title ,
      #subtitle = subtitle ,
      #caption = caption
    )

save_file=paste0(here::here(), '/replication_paper/pnas_draft/p_icews_plot_penta_471.Rds')
p_471_icews <- readRDS(save_file) 


library(cowplot)
p_471_combined <- 
           plot_grid(

           p_471_mids +
           theme(plot.margin=unit(c(0,0,0,0),"in")) +
           scale_x_continuous(expand = expansion(mult = c(0.2, 0.2))) +
           scale_y_continuous(expand = expansion(mult = c(0.15, 0.15))) + ylab('') , 
   
           p_471_phoenix +
           theme(plot.margin=unit(c(0,0,0,0),"in")) + theme(legend.position="none") + ylab('') , #+
           #scale_x_continuous(expand = expansion(mult = c(0.2, 0.2))) +
           #scale_y_continuous(expand = expansion(mult = c(0.8, 0.2))) ,  
           
           p_471_terrier +
           theme(plot.margin=unit(c(0,0,0,0),"in")) + theme(legend.position="none") + ylab('') , #+
           #scale_x_continuous(expand = expansion(mult = c(0.2, 0.2))) +
           #scale_y_continuous(expand = expansion(mult = c(0.8, 0.2))) ,  
           p_471_icews +
           theme(plot.margin=unit(c(0,0,0,0),"in")) + theme(legend.position="none") + ylab('') , #+
           
           labels = c('MIDs','Phoenix', 'Terrier', 'ICEWs'), align = "h", ncol = 4 , rel_widths = c(1, 1,1,1) 
)

save_plot(file=paste0(here::here(), '/replication_paper/pnas_draft/p_471_combined.png'),
          p_471_combined, base_height = 12, base_width = 25)

```

\hphantom{em}
\begin{sidewaysfigure}[ht]
\caption{Crisis Maps - Crimea-Donbas \label{fig:p_471_combined}}
\centering{\includegraphics[width=21cm]{./p_471_combined.png}}
\end{sidewaysfigure}
\clearpage

```{r, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

if(fromscratch){
  p_phoenix_plot_lv0_471 <- readRDS(here::here("replication_paper", "pnas_draft", "p_phoenix_plot_lv0_471.Rds"))
  save_plot(file=paste0(here::here(), '/replication_paper/pnas_draft/p_phoenix_plot_lv0_471.png'),
            p_phoenix_plot_lv0_471 + theme(legend.position="none") + ylab(''), base_height = 15, base_width = 20, limitsize = FALSE)
}
```


\hphantom{em}
\begin{sidewaysfigure}[ht]
\caption{Crisis Maps - Crimea-Donbas Phoenix Disaggregated \label{fig:p_phoenix_plot_lv0_471}}
\centering{\includegraphics[width=21cm]{./p_phoenix_plot_lv0_471.png}}
\end{sidewaysfigure}
\clearpage

```{r, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

if(fromscratch){
  p_terrier_plot_lv0_471 <- readRDS(here::here("replication_paper", "pnas_draft", "p_terrier_plot_lv0_471.Rds"))
  save_plot(file=paste0(here::here(), '/replication_paper/pnas_draft/p_terrier_plot_lv0_471.png'),
            p_terrier_plot_lv0_471 + theme(legend.position="none") + ylab(''), base_height = 15, base_width = 20, limitsize = FALSE)
}
```


\hphantom{em}
\begin{sidewaysfigure}[ht]
\caption{Crisis Maps - Crimea-Donbas Terrier Disaggregated \label{fig:p_terrier_plot_lv0_471}}
\centering{\includegraphics[width=21cm]{./p_terrier_plot_lv0_471.png}}
\end{sidewaysfigure}
\clearpage

```{r, eval=T, results='hide', echo=F, include=T, message=F, cache=F, warning=F}

if(fromscratch){
  p_icews_plot_lv0_471 <- readRDS(here::here("replication_paper", "pnas_draft", "p_icews_plot_lv0_471.Rds"))
  save_plot(file=paste0(here::here(), '/replication_paper/pnas_draft/p_icews_plot_lv0_471.png'),
            p_icews_plot_lv0_471 + theme(legend.position="none") + ylab(''), base_height = 15, base_width = 20, limitsize = FALSE)
}
```


\hphantom{em}
\begin{sidewaysfigure}[ht]
\caption{Crisis Maps - Crimea-Donbas ICEWs Disaggregated \label{fig:p_icews_plot_lv0_471}}
\centering{\includegraphics[width=21cm]{./p_icews_plot_lv0_471.png}}
\end{sidewaysfigure}
\clearpage

# References

\hphantom{em}




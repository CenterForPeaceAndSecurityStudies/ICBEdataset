---
title: "Table Sentences"
output: html_document
---

# Convert codings to sentences


```{r}

#names(codings_wide_agreed)
library(tidyverse)
library(flextable)
library(ftExtra)
library(glue)


codings_long_agreement <- readRDS( paste0(here::here(), "ICBEdataset/data_out/codings_long_agreement.Rds")) 
codings_long_agreement_1_3 <- codings_long_agreement %>% filter(crisno==1 & sentence_number_int_aligned==3)
codings_long_agreement_2_11 <- codings_long_agreement %>% filter(crisno==2 & sentence_number_int_aligned==11)
codings_long_agreement_252_5 <- codings_long_agreement %>% filter(crisno==253 & sentence_number_int_aligned==5)
codings_long_agreement_209_3 <- codings_long_agreement %>% filter(crisno==209 & sentence_number_int_aligned==3)
codings_long_agreement_265_28 <- codings_long_agreement %>% filter(crisno==265 & sentence_number_int_aligned==28) #
codings_long_agreement_457_4 <- codings_long_agreement %>% filter(crisno==457 & sentence_number_int_aligned==4) #
codings_long_agreement_384_43 <- codings_long_agreement %>% filter(crisno==384 & sentence_number_int_aligned==43) #



#You have to rerun the embeddings too
codings_wide_agreed_embeded <- readRDS( paste0(here::here(), "ICBEdataset/data_out/codings_wide_agreed_embeded.Rds")) 
codings_wide_agreed_embeded_2_11 <- codings_wide_agreed_embeded %>% filter(crisno==2 & sentence_number_int_aligned==11)
codings_wide_agreed_embeded_265_28 <- codings_wide_agreed_embeded %>% filter(crisno==265 & sentence_number_int_aligned==28) #behavior is missing for one of them, do we want to call that degenerate?
codings_wide_agreed_embeded_384_43 <- codings_wide_agreed_embeded %>% filter(crisno==384 & sentence_number_int_aligned==43) #behavior is missing for one of them, do we want to call that degenerate?




codings_wide_agreed_embeded_stratified_sample  <- codings_wide_agreed_embeded %>% 
                                                  mutate(UMAP1_round=UMAP1 %>%  round(), UMAP2_round=UMAP2 %>%  round()) %>%
                                                  dplyr::group_by(UMAP1_round,UMAP2_round) %>%
                                                  arrange(UMAP1,UMAP2) %>%
                                                  filter(crisno==crisno[1], sentence_number_int_aligned==sentence_number_int_aligned[1] )


#https://github.com/tidyverse/glue/issues/42
#On why you have to include parent frame https://github.com/tidyverse/glue/issues/42
glue_rex <- function(x) glue(x, .open = "{|",.close = "|}", .envir = parent.frame()) #escape variables in the more complicated {||} syntax
events <- NULL
event_to_sentence_rex <- function(events){

  sentence <- paste0("'",events[1,]$sentence,"'")
  df_temp <- NULL
  df_temp <- data.frame(
      type = c('E1','E2','E3','E4','E5','E6','E7','E8'), 
      text = c(NA,NA,NA,NA,NA,NA,NA,NA)
      ) 
  
  #debug
  
  #events %>% janitor::remove_empty() %>% t() %>% View()
  for(j in 1:nrow(events)){
    print(j)
    e1 <- NULL
    e1 <- events[j,, drop=F]
    #Replace the q codes with names
    crisis_actors <- dictionary_actors_labels %>% filter(crisno==e1$crisno)
    crisis_actors_set <- crisis_actors$value_normalized_label
    names(crisis_actors_set) <- crisis_actors$value_normalized
    
    e1$say_actor_a <- crisis_actors_set[e1$say_actor_a %>% str_split(";") %>% unlist()]  %>% na.omit() %>% paste0(collapse=";")
    e1$say_actor_b <- crisis_actors_set[e1$say_actor_b %>% str_split(";") %>% unlist()] %>% na.omit() %>% paste0(collapse=";")
    e1$do_actor_a <- crisis_actors_set[e1$do_actor_a %>% str_split(";") %>% unlist()] %>% na.omit() %>% paste0(collapse=";")
    e1$do_actor_b <- crisis_actors_set[e1$do_actor_b %>% str_split(";") %>% unlist()] %>% na.omit() %>% paste0(collapse=";")
    e1$think_actor_a <- crisis_actors_set[e1$think_actor_a %>% str_split(";") %>% unlist()] %>% na.omit() %>% paste0(collapse=";")
    e1[e1==''] <- NA #
    
    think=NA
    think=glue_rex("[{|e1$think_actor_a|}]{.underline text.color='black'} experienced a 
                    [{|e1$leaf_think_original|}]{.underline text.color='black'} about 
                    [{|e1$think_sentence_events|}]{.underline text.color='black'}.") 
        
    say=NA
    say= glue_rex("[{|e1$say_actor_a|}]{.underline text.color='black'} initiated
                  [{|e1$leaf_say_original|}]{.underline text.color='black'} toward  
                  [{|e1$say_actor_b|}]{.underline text.color='black'}.") 
    

    
    consequence=NA
    consequence=ifelse(
      e1$consequence %in% "will happen",
      glue_rex("That the following will [happen]{.underline text.color='black'}.") ,
      consequence
    )
    consequence=ifelse(
      e1$consequence %in% "won't happen",
      glue_rex("That if the following [won't happen]{.underline text.color='black'}.") ,
      consequence
    )
    
    condition=NA
    condition=ifelse(
      e1$condition %in% "happens",
      glue_rex("If the following [happens]{.underline text.color='black'}.") ,
      condition
    )
    condition=ifelse(
      e1$condition %in% "does not happen",
      glue_rex("If the following [does not happen]{.underline text.color='black'}.") ,
      condition
    )
    
    
    do=NA
    do=ifelse(
      !is.na(e1$do_actor_b) & e1$event_number_int_condition %in% 0,
      glue_rex("[{|e1$do_actor_a|}]{.underline text.color='black'} 
                initiated 
                [{|e1$leaf_do_original|}]{.underline text.color='black'}
                toward 
                [{|e1$do_actor_b|}]{.underline text.color='black'}." ) ,
      do
    )
    #in a way that was [{|ifelse(e1$do_aggression=='more aggression','escalatory/uncooperative ', 'de-escalatory/cooperative')|}]{.underline text.color='black'}
    do=ifelse(
      is.na(e1$do_actor_b) & e1$event_number_int_condition %in% 0,
      glue_rex("[{|e1$do_actor_a|}]{.underline text.color='black'} 
                initiated 
                [{|e1$leaf_do_original|}]{.underline text.color='black'}." ) ,
      do
    )
    
    do=ifelse(
      !is.na(e1$do_actor_b) & e1$event_number_int_condition %in% 1,
      glue_rex("(Condition) [{|e1$do_actor_a|}]{.underline text.color='black'} 
                initiated
                [{|e1$leaf_do_original|}]{.underline text.color='black'} [{|e1$do_actor_b|}]{.underline text.color='black'}.") ,
      do
    )
    do=ifelse(
      is.na(e1$do_actor_b) & e1$event_number_int_condition %in% 1,
      glue_rex("(Condition) [{|e1$do_actor_a|}]{.underline text.color='black'} 
                initiated
                [{|e1$leaf_do_original|}]{.underline text.color='black'}.")  ,
      do
    )
    
    
    #There should be 6! possibilities
    is.na(leaf_say_original) & is.na(leaf_do_original) & is.na(leaf_think_original)
    
    final_coding=NA
    final_coding = ifelse(e1$behavior %>% is.na(), glue_rex("No events."), final_coding )
    final_coding = ifelse(e1$behavior %in% "think",glue_rex("{|think|}"),final_coding)
    final_coding = ifelse(e1$behavior %in% "say",glue_rex("{|say|}"),final_coding)
    final_coding = ifelse(e1$behavior %in% "do;think",glue_rex("{|think|} {|do|}"),final_coding)
    
    final_coding = ifelse(e1$behavior %in% "say;think",glue_rex("{|think|} {|say|}"),final_coding)
    final_coding = ifelse(e1$behavior %in% "do;say;think",glue_rex("{|think|} {|say|} {|do|}"),final_coding)
    
    final_coding = ifelse(e1$behavior %in% "do",glue_rex("{|do|}"),final_coding)
    final_coding = ifelse(e1$behavior %in% "do;say",glue_rex("{|say|} {|do|}"),final_coding)
    final_coding = ifelse(e1$behavior %in% "do;say" & !is.na(consequence),glue_rex("{|say|} {|consequence|} {|do|}"),final_coding)
    final_coding = ifelse(e1$behavior %in% "do;say" & !is.na(consequence) & !is.na(condition),glue_rex("{|say|} {|consequence|} {|do|} {|condition|}"),final_coding)
  
    if(length(final_coding)>0){
     df_temp$text[j] <- final_coding
    } else {next}
    #print(df_temp)
  }
  #print(df_temp)
  df_collapsed <- df_temp %>% mutate(text=text %>% as.character() )  %>% na.omit() %>% dplyr::select(text) %>% summarise(events=text %>% paste( collapse="\n"))
  df_collapsed$sentence <- sentence
  df_collapsed <- df_collapsed %>% dplyr::select(sentence, events)
  return(df_collapsed)
}

#df_final <- NA
#keep_crisis=447
#keep_sentence=14
#events <- codings_wide_agreed_embeded  %>% dplyr::filter(crisno==keep_crisis & sentence_number_int_aligned==keep_sentence )  #%>% janitor::remove_empty()  #don't remove empties or it'll destroy comparisons
#asdfasdf <- event_to_sentence_rex(events1)

#asdfasdf %>%
#  dplyr::select(-type) %>%
#  na.omit() %>%
#  as_flextable() %>%
#  colformat_md() %>% 
#  width(width = 8)

event_lists <- list()
cases <- codings_wide_agreed_embeded_stratified_sample %>% ungroup() %>% dplyr::select(crisno,sentence_number_int_aligned) %>% distinct()
for(i in 1:nrow(cases)){
    print(i)
    events <- NULL
    events <- codings_wide_agreed_embeded_stratified_sample %>% filter(crisno==cases[i,]$crisno & sentence_number_int_aligned==cases[i,]$sentence_number_int_aligned)
    event_lists[[as.character(i)]] <- event_to_sentence_rex(events)
    event_lists[[as.character(i)]]$ID=paste0(cases[i,]$crisno,'.',sentence_number_int_aligned=cases[i,]$sentence_number_int_aligned)
}

events_df <- bind_rows(event_lists) %>%
  filter(!events %in% "No events.")
events_ft <- events_df %>%
              dplyr::select(ID, sentence, events)  %>%
              #dplyr::select(-type) %>%
              na.omit() %>%
              as_flextable() %>%
              colformat_md() %>% 
              flextable::fontsize(size = 7, part = "all") %>%
              flextable::bg( i = which( 1:nrow(events_df) %% 2 == 1)  , j=1:ncol(events_df), part = "body", bg = "#EFEFEF") %>%
              flextable::width(j = 1, width=0.3, unit = "in") %>%
              flextable::width(j = 2, width=3, unit = "in") %>%
              flextable::width(j = 3, width=3, unit = "in") 

events_ft  %>% saveRDS(paste0(here::here(), "ICBEdataset/paper/tables/events_ft.Rds"))
events_ft

```



